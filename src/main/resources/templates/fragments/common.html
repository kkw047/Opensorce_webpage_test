<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<body>
<header class="topbar" th:fragment="topbar">
    <a th:href="@{/clubs}" class="logo"><img th:src="@{/image/Yeoul.png}" alt="Yeoul"></a>
    <div class="actions">
          <span th:if="${session.LOGIN_USER_NICKNAME != null}" style="color: var(--text-main); font-weight: 600; margin-right: 10px;">
            ì•ˆë…•í•˜ì„¸ìš”,   <a th:href="@{/profile}" class="topbar-nickname" title="í”„ë¡œí•„ ì„¤ì •ìœ¼ë¡œ ì´ë™"> <span class="topbar-nickname-text" th:text="${session.LOGIN_USER_NICKNAME}">ë‹‰</span></a> ë‹˜!
          </span>
        <button class="btn" id="openLoginBtn" th:if="${session.LOGIN_USER_NICKNAME == null}">ë¡œê·¸ì¸</button>
        <button class="btn primary" id="openRegisterBtn" th:if="${session.LOGIN_USER_NICKNAME == null}">íšŒì›ê°€ì…</button>
        <form th:if="${session.LOGIN_USER_NICKNAME != null}" th:action="@{/logout}" method="post" style="display:inline">
            <button class="btn">ë¡œê·¸ì•„ì›ƒ</button>
        </form>
    </div>
</header>

<aside class="sidebar" th:fragment="sidebar">
    <nav class="menu-vert">
        <a class="menu-item" th:classappend="${activeSidebarMenu == 'main' ? 'active' : ''}" th:href="@{/clubs}">ë©”ì¸</a>
        <a class="menu-item"
           th:href="@{/recommend}"
           th:classappend="${activeSidebarMenu == 'recommend' ? 'active' : ''}">
            ì¶”ì²œ
        </a>

        <a th:href="@{/my-calendar}"
           th:classappend="${activeSidebarMenu == 'calendar'} ? 'active'"
           class="menu-item">
            <span>ìº˜ë¦°ë”</span>
        </a>
        <a class="menu-item" th:href="@{/clubs/myclubs}" th:classappend="${activeSidebarMenu == 'myclubs' ? 'active' : ''}">ë‚´ëª¨ì„</a>
    </nav>

    <div th:if="${!#lists.isEmpty(myClubs)}" style="margin-top: 10px; margin-bottom: 10px;">
        <div style="font-size: 12px; font-weight: bold; color: var(--text-muted); padding: 0 12px; margin-bottom: 8px;">
            ë‚´ ëª¨ì„ ë°”ë¡œê°€ê¸°
        </div>
        <nav class="menu-vert">
            <a th:each="c : ${myClubs}"
               class="menu-item"
               th:href="@{/clubs/{id}(id=${c.id})}"
               th:text="${c.name}"
               th:classappend="${club != null and club.id == c.id} ? 'active' : ''"
               style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                ëª¨ì„ ì´ë¦„
            </a>
        </nav>
        <hr style="border: 0; border-top: 1px solid var(--border); margin: 12px 0;">
    </div>

    <section class="card soft">
        <h4 class="card-title" style="color: var(--text-main);">ì¹´í…Œê³ ë¦¬</h4>
        <form id="categoryFilterForm" method="get" th:action="${searchActionUrl}">
            <input type="hidden" name="q" th:value="${q}">
            <input type="hidden" name="do" th:value="${selectedDo}">
            <input type="hidden" name="si" th:value="${selectedSi}">

            <div class="checklist scroll-y">
                <label th:each="c : ${categories}" class="checkrow">
                    <input type="checkbox" name="categoryIds"
                           th:value="${c.id}"
                           th:checked="${#lists.contains(selectedCategoryIds, c.id)}">
                    <span th:text="${c.name}">ì¹´í…Œê³ ë¦¬</span>
                </label>
            </div>
            <button class="btn block mt8">í•„í„° ì ìš©</button>
        </form>
    </section>

    <button class="btn primary block mt12"
            id="openCreatePanelBtn"
            style="padding: 12px; font-size: 1rem;"
            th:attr="data-logged-in=${session.LOGIN_USER_ID != null} ? 'true' : 'false'">
        ëª¨ì„ ë§Œë“¤ê¸°
    </button>
</aside>

<form class="toolbar" th:fragment="searchbar" method="get" th:action="${searchActionUrl}">
    <div style="min-width: 100px;">
        <div class="label">ë„(ê´‘ì—­)</div>
        <select id="searchDo" name="do">
            <option value="">ì „ì²´</option>
            <option th:each="d : ${dos}"
                    th:text="${d}"
                    th:value="${d}"
                    th:selected="${d == selectedDo}">ì¶©ë¶</option>
        </select>
    </div>
    <div style="min-width: 100px;">
        <div class="label">ì‹œ/êµ°/êµ¬</div>
        <select id="searchSi" name="si">
            <option value="">ì „ì²´</option>
        </select>
    </div>
    <div class="flex1">
        <div class="label">í‚¤ì›Œë“œ</div>
        <input type="text" name="q" th:value="${q}" placeholder="ëª¨ì„ ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰">
    </div>
    <div th:if="${selectedCategoryIds != null}">
        <input type="hidden" name="categoryIds"
               th:each="cid : ${selectedCategoryIds}"
               th:value="${cid}">
    </div>
    <button class="btn primary" style="height: 42px; margin-top: 24px;">ê²€ìƒ‰</button>
</form>

<form class="toolbar" th:fragment="searchbar" method="get" th:action="${searchActionUrl}">
</form>

<div class="tab-menu-container" th:fragment="club-tabs" th:object="${club}"
     style="display: flex; justify-content: space-between; align-items: center;">
    <nav class="tab-menu">
        <a class="btn"
           th:classappend="${activeTab == 'home' ? 'primary' : ''}"
           th:href="@{/clubs/{id}(id=${club.id})}">í™ˆ</a>

        <a class="btn"
           th:classappend="${activeTab == 'board' ? 'primary' : ''}"
           th:href="@{/clubs/{id}/board(id=${club.id})}">ê²Œì‹œíŒ</a>

        <a class="btn"
           th:classappend="${activeTab == 'chat' ? 'primary' : ''}"
           th:href="@{/clubs/{id}/chat(id=${club.id})}">ì±„íŒ…</a>

        <a class="btn"
           th:classappend="${activeTab == 'calendar' ? 'primary' : ''}"
           th:href="@{/clubs/{id}/calendar(id=${club.id})}">ìº˜ë¦°ë”</a>
    </nav>

    <div th:if="${club.isManager}">
        <a class="btn"
           th:classappend="${activeTab == 'manager' ? 'primary' : ''}"
           th:href="@{/clubs/{id}/manager(id=${club.id})}">ê´€ë¦¬</a>
    </div>

</div>

<div th:fragment="modals">
    <div class="modal" id="loginModal" hidden>
        <div class="modal-card">
            <h3 style="margin-top: 0; text-align: center;">ë¡œê·¸ì¸</h3>
            <form class="form-grid" th:action="@{/login}" method="post" style="display: flex; flex-direction: column; gap: 10px;">
                <input type="text" name="loginIdOrEmail" placeholder="ì•„ì´ë”” ë˜ëŠ” ì´ë©”ì¼" required>
                <input type="password" name="password" placeholder="ë¹„ë°€ë²ˆí˜¸" required>
                <div style="display:flex; gap:8px; margin-top:6px;">
                    <button class="btn primary block flex1">ë¡œê·¸ì¸</button>
                    <button class="btn block flex1" type="button" data-close="#loginModal">ë‹«ê¸°</button>
                </div>
            </form>
        </div>
        <div id="toast-container">
            <div id="toast-message">ì•Œë¦¼ ë‚´ìš©</div>
        </div>
    </div>

    <div class="modal" id="registerModal" hidden>
        <div class="modal-card" style="width: 480px;">
            <h3 style="margin-top: 0; text-align: center;">íšŒì›ê°€ì…</h3>
            <form class="form-grid" th:action="@{/register}" method="post" style="display: flex; flex-direction: column; gap: 12px;">
                <div>
                    <div class="label" style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">ì•„ì´ë””</div>
                    <div style="display:flex; gap:8px; align-items:center;">
                        <input type="text"
                               name="loginId"
                               id="regLoginIdModal"
                               placeholder="ì•„ì´ë””"
                               style="flex:1;">
                        <button type="button"
                                class="btn"
                                id="btnCheckLoginIdModal"
                                style="white-space:nowrap; flex-shrink:0;">
                            ì¤‘ë³µí™•ì¸
                        </button>
                    </div>
                    <small id="loginIdHelpModal" class="muted"></small>
                </div>

                <div>
                    <div class="label" style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">ì´ë©”ì¼</div>
                    <input type="email"
                           name="email"
                           id="regEmailModal"
                           placeholder="ì´ë©”ì¼"
                           required>

                    <div style="display:flex; gap:8px; margin-top:6px;">
                        <input type="text"
                               id="regEmailCodeModal"
                               placeholder="ì¸ì¦ì½”ë“œ ì…ë ¥"
                               style="flex:1;">
                        <button type="button"
                                class="btn"
                                id="btnSendEmailCodeModal">ì¸ì¦ì½”ë“œ ë³´ë‚´ê¸°</button>
                        <button type="button"
                                class="btn"
                                id="btnVerifyEmailCodeModal">í™•ì¸</button>
                    </div>

                    <small id="emailHelpModal" class="muted"></small>

                    <input type="hidden" id="emailVerifiedModal" value="false">
                </div>

                <input type="password" name="password" placeholder="ë¹„ë°€ë²ˆí˜¸" required>
                <input type="text" name="nickname" placeholder="ë‹‰ë„¤ì„" required>

                <div class="row-2" style="display:flex; gap:8px; margin-top:6px;">
                    <select id="regDo" name="regionDo" required><option value="">ë„ ì„ íƒ</option></select>
                    <select id="regSi" name="regionSi" required><option value="">ì‹œ/êµ°/êµ¬</option></select>
                </div>

                <div class="label mt8" style="font-size: 12px; color: var(--text-muted);">ì„ í˜¸ ì¹´í…Œê³ ë¦¬</div>
                <div class="checklist scroll-y" style="max-height: 150px;">
                    <label th:each="c : ${categories}" class="checkrow">
                        <input type="checkbox" name="categoryIds" th:value="${c.id}">
                        <span th:text="${c.name}">ì¹´í…Œê³ ë¦¬</span>
                    </label>
                </div>

                <div style="display:flex; gap:8px; margin-top:10px;">
                    <button class="btn primary block flex1">ê°€ì…</button>
                    <button class="btn block flex1" type="button" data-close="#registerModal">ë‹«ê¸°</button>
                </div>
            </form>
        </div>
    </div>

    <div class="overlay" id="createOverlay" hidden>
        <div class="overlay-backdrop" id="createBackdrop"></div>
        <aside class="create-panel">
            <div class="panel-head">
                <h3 style="margin: 0;">ëª¨ì„ ë§Œë“¤ê¸°</h3>
                <button class="iconbtn" id="closeCreatePanelBtn">âœ•</button>
            </div>
            <form id="createForm" th:action="@{/clubs}" method="post" enctype="multipart/form-data" class="panel-body">
                <div class="row-2">
                    <label>
                        <div class="label">ë„ ì„ íƒ</div>
                        <select id="createDo" name="regionDo" required>
                            <option value="">ë„ ì„ íƒ</option>
                        </select>
                    </label>
                    <label>
                        <div class="label">ì‹œ/êµ°/êµ¬</div>
                        <select id="createSi" name="regionSi" required>
                            <option value="">ì‹œ/êµ°/êµ¬</option>
                        </select>
                    </label>
                </div>
                <div class="preview" id="imagePreview">
                    <span style="font-size: 12px; color: var(--text-muted);">ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°</span>
                </div>
                <label class="filebtn">
                    <input type="file" name="imageFile" id="imageFile" accept="image/*" hidden>
                    <span>ğŸ“ íŒŒì¼ ì„ íƒ</span>
                </label>
                <input type="text" name="name" placeholder="ëª¨ì„ ì´ë¦„" required style="font-weight: bold;">
                <textarea name="description" placeholder="í™ë³´/ì†Œê°œ ë¬¸êµ¬" rows="4"></textarea>
                <div class="label" style="margin-bottom: 4px; color: var(--text-muted);">ì¹´í…Œê³ ë¦¬</div>
                <div class="checklist tall scroll-y">
                    <label th:each="c : ${categories}" class="checkrow">
                        <input type="checkbox" name="categoryIds" th:value="${c.id}">
                        <span th:text="${c.name}">ì¹´í…Œê³ ë¦¬</span>
                    </label>
                </div>
                <div class="row-2">
                    <input id="newCategoryInput" type="text" placeholder="+ ìƒˆ ì¹´í…Œê³ ë¦¬(ì˜ˆ: ëŸ¬ë‹)">
                    <button class="btn" type="button" id="addCategoryBtn">ì¶”ê°€</button>
                </div>
                <div id="newCategoryChips" class="chips"></div>
                <div id="newCategoryHidden"></div>
                <button class="btn primary block mt12" type="submit" style="padding: 12px;">ìƒì„±</button>
            </form>
        </aside>
    </div>
</div>

<div th:fragment="scripts">
    <script defer th:src="@{/js/region.js}"></script>
    <script defer th:src="@{/js/main.js}"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const body = document.querySelector('body');
            const msg = body.getAttribute('data-msg');
            const error = body.getAttribute('data-error');

            if (msg) {
                showToast(msg, false);
            }
            if (error) {
                showToast(error, true);
            }
        });

        function showToast(message, isError) {
            const container = document.getElementById('toast-container');
            // í† ìŠ¤íŠ¸ ë©”ì‹œì§€ ë°•ìŠ¤ê°€ ì—†ìœ¼ë©´ ìƒì„± (ê¸°ì¡´ js ë¡œì§ ë³´ì™„)
            let msgBox = document.getElementById('toast-message');

            if (!container) return;

            if (!msgBox) {
                msgBox = document.createElement('div');
                msgBox.id = 'toast-message';
                container.appendChild(msgBox);
            }

            msgBox.textContent = message;

            if (isError) {
                container.classList.add('error');
            } else {
                container.classList.remove('error');
            }

            container.classList.add('show');

            setTimeout(function() {
                container.classList.remove('show');
            }, 3000);
        }
    </script>
</div>

</body>
</html>
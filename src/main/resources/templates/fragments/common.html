<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<body>

<header class="topbar" th:fragment="topbar">
    <div class="logo">TEAM11</div>
    <div class="actions">
          <span th:if="${session.LOGIN_USER_NICKNAME != null}">
            안녕하세요, <b th:text="${session.LOGIN_USER_NICKNAME}">닉</b>님!
          </span>
        <button class="btn" id="openLoginBtn" th:if="${session.LOGIN_USER_NICKNAME == null}">로그인</button>
        <button class="btn" id="openRegisterBtn" th:if="${session.LOGIN_USER_NICKNAME == null}">회원가입</button>
        <form th:if="${session.LOGIN_USER_NICKNAME != null}" th:action="@{/logout}" method="post" style="display:inline">
            <button class="btn">로그아웃</button>
        </form>
    </div>
</header>

<aside class="sidebar" th:fragment="sidebar">
    <nav class="menu-vert">
        <a class="menu-item" th:classappend="${activeSidebarMenu == 'main' ? 'active' : ''}" th:href="@{/clubs}">메인</a>
        <a class="menu-item" title="준비중">추천</a>
        <a class="menu-item" title="준비중">캘린더</a>
        <a class="menu-item" th:href="@{/clubs/myclubs}" th:classappend="${activeSidebarMenu == 'myclubs' ? 'active' : ''}">내모임</a>
    </nav>

    <section class="card soft">
        <h4 class="card-title">카테고리</h4>
        <form id="categoryFilterForm" method="get" th:action="${searchActionUrl}">
            <input type="hidden" name="q" th:value="${q}">
            <input type="hidden" name="do" th:value="${selectedDo}">
            <input type="hidden" name="si" th:value="${selectedSi}">

            <div class="checklist scroll-y">
                <label th:each="c : ${categories}" class="checkrow">
                    <input type="checkbox" name="categoryIds"
                           th:value="${c.id}"
                           th:checked="${#lists.contains(selectedCategoryIds, c.id)}">
                    <span th:text="${c.name}">카테고리</span>
                </label>
            </div>
            <button class="btn block mt8">필터 적용</button>
        </form>
    </section>

    <button class="btn primary block mt12"
            id="openCreatePanelBtn"
            th:attr="data-logged-in=${session.LOGIN_USER_ID != null} ? 'true' : 'false'">
        모임 만들기
    </button>
</aside>

<form class="toolbar" th:fragment="searchbar" method="get" th:action="${searchActionUrl}">
    <div>
        <div class="label">도(광역)</div>
        <select id="searchDo" name="do">
            <option value="">전체</option>
            <option th:each="d : ${dos}"
                    th:text="${d}"
                    th:value="${d}"
                    th:selected="${d == selectedDo}">충북</option>
        </select>
    </div>
    <div>
        <div class="label">시/군/구</div>
        <select id="searchSi" name="si">
            <option value="">전체</option>
        </select>
    </div>
    <div class="flex1">
        <div class="label">키워드</div>
        <input type="text" name="q" th:value="${q}" placeholder="모임 이름으로 검색">
    </div>
    <div th:if="${selectedCategoryIds != null}">
        <input type="hidden" name="categoryIds"
               th:each="cid : ${selectedCategoryIds}"
               th:value="${cid}">
    </div>
    <button class="btn">검색</button>
</form>

<form class="toolbar" th:fragment="searchbar" method="get" th:action="${searchActionUrl}">
</form>

<div class="tab-menu-container" th:fragment="club-tabs" th:object="${club}">
    <nav class="tab-menu">
        <a class="btn" th:classappend="${activeTab == 'home' ? 'primary' : ''}" th:href="@{/clubs/{id}(id=${club.id})}">홈</a>
        <a class="btn" th:classappend="${activeTab == 'board' ? 'primary' : ''}" th:href="@{/clubs/{id}/board(id=${club.id})}">게시판</a>
        <a class="btn" th:classappend="${activeTab == 'chat' ? 'primary' : ''}" th:href="@{/clubs/{id}/chat(id=${club.id})}">채팅</a>
        <a class="btn" th:classappend="${activeTab == 'calendar' ? 'primary' : ''}" th:href="@{/clubs/{id}/calendar(id=${club.id})}">캘린더</a>
        <a class="btn" th:if="${club.isManager}" th:classappend="${activeTab == 'manager' ? 'primary' : ''}" th:href="@{/clubs/{id}/manager(id=${club.id})}">관리</a>
    </nav>
</div>

<div th:fragment="modals">
    <div class="modal" id="loginModal" hidden>
        <div class="modal-card">
            <h3>로그인</h3>
            <form class="form-grid" th:action="@{/login}" method="post">
                <input type="text" name="loginIdOrEmail" placeholder="아이디 또는 이메일" required>
                <div style="display:flex; gap:8px; margin-top:6px;">
                <input type="password" name="password" placeholder="비밀번호" required>
                </div>
                <div style="display:flex; gap:8px; margin-top:6px;">
                <button class="btn primary">로그인</button>
                <button class="btn" type="button" data-close="#loginModal">닫기</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="registerModal" hidden>
        <div class="modal-card">
            <h3>회원가입</h3>
            <form class="form-grid" th:action="@{/register}" method="post">
                <div>
                    <div class="label">아이디</div>
                    <div style="display:flex; gap:8px; align-items:center;">
                        <input type="text"
                               name="loginId"
                               id="regLoginIdModal"
                               placeholder="아이디"
                               style="flex:1;">
                        <button type="button"
                                class="btn"
                                id="btnCheckLoginIdModal"
                                style="white-space:nowrap; flex-shrink:0;">
                            중복확인
                        </button>
                    </div>
                    <small id="loginIdHelpModal" class="muted"></small>
                </div>

                <div>
                    <div class="label">이메일</div>
                    <input type="email"
                           name="email"
                           id="regEmailModal"
                           placeholder="이메일"
                           required>

                    <div style="display:flex; gap:8px; margin-top:6px;">
                        <input type="text"
                               id="regEmailCodeModal"
                               placeholder="인증코드 입력"
                               style="flex:1;">
                        <button type="button"
                                class="btn"
                                id="btnSendEmailCodeModal">인증코드 보내기</button>
                        <button type="button"
                                class="btn"
                                id="btnVerifyEmailCodeModal">확인</button>
                    </div>

                    <small id="emailHelpModal" class="muted"></small>

                    <input type="hidden" id="emailVerifiedModal" value="false">
                </div>
                <div style="display:flex; gap:8px; margin-top:6px;">
                <input type="password" name="password" placeholder="비밀번호" required>
                </div>

                <div style="display:flex; gap:8px; margin-top:6px;">
                <input type="text" name="nickname" placeholder="닉네임" required>
                </div>

                <div class="row-2" style="display:flex; gap:8px; margin-top:6px;">
                    <select id="regDo" name="regionDo" required><option value="">도 선택</option></select>
                    <select id="regSi" name="regionSi" required><option value="">시/군/구</option></select>
                </div>
                <div class="label mt8">선호 카테고리</div>
                <div class="checklist scroll-y">
                    <label th:each="c : ${categories}" class="checkrow">
                        <input type="checkbox" name="categoryIds" th:value="${c.id}">
                        <span th:text="${c.name}">카테고리</span>
                    </label>
                </div>
                <button class="btn primary">가입</button>
                <button class="btn" type="button" data-close="#registerModal">닫기</button>
            </form>
        </div>
    </div>

    <div class="overlay" id="createOverlay" hidden>
        <div class="overlay-backdrop" id="createBackdrop"></div>
        <aside class="create-panel">
            <div class="panel-head">
                <h3>모임 만들기</h3>
                <button class="iconbtn" id="closeCreatePanelBtn">✕</button>
            </div>
            <form id="createForm" th:action="@{/clubs}" method="post" enctype="multipart/form-data" class="panel-body">
                <div class="row-2">
                    <label>
                        <div class="label">도 선택</div>
                        <select id="createDo" name="regionDo" required>
                            <option value="">도 선택</option>
                        </select>
                    </label>
                    <label>
                        <div class="label">시/군/구</div>
                        <select id="createSi" name="regionSi" required>
                            <option value="">시/군/구</option>
                        </select>
                    </label>
                </div>
                <div class="preview" id="imagePreview">이미지 미리보기</div>
                <label class="filebtn">
                    <input type="file" name="imageFile" id="imageFile" accept="image/*" hidden>
                    <span>📁 파일 선택</span>
                </label>
                <input type="text" name="name" placeholder="모임 이름" required>
                <textarea name="description" placeholder="홍보/소개 문구" rows="4"></textarea>
                <div class="label">카테고리</div>
                <div class="checklist tall scroll-y">
                    <label th:each="c : ${categories}" class="checkrow">
                        <input type="checkbox" name="categoryIds" th:value="${c.id}">
                        <span th:text="${c.name}">카테고리</span>
                    </label>
                </div>
                <div class="row-2">
                    <input id="newCategoryInput" type="text" placeholder="+ 새 카테고리(예: 러닝)">
                    <button class="btn" type="button" id="addCategoryBtn">추가</button>
                </div>
                <div id="newCategoryChips" class="chips"></div>
                <div id="newCategoryHidden"></div>
                <button class="btn primary block mt12" type="submit">생성</button>
            </form>
        </aside>
    </div>
</div>

<div th:fragment="scripts">
    <script defer th:src="@{/js/region.js}"></script>
    <script defer th:src="@{/js/main.js}"></script>
</div>

</body>
</html>

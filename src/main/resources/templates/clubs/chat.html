<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title th:text="${club.name}">채팅</title>
    <link rel="stylesheet" th:href="@{/css/app.css}">
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        .detail-card { border: 1px solid #1a332c; border-radius: 14px; background: #0f231e; padding: 16px; margin-bottom: 16px; }
        .toolbar-right { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;}

        /* --- 채팅방 목록 그리드 --- */
        .chat-room-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
        }

        .chat-room-item {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: stretch;
            background: #071b15;
            border: 1px solid #153328;
            border-radius: 10px;
            padding: 12px;
            transition: background 0.15s ease;
            min-height: 100px;
            position: relative;
        }
        .chat-room-item:hover { background: #12352b; }

        .chat-room-item .room-link {
            text-decoration: none;
            color: #e7f3ee;
            flex: 1;
            cursor: pointer;
            display: flex;
            flex-direction: column;
        }

        .chat-room-item .room-link-disabled {
            text-decoration: none;
            color: #9ec8b8;
            flex: 1;
            cursor: default;
            display: flex;
            flex-direction: column;
        }

        .chat-room-item h4 { margin: 0 0 8px 0; }
        .chat-room-item .members { font-size: 12px; color: #9ec8b8; margin-top: auto; }

        /* 목록 내 버튼 위치 (가입 버튼 등) */
        .chat-room-item .action-btn-area {
            position: absolute;
            top: 12px;
            right: 12px;
            margin: 0;
        }

        /* --- 채팅 모달 스타일 --- */
        .chat-modal-overlay {
            position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); z-index: 100; display: none; pointer-events: none;
        }
        .chat-modal-content {
            background: #0f231e; border: 1px solid #1a332c; border-radius: 14px;
            width: 500px; height: 600px; display: flex; flex-direction: column;
            resize: both; overflow: auto; min-width: 350px; min-height: 300px;
            pointer-events: auto; position: absolute; left: 50%; top: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }
        .chat-modal-header {
            padding: 12px 16px; border-bottom: 1px solid #1a332c;
            display: flex; justify-content: space-between; align-items: center; cursor: move;
            background: #0c1f1a; border-radius: 14px 14px 0 0;
        }
        .chat-modal-header h4 { margin: 0; font-size: 16px; color: #fff; }
        .chat-modal-header .actions { display: flex; gap: 8px; }

        .chat-modal-body { flex: 1; padding: 12px; overflow-y: auto; background: #071b15; }
        .chat-modal-footer { padding: 12px; border-top: 1px solid #1a332c; background: #0c1f1a; border-radius: 0 0 14px 14px; }

        .chat-modal-body .msg-item { margin-bottom: 10px; }
        .chat-modal-body .msg-sender { font-weight: 600; font-size: 14px; margin-bottom: 2px; }
        .chat-modal-body .msg-content {
            background: #12352b; padding: 8px 12px; border-radius: 10px;
            display: inline-block; max-width: 80%; word-wrap: break-word;
        }
        .chat-modal-body .msg-time { font-size: 10px; color: #9ec8b8; margin-left: 8px; }
        .chat-modal-body .msg-item.mine { text-align: right; }
        .chat-modal-body .msg-item.mine .msg-content { background: #1db954; color: #04120e; }

        .chat-input-form { display: flex; gap: 8px; }
        .chat-input-form input { flex: 1; }

        .chat-modal-manage-view {
            flex: 1; padding: 12px; overflow-y: auto; background: #071b15;
            display: flex; flex-direction: column; gap: 16px;
        }
        .chat-modal-manage-view h4 { margin: 0 0 12px 0; }
        .chat-modal-manage-view .member-list { display: flex; flex-direction: column; gap: 10px; }
        .chat-modal-manage-view .member-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 8px 12px; background: #0f231e; border: 1px solid #153328; border-radius: 8px;
        }
        .chat-modal-manage-view .member-item form { margin: 0; }
        .chat-modal-manage-view .btn-kick {
            background: #5a2a2a; border-color: #7a3a3a; color: #fee; font-size: 12px; padding: 6px 10px;
        }
        .chat-modal-manage-view .btn-unban {
            background: #2a4a5a; border-color: #3a6a7a; color: #eef; font-size: 12px; padding: 6px 10px;
        }

        .chat-modal-manage-view .invite-section { border-top: 1px solid #1a332c; padding-top: 16px; }
        .chat-modal-manage-view .invite-list {
            background: #071b15; border-radius: 10px; border: 1px solid #153328;
            padding: 6px 8px; max-height: 150px; overflow-y: auto; margin-bottom: 12px;
        }

        .chat-modal-manage-view .delete-section {
            margin-top: auto; padding-top: 16px; border-top: 1px solid #1a332c;
        }
        .chat-modal-manage-view .delete-section p { color: #c8b89e; font-size: 14px; margin-top: 0; }
        .btn-danger { background: #a02c2c; border-color: #a02c2c; color: #fff; }
        .btn-danger:hover { background: #c0392b; border-color: #c0392b; }

        /* 커스텀 알림 모달 (중앙 정렬) */
        .custom-confirm-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 2000;
        }
        .custom-confirm-content {
            min-width: 300px; max-width: 400px; background: #0f231e; padding: 20px;
            border-radius: 14px; border: 1px solid #4a635d; box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            text-align: center;
        }
        .custom-confirm-msg { color: #e7f3ee; margin-bottom: 20px; white-space: pre-wrap; line-height: 1.5; }
        .custom-confirm-actions { display: flex; justify-content: center; gap: 10px; }
    </style>
</head>
<body class="bg-deep">

<header class="topbar" th:replace="~{fragments/common :: topbar}"></header>

<div class="wrap">
    <aside class="sidebar" th:replace="~{fragments/common :: sidebar}"></aside>
    <main class="content">

        <div class="detail-card">
            <div th:replace="~{fragments/common :: club-tabs}"></div>
        </div>

        <div id="toast"
             th:if="${error != null or msg != null}"
             th:text="${error ?: msg}"
             class="toast show"
             th:classappend="${error != null} ? 'toast-error' : 'toast-success'">
        </div>

        <div class="detail-card">
            <div class="toolbar-right">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <h2 style="margin: 0;">채팅방 목록</h2>
                    <label class="checkrow" style="padding: 0; font-size: 14px; cursor: pointer;">
                        <input type="checkbox" id="myChatsFilter" />
                        <span style="cursor: pointer;">내 채팅방만 보기</span>
                    </label>
                </div>
                <a th:href="@{/clubs/{id}/chat/create(id=${club.id})}" class="btn primary">채팅방 만들기</a>
            </div>

            <div class="chat-room-list">
                <div th:each="room : ${chatRooms}" class="chat-room-item" th:data-is-member="${room.isMember}">

                    <div class="room-link"
                         th:data-club-id="${club.id}"
                         th:data-room-id="${room.id}"
                         th:if="${room.isMember}">
                        <h4 th:text="${room.name}">채팅방 이름</h4>
                        <div class="members">
                            <span class="member-count" th:text="${'멤버 ' + room.memberCount + '명'}">멤버 N명</span>
                            <span th:if="${room.ownerNickname != null}"
                                  th:text="'(방장: ' + ${room.ownerNickname} + ')'"></span>
                        </div>
                    </div>

                    <div class="room-link-disabled" th:if="${!room.isMember}">
                        <h4 th:text="${room.name}">채팅방 이름</h4>
                        <div class="members">
                            <span class="member-count" th:text="${'멤버 ' + room.memberCount + '명'}">멤버 N명</span>
                            <span th:if="${room.ownerNickname != null}"
                                  th:text="'(방장: ' + ${room.ownerNickname} + ')'"></span>
                        </div>
                    </div>

                    <div class="action-btn-area">
                        <form th:if="${!room.isMember}"
                              th:action="@{/clubs/{id}/chat/{roomId}/join(id=${club.id}, roomId=${room.id})}"
                              method="post" style="margin:0;">
                            <button type="submit" class="btn primary">가입</button>
                        </form>
                    </div>
                </div>

                <div th:if="${#lists.isEmpty(chatRooms)}" style="color: #9ec8b8; text-align: center; padding: 20px 0;">
                    아직 개설된 채팅방이 없습니다.
                </div>
            </div>
        </div>
    </main>
</div>

<div class="chat-modal-overlay" id="chatModal" style="display: none;">
    <div class="chat-modal-content" data-club-id="" data-room-id="">
        <div class="chat-modal-header">
            <h4 id="modalRoomName">채팅방 이름</h4>
            <div class="actions">
                <button class="btn" id="modalManageLink" style="display: none;">방 관리</button>
                <button class="btn btn-danger" id="modalLeaveBtn" style="display: none;">나가기</button>

                <button class="btn" id="modalCloseBtn">닫기</button>
            </div>
        </div>

        <div id="modalChatView" style="display: flex; flex-direction: column; flex: 1; overflow: hidden;">
            <div class="chat-modal-body" id="modalMessages"></div>
            <div class="chat-modal-footer">
                <form class="chat-input-form" id="modalSendForm" method="post">
                    <input type="text" name="content" placeholder="메시지 입력..." autocomplete="off" required>
                    <button class="btn primary">전송</button>
                </form>
            </div>
        </div>

        <div class="chat-modal-manage-view" id="modalManageView" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0;">
                <h3 style="margin: 0;">방 관리</h3>
                <button class="btn" id="modalBackToChatBtn">채팅으로</button>
            </div>

            <div>
                <h4>멤버 관리</h4>
                <div class="member-list" id="modalManageMemberList"></div>
            </div>

            <div style="border-top: 1px solid #1a332c; padding-top: 16px;">
                <h4>밴 목록 (해제 가능)</h4>
                <div class="member-list" id="modalBannedMemberList"></div>
            </div>

            <div class="invite-section">
                <h4>멤버 초대</h4>
                <form id="modalInviteForm" method="post" action="">
                    <div class="invite-list checklist scroll-y" id="modalInviteList"></div>
                    <button type="submit" class="btn primary block">선택한 멤버 초대하기</button>
                </form>
            </div>

            <div class="delete-section">
                <h4>방 삭제</h4>
                <p>채팅방을 삭제하면 모든 대화 내역이 영구적으로 사라집니다.</p>
                <form id="modalDeleteRoomForm" method="post" action="">
                    <button type="submit" class="btn btn-danger">이 채팅방 삭제하기</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="custom-confirm-overlay" id="customConfirmModal">
    <div class="custom-confirm-content">
        <h3 style="color: #fff; margin-bottom: 10px;">알림</h3>
        <div class="custom-confirm-msg" id="confirmMessage">내용</div>
        <div class="custom-confirm-actions">
            <button class="btn" id="btnConfirmCancel">취소</button>
            <button class="btn primary" id="btnConfirmOk">확인</button>
        </div>
    </div>
</div>

<div th:replace="~{fragments/common :: modals}"></div>
<div th:replace="~{fragments/common :: scripts}"></div>

<script th:inline="javascript">
    const currentNickname = /*[[${session.LOGIN_USER_NICKNAME}]]*/ null;
    const currentUserId = /*[[${session.LOGIN_USER_ID}]]*/ null;
    let stompClient = null;
    let currentRoomId = null;

    // [커스텀] 브라우저 Confirm 대신 사용할 비동기 함수
    function openConfirm(message) {
        return new Promise((resolve) => {
            const modal = document.getElementById('customConfirmModal');
            const msgEl = document.getElementById('confirmMessage');
            const btnOk = document.getElementById('btnConfirmOk');
            const btnCancel = document.getElementById('btnConfirmCancel');

            msgEl.textContent = message;
            modal.style.display = 'flex';

            // 기존 리스너 중복 방지를 위해 노드 복제 후 교체
            const newOk = btnOk.cloneNode(true);
            const newCancel = btnCancel.cloneNode(true);
            btnOk.parentNode.replaceChild(newOk, btnOk);
            btnCancel.parentNode.replaceChild(newCancel, btnCancel);

            newOk.addEventListener('click', () => {
                modal.style.display = 'none';
                resolve(true);
            });
            newCancel.addEventListener('click', () => {
                modal.style.display = 'none';
                resolve(false);
            });
        });
    }

    function makeDraggable(element, handle) {
        let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
        handle.onmousedown = dragMouseDown;
        function dragMouseDown(e) {
            e = e || window.event;
            e.preventDefault();
            if (element.style.transform !== 'none') {
                const rect = element.getBoundingClientRect();
                element.style.left = rect.left + "px";
                element.style.top = rect.top + "px";
                element.style.transform = 'none';
            }
            pos3 = e.clientX; pos4 = e.clientY;
            document.onmouseup = closeDragElement;
            document.onmousemove = elementDrag;
        }
        function elementDrag(e) {
            e = e || window.event; e.preventDefault();
            pos1 = pos3 - e.clientX; pos2 = pos4 - e.clientY;
            pos3 = e.clientX; pos4 = e.clientY;
            element.style.top = (element.offsetTop - pos2) + "px";
            element.style.left = (element.offsetLeft - pos1) + "px";
        }
        function closeDragElement() { document.onmouseup = null; document.onmousemove = null; }
    }

    document.addEventListener("DOMContentLoaded", () => {
        const chatModalOverlay = document.getElementById("chatModal");
        const chatModalContent = chatModalOverlay.querySelector(".chat-modal-content");
        const chatModalHeader = chatModalOverlay.querySelector(".chat-modal-header");
        if (!chatModalOverlay || !chatModalContent || !chatModalHeader) return;

        makeDraggable(chatModalContent, chatModalHeader);

        const modalRoomName = document.getElementById("modalRoomName");
        const modalMessages = document.getElementById("modalMessages");
        const modalSendForm = document.getElementById("modalSendForm");
        const modalCloseBtn = document.getElementById("modalCloseBtn");

        const modalManageLink = document.getElementById("modalManageLink");
        const modalLeaveBtn = document.getElementById("modalLeaveBtn");

        const modalChatView = document.getElementById('modalChatView');
        const modalManageView = document.getElementById('modalManageView');
        const modalBackToChatBtn = document.getElementById('modalBackToChatBtn');

        // 관리 탭 관련 요소
        const modalManageMemberList = document.getElementById('modalManageMemberList');
        const modalBannedMemberList = document.getElementById('modalBannedMemberList');
        const modalInviteList = document.getElementById('modalInviteList');
        const modalInviteForm = document.getElementById('modalInviteForm');
        const modalDeleteRoomForm = document.getElementById('modalDeleteRoomForm');

        function scrollToBottom() {
            if(modalMessages) modalMessages.scrollTop = modalMessages.scrollHeight;
        }

        function appendMessage(msg) {
            const isMine = msg.senderNickname === currentNickname;
            const itemDiv = document.createElement("div");
            itemDiv.className = `msg-item ${isMine ? 'mine' : ''}`;
            let senderHtml = '';
            if (!isMine) senderHtml = `<div class="msg-sender">${msg.senderNickname || '(알 수 없음)'}</div>`;
            const contentSpan = document.createElement('span');
            contentSpan.textContent = msg.content;
            const timeSpan = document.createElement('span');
            timeSpan.className = 'msg-time';
            timeSpan.textContent = msg.sentAt;
            const contentDiv = document.createElement('div');
            contentDiv.className = 'msg-content';
            contentDiv.appendChild(contentSpan);
            contentDiv.appendChild(timeSpan);
            itemDiv.innerHTML = senderHtml;
            itemDiv.appendChild(contentDiv);
            modalMessages.appendChild(itemDiv);
        }

        async function openChatModal(clubId, roomId) {
            if (stompClient && currentRoomId === roomId) {
                chatModalOverlay.style.display = 'flex'; return;
            }
            if (stompClient) {
                stompClient.disconnect(() => console.log('Disconnected'));
                stompClient = null;
            }
            currentRoomId = roomId;
            modalChatView.style.display = 'flex';
            modalManageView.style.display = 'none';
            chatModalOverlay.style.display = 'flex';

            // 모달 중앙 정렬
            chatModalContent.style.left = '50%'; chatModalContent.style.top = '50%';
            chatModalContent.style.transform = 'translate(-50%, -50%)';

            modalRoomName.textContent = '연결 중...';
            modalMessages.innerHTML = '<p>채팅방에 연결 중입니다...</p>';

            modalManageLink.style.display = 'none';
            modalLeaveBtn.style.display = 'none';

            chatModalContent.dataset.clubId = clubId;
            chatModalContent.dataset.roomId = roomId;

            try {
                const infoResponse = await fetch(`/api/clubs/${clubId}/chat/${roomId}`);
                if (!infoResponse.ok) {
                    const errorText = await infoResponse.text();
                    throw new Error(errorText || "채팅방 입장에 실패했습니다.");
                }
                const data = await infoResponse.json();
                modalRoomName.textContent = data.roomName;

                // 방장/일반인에 따라 버튼 토글
                if (data.roomOwnerId && data.roomOwnerId === currentUserId) {
                    modalManageLink.style.display = 'inline-block';
                    modalLeaveBtn.style.display = 'none';
                } else {
                    modalManageLink.style.display = 'none';
                    modalLeaveBtn.style.display = 'inline-block';
                }

                modalSendForm.dataset.roomId = roomId;

                const socket = new SockJS('/ws');
                stompClient = Stomp.over(socket);
                stompClient.debug = null;
                stompClient.connect({}, (frame) => {
                    modalMessages.innerHTML = '<p>대화 내역을 불러오는 중입니다...</p>';
                    stompClient.subscribe('/topic/chat/' + roomId, (message) => {
                        appendMessage(JSON.parse(message.body));
                        scrollToBottom();
                    });
                    fetchInitialMessages(clubId, roomId);
                }, (error) => {
                    console.error('STOMP error: ' + error);
                    showToast("채팅 서버 연결 실패", "error");
                });
            } catch (err) {
                showToast("오류: " + err.message, "error");
                chatModalOverlay.style.display = 'none';
                currentRoomId = null;
            }
        }

        async function fetchInitialMessages(clubId, roomId) {
            try {
                const msgResponse = await fetch(`/api/clubs/${clubId}/chat/${roomId}/messages`);
                if (!msgResponse.ok) throw new Error("메시지 로딩 실패");
                const messages = await msgResponse.json();
                modalMessages.innerHTML = '';
                messages.forEach(appendMessage);
                scrollToBottom();
                modalSendForm.querySelector('input[name="content"]').focus();
            } catch (err) {
                modalMessages.innerHTML = `<p style="color:#f88;">${err.message}</p>`;
            }
        }

        modalCloseBtn.addEventListener("click", () => {
            chatModalOverlay.style.display = 'none';
            if (stompClient !== null) {
                stompClient.disconnect(); stompClient = null; currentRoomId = null;
            }
        });

        document.querySelectorAll(".chat-room-list .room-link").forEach(link => {
            link.addEventListener("click", (e) => {
                e.preventDefault();
                openChatModal(link.dataset.clubId, link.dataset.roomId);
            });
        });

        modalSendForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const input = e.target.querySelector('input[name="content"]');
            const content = input.value.trim();
            const roomId = e.target.dataset.roomId;
            if (!content || !stompClient || !roomId) return;
            stompClient.send("/app/chat/" + roomId + "/send", {}, JSON.stringify({ 'content': content }));
            e.target.reset(); input.focus();
        });

        // === [관리 기능] ===

        // DB에서 실시간 인원수를 가져와 배경 목록 업데이트
        async function refreshRoomListInfo(clubId, roomId) {
            try {
                const res = await fetch(`/api/clubs/${clubId}/chat/${roomId}`);
                if (res.ok) {
                    const data = await res.json();
                    // data.memberCount (DTO에 추가된 필드)를 사용하여 업데이트
                    const roomLinkInList = document.querySelector(`.room-link[data-room-id="${roomId}"]`);
                    if (roomLinkInList) {
                        const countSpan = roomLinkInList.querySelector('.members .member-count');
                        if (countSpan) {
                            countSpan.textContent = `멤버 ${data.memberCount}명`;
                        }
                    }
                }
            } catch (e) {
                console.error("방 정보 갱신 실패", e);
            }
        }

        // 나가기 (일반 멤버)
        modalLeaveBtn.addEventListener("click", async () => {
            const clubId = chatModalContent.dataset.clubId;
            const roomId = chatModalContent.dataset.roomId;
            if (!clubId || !roomId) return;

            if (await openConfirm('정말 이 채팅방을 나가시겠습니까?')) {
                try {
                    const res = await fetch(`/api/clubs/${clubId}/chat/${roomId}/leave`, { method: 'POST' });
                    if(res.ok) {
                        showToast("채팅방을 나갔습니다.", "success");
                        location.reload();
                    } else {
                        showToast(await res.text(), "error");
                    }
                } catch(err) {
                    showToast("오류: " + err.message, "error");
                }
            }
        });

        // 관리 탭 새로고침
        async function refreshManagementTab(clubId, roomId) {
            modalManageMemberList.innerHTML = '<p>로딩 중...</p>'; modalBannedMemberList.innerHTML = '<p>로딩 중...</p>'; modalInviteList.innerHTML = '<p>로딩 중...</p>';
            modalInviteForm.action = `/api/clubs/${clubId}/chat/${roomId}/invite`;

            try {
                const res = await fetch(`/api/clubs/${clubId}/chat/${roomId}/manage`);
                const members = await res.json();
                modalManageMemberList.innerHTML = '';
                if (members.length === 0) modalManageMemberList.innerHTML = '<p style="color:#9ec8b8;">멤버 없음</p>';
                else {
                    members.forEach(m => {
                        const div = document.createElement('div'); div.className = 'member-item';

                        // 관리자일 경우 버튼 영역 비우고, 이름 옆에 [관리자] 배지 추가
                        let btnHtml = '';
                        let badgeHtml = '';

                        if (m.role === 'MANAGER') {
                            // 관리자: 버튼 없음, 초록색 관리자 텍스트 추가
                            btnHtml = '';
                            badgeHtml = ` <span style="color: #2ecc71; font-size: 12px; font-weight: bold; margin-left: 4px;">[관리자]</span>`;
                        } else {
                            // 일반 멤버: 강퇴 버튼 생성
                            btnHtml = `<button class="btn btn-kick" data-id="${m.id}">강퇴</button>`;
                        }

                        div.innerHTML = `
                            <div>
                                <span>${m.nickname}</span>
                                <span style="font-size:12px;color:#9ec8b8;">(${m.email})</span>${badgeHtml}
                            </div>
                            ${btnHtml}
                        `;
                        modalManageMemberList.appendChild(div);
                    });
                    // 버튼 이벤트 리스너 연결 (btn-kick이 존재하는 경우만)
                    modalManageMemberList.querySelectorAll('.btn-kick').forEach(btn => {
                        btn.onclick = () => handleKick(clubId, roomId, btn.dataset.id);
                    });
                }
            } catch (e) { modalManageMemberList.innerHTML = '오류'; }

            try {
                const res = await fetch(`/api/clubs/${clubId}/chat/${roomId}/banned-members`);
                const banned = await res.json();
                modalBannedMemberList.innerHTML = '';
                if (banned.length === 0) modalBannedMemberList.innerHTML = '<p style="color:#9ec8b8;">밴 된 멤버 없음</p>';
                else {
                    banned.forEach(m => {
                        const div = document.createElement('div'); div.className = 'member-item';
                        div.innerHTML = `<div><span style="color:#ff7777">${m.nickname}</span> <span style="font-size:12px;color:#9ec8b8;">(${m.email})</span></div><button class="btn btn-unban" data-id="${m.id}">해제</button>`;
                        modalBannedMemberList.appendChild(div);
                    });
                    modalBannedMemberList.querySelectorAll('.btn-unban').forEach(btn => { btn.onclick = () => handleUnban(clubId, roomId, btn.dataset.id); });
                }
            } catch(e) { modalBannedMemberList.innerHTML = '오류'; }

            try {
                const res = await fetch(`/api/clubs/${clubId}/chat/${roomId}/invitable-members`);
                const members = await res.json();
                modalInviteList.innerHTML = '';
                if(members.length === 0) modalInviteList.innerHTML = '<p style="color:#9ec8b8;">초대 가능 멤버 없음</p>';
                else {
                    members.forEach(m => {
                        const label = document.createElement('label'); label.className = 'checkrow';
                        label.innerHTML = `<input type="checkbox" name="memberIds" value="${m.id}"><span>${m.nickname}</span> <span style="font-size:12px;color:#9ec8b8;">(${m.email})</span>`;
                        modalInviteList.appendChild(label);
                    });
                }
            } catch(e) { modalInviteList.innerHTML = '오류'; }
            modalDeleteRoomForm.action = `/api/clubs/${clubId}/chat/${roomId}/delete`;
        }

        // 강퇴 처리
        async function handleKick(clubId, roomId, userId) {
            if(await openConfirm('이 멤버를 강퇴하시겠습니까?\n(강퇴 시 밴 처리되어 재가입이 불가능합니다.)')) {
                try {
                    const fd = new FormData(); fd.append('memberId', userId);
                    const res = await fetch(`/api/clubs/${clubId}/chat/${roomId}/kick`, { method: 'POST', body: fd });
                    if(res.ok) {
                        showToast("멤버를 강퇴했습니다.", "success");
                        refreshManagementTab(clubId, roomId);
                        // DB에서 최신 인원수 반영
                        refreshRoomListInfo(clubId, roomId);
                    } else {
                        showToast(await res.text(), "error");
                    }
                } catch(e) { showToast(e.message, "error"); }
            }
        }

        // 밴 해제 처리
        async function handleUnban(clubId, roomId, userId) {
            if(await openConfirm('밴을 해제하시겠습니까?')) {
                try {
                    const fd = new FormData(); fd.append('memberId', userId);
                    const res = await fetch(`/api/clubs/${clubId}/chat/${roomId}/unban`, { method: 'POST', body: fd });
                    if(res.ok) {
                        showToast("밴이 해제되었습니다.", "success");
                        refreshManagementTab(clubId, roomId);
                    } else {
                        showToast(await res.text(), "error");
                    }
                } catch(e) { showToast(e.message, "error"); }
            }
        }

        modalManageLink.addEventListener("click", (e) => {
            e.preventDefault();
            const clubId = chatModalContent.dataset.clubId;
            const roomId = chatModalContent.dataset.roomId;
            modalChatView.style.display = 'none';
            modalManageView.style.display = 'flex';
            refreshManagementTab(clubId, roomId);
        });

        modalBackToChatBtn.addEventListener("click", () => {
            modalManageView.style.display = 'none';
            modalChatView.style.display = 'flex';
        });

        modalInviteForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const clubId = chatModalContent.dataset.clubId;
            const roomId = chatModalContent.dataset.roomId;
            const formData = new FormData(e.target);
            if (!formData.has('memberIds')) return showToast("멤버를 선택하세요.", "error");

            try {
                const res = await fetch(e.target.action, { method: 'POST', body: formData });
                if(res.ok) {
                    const count = await res.json(); // 추가된 인원수
                    showToast(`${count}명 초대 완료`, "success");
                    refreshManagementTab(clubId, roomId);
                    // DB에서 최신 인원수 반영
                    refreshRoomListInfo(clubId, roomId);
                } else {
                    showToast(await res.text(), "error");
                }
            } catch(e) { showToast(e.message, "error"); }
        });

        modalDeleteRoomForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            if (await openConfirm('정말 삭제하시겠습니까?')) {
                try {
                    const res = await fetch(e.target.action, { method: 'POST' });
                    if(res.ok) {
                        showToast("채팅방 삭제 완료", "success");
                        location.reload();
                    } else {
                        showToast(await res.text(), "error");
                    }
                } catch(e) { showToast(e.message, "error"); }
            }
        });

        // 초기 로드
        const urlParams = new URLSearchParams(window.location.search);
        const roomToOpen = urlParams.get('openRoom');
        const clubIdMeta = /*[[${club.id}]]*/ null;
        if (roomToOpen && clubIdMeta) {
            window.history.replaceState({}, document.title, window.location.pathname);
            openChatModal(clubIdMeta, roomToOpen);
        }

        // 필터링 로직
        const filterCheckbox = document.getElementById('myChatsFilter');
        const roomListContainer = document.querySelector('.chat-room-list');
        if (filterCheckbox && roomListContainer) {
            filterCheckbox.addEventListener('change', () => {
                const showOnlyMyChats = filterCheckbox.checked;
                roomListContainer.querySelectorAll('.chat-room-item').forEach(item => {
                    const isMember = item.dataset.isMember === 'true';
                    if (showOnlyMyChats) {
                        if(isMember) item.removeAttribute('hidden');
                        else item.setAttribute('hidden', 'hidden');
                    } else {
                        item.removeAttribute('hidden');
                    }
                });
            });
        }
    });
</script>

</body>
</html>
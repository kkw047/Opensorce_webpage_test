<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title th:text="${club.name}">채팅</title>
    <link rel="stylesheet" th:href="@{/css/app.css}">
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        /* 채팅 목록 페이지 전용 스타일 */
        .toolbar-right {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;
        }
        .chat-room-list {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;
        }
        .chat-room-item {
            display: flex; flex-direction: column; justify-content: space-between; align-items: stretch;
            background: #ffffff; border: 1px solid var(--border); border-radius: 12px;
            padding: 20px; transition: background 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
            min-height: 140px; position: relative;
            box-shadow: 0 2px 8px rgba(0,0,0,0.02);
        }
        .chat-room-item:hover {
            background: var(--bg-hover); transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); border-color: var(--primary);
        }
        .chat-room-item .room-link, .chat-room-item .room-link-disabled {
            text-decoration: none; color: var(--text-main); flex: 1; display: flex; flex-direction: column; cursor: pointer;
        }
        .chat-room-item .room-link-disabled { cursor: default; color: var(--text-muted); }
        .chat-room-item h4 { margin: 0 0 8px 0; font-size: 1.1rem; font-weight: 700; color: var(--text-main); }
        .chat-room-item .members { font-size: 0.85rem; color: var(--text-muted); margin-top: auto; }
        .action-btn-area { position: absolute; top: 20px; right: 20px; }

        /* 채팅 모달 스타일 (최적화 적용) */
        .chat-modal-overlay {
            position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); z-index: 100;
            display: none; align-items: center; justify-content: center;
            /* 버벅임 방지: backdrop-filter 제거 혹은 최소화. 여기서는 제거함 */
            /* backdrop-filter: blur(2px); */
        }
        .chat-modal-content {
            background: #ffffff; border: 1px solid var(--border); border-radius: 16px;
            width: 500px; height: 650px; display: flex; flex-direction: column;
            box-shadow: 0 15px 40px rgba(0,0,0,0.2);
            position: absolute; /* JS 드래그용 */
            color: var(--text-main);

            /* [최적화] 레이어 분리하여 렌더링 성능 향상 */
            will-change: top, left, width, height;
            transform: translate3d(0, 0, 0);

            /* [기능 추가] 크기 조절 가능 */
            resize: both;
            overflow: hidden; /* resize 핸들이 보이려면 overflow가 visible이 아니어야 함 */
            min-width: 350px;
            min-height: 400px;
            max-width: 95vw;
            max-height: 95vh;
        }
        .chat-modal-header {
            padding: 16px 20px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            background: var(--bg-body); cursor: move;
            flex-shrink: 0; /* 헤더 크기 고정 */
        }
        .chat-modal-header h4 { margin: 0; font-size: 1.1rem; color: var(--text-main); font-weight: 700; }
        .chat-modal-body {
            flex: 1; padding: 20px; overflow-y: auto; background: #fcfdfd;
            display: flex; flex-direction: column; gap: 10px;
            overscroll-behavior: contain; /* 스크롤 체이닝 방지 */
        }
        .chat-modal-footer {
            padding: 15px; border-top: 1px solid var(--border); background: #ffffff;
            flex-shrink: 0; /* 푸터 크기 고정 */
        }

        .msg-item { display: flex; flex-direction: column; max-width: 75%; margin-bottom: 5px; }
        .msg-sender { font-size: 0.8rem; color: var(--text-muted); margin-left: 4px; margin-bottom: 4px; font-weight: 600; }
        .msg-content {
            background: #f0f0f0; padding: 10px 14px; border-radius: 16px; border-top-left-radius: 2px;
            display: inline-block; word-wrap: break-word; color: #333; font-size: 0.95rem;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .msg-time { font-size: 0.7rem; color: #aaa; margin-left: 6px; margin-top: 2px; }

        .msg-item.mine { align-self: flex-end; align-items: flex-end; text-align: right; }
        .msg-item.mine .msg-content {
            background: var(--primary); color: #fff; border-top-left-radius: 16px; border-top-right-radius: 2px;
        }

        .chat-input-form { display: flex; gap: 10px; }

        /* 관리 뷰 */
        .chat-modal-manage-view {
            flex: 1; padding: 20px; overflow-y: auto; background: var(--bg-body);
            display: flex; flex-direction: column; gap: 20px;
        }
        .member-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px; background: #ffffff; border: 1px solid var(--border);
            border-radius: 10px; margin-bottom: 8px;
        }
        .invite-list {
            background: #ffffff; border: 1px solid var(--border); border-radius: 10px;
            padding: 10px; max-height: 200px; overflow-y: auto;
        }
        .delete-section {
            margin-top: auto; padding-top: 20px; border-top: 1px solid var(--border);
        }

        /* 커스텀 알림창 */
        .custom-confirm-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); z-index: 2000; display: none;
            align-items: center; justify-content: center;
        }
        .custom-confirm-content {
            width: 350px; background: #ffffff; padding: 25px; border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: center; color: var(--text-main);
        }
    </style>
</head>
<body class="bg-deep">

<header class="topbar" th:replace="~{fragments/common :: topbar}"></header>

<div class="wrap">
    <aside class="sidebar" th:replace="~{fragments/common :: sidebar}"></aside>
    <main class="content">

        <div class="detail-card">
            <div th:replace="~{fragments/common :: club-tabs}"></div>
        </div>

        <div id="toast"
             th:if="${error != null or msg != null}"
             th:text="${error ?: msg}"
             class="toast show"
             th:classappend="${error != null} ? 'toast-error' : 'toast-success'">
        </div>

        <div class="detail-card">
            <div class="toolbar-right">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <h2 style="margin: 0; font-weight: 700; color: var(--text-main);">채팅방 목록</h2>
                    <label class="checkrow" style="padding: 0; background: transparent; color: var(--text-main);">
                        <input type="checkbox" id="myChatsFilter" />
                        <span style="cursor: pointer; font-size: 0.9rem;">내 채팅방만 보기</span>
                    </label>
                </div>
                <a th:href="@{/clubs/{id}/chat/create(id=${club.id})}" class="btn primary">채팅방 만들기</a>
            </div>

            <div class="chat-room-list">
                <div th:each="room : ${chatRooms}" class="chat-room-item" th:data-is-member="${room.isMember}">

                    <div class="room-link"
                         th:data-club-id="${club.id}"
                         th:data-room-id="${room.id}"
                         th:if="${room.isMember}">
                        <h4 th:text="${room.name}">채팅방 이름</h4>
                        <div class="members">
                            <span class="member-count" th:text="${'멤버 ' + room.memberCount + '명'}">멤버 N명</span>
                            <span th:if="${room.ownerNickname != null}"
                                  th:text="'(방장: ' + ${room.ownerNickname} + ')'"></span>
                        </div>
                    </div>

                    <div class="room-link-disabled" th:if="${!room.isMember}">
                        <h4 th:text="${room.name}">채팅방 이름</h4>
                        <div class="members">
                            <span class="member-count" th:text="${'멤버 ' + room.memberCount + '명'}">멤버 N명</span>
                            <span th:if="${room.ownerNickname != null}"
                                  th:text="'(방장: ' + ${room.ownerNickname} + ')'"></span>
                        </div>
                    </div>

                    <div class="action-btn-area">
                        <form th:if="${!room.isMember}"
                              th:action="@{/clubs/{id}/chat/{roomId}/join(id=${club.id}, roomId=${room.id})}"
                              method="post" style="margin:0;">
                            <button type="submit" class="btn primary">가입</button>
                        </form>
                    </div>
                </div>

                <div th:if="${#lists.isEmpty(chatRooms)}" style="color: var(--text-muted); text-align: center; padding: 40px 0;">
                    <p>아직 개설된 채팅방이 없습니다.</p>
                </div>
            </div>
        </div>
    </main>
</div>

<div class="chat-modal-overlay" id="chatModal">
    <div class="chat-modal-content" data-club-id="" data-room-id="">
        <div class="chat-modal-header">
            <h4 id="modalRoomName">채팅방 이름</h4>
            <div class="actions">
                <button class="btn" id="modalManageLink" style="display: none;">방 관리</button>
                <button class="btn btn-danger" id="modalLeaveBtn" style="display: none;">나가기</button>
                <button class="btn" id="modalCloseBtn">닫기</button>
            </div>
        </div>

        <div id="modalChatView" style="display: flex; flex-direction: column; flex: 1; overflow: hidden;">
            <div class="chat-modal-body" id="modalMessages"></div>
            <div class="chat-modal-footer">
                <form class="chat-input-form" id="modalSendForm" method="post" style="width:100%;">
                    <input type="text" name="content" placeholder="메시지를 입력하세요..." autocomplete="off" required>
                    <button class="btn primary">전송</button>
                </form>
            </div>
        </div>

        <div class="chat-modal-manage-view" id="modalManageView" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; font-size: 1.1rem;">방 관리</h3>
                <button class="btn" id="modalBackToChatBtn">채팅으로</button>
            </div>

            <div>
                <h4 style="margin-bottom: 10px;">멤버 관리</h4>
                <div class="member-list" id="modalManageMemberList"></div>
            </div>

            <div style="border-top: 1px solid var(--border); padding-top: 20px;">
                <h4 style="margin-bottom: 10px;">밴 목록 (해제 가능)</h4>
                <div class="member-list" id="modalBannedMemberList"></div>
            </div>

            <div class="invite-section" style="border-top: 1px solid var(--border); padding-top: 20px;">
                <h4 style="margin-bottom: 10px;">멤버 초대</h4>
                <form id="modalInviteForm" method="post" action="">
                    <div class="invite-list checklist scroll-y" id="modalInviteList"></div>
                    <button type="submit" class="btn primary block" style="margin-top: 10px;">선택한 멤버 초대하기</button>
                </form>
            </div>

            <div class="delete-section">
                <h4 style="color: var(--danger);">방 삭제</h4>
                <p>채팅방을 삭제하면 모든 대화 내역이 영구적으로 사라집니다.</p>
                <form id="modalDeleteRoomForm" method="post" action="">
                    <button type="submit" class="btn btn-danger block">이 채팅방 삭제하기</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="custom-confirm-overlay" id="customConfirmModal">
    <div class="custom-confirm-content">
        <h3 style="margin-top: 0; margin-bottom: 15px; color: var(--text-main);">알림</h3>
        <div class="custom-confirm-msg" id="confirmMessage" style="color: var(--text-muted); margin-bottom: 25px;">내용</div>
        <div class="custom-confirm-actions" style="display: flex; justify-content: center; gap: 10px;">
            <button class="btn" id="btnConfirmCancel" style="min-width: 80px;">취소</button>
            <button class="btn primary" id="btnConfirmOk" style="min-width: 80px;">확인</button>
        </div>
    </div>
</div>

<div th:replace="~{fragments/common :: modals}"></div>
<div th:replace="~{fragments/common :: scripts}"></div>

<script th:inline="javascript">
    // ... (기존 JS 로직 유지) ...
    const currentNickname = /*[[${session.LOGIN_USER_NICKNAME}]]*/ null;
    const currentUserId = /*[[${session.LOGIN_USER_ID}]]*/ null;
    let stompClient = null;
    let currentRoomId = null;

    function openConfirm(message) {
        return new Promise((resolve) => {
            const modal = document.getElementById('customConfirmModal');
            const msgEl = document.getElementById('confirmMessage');
            const btnOk = document.getElementById('btnConfirmOk');
            const btnCancel = document.getElementById('btnConfirmCancel');

            msgEl.textContent = message;
            modal.style.display = 'flex';

            const newOk = btnOk.cloneNode(true);
            const newCancel = btnCancel.cloneNode(true);
            btnOk.parentNode.replaceChild(newOk, btnOk);
            btnCancel.parentNode.replaceChild(newCancel, btnCancel);

            newOk.addEventListener('click', () => {
                modal.style.display = 'none';
                resolve(true);
            });
            newCancel.addEventListener('click', () => {
                modal.style.display = 'none';
                resolve(false);
            });
        });
    }

    // [최적화] 드래그 기능: requestAnimationFrame 적용
    function makeDraggable(element, handle) {
        let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
        let isDragging = false;
        let rafId = null;

        handle.onmousedown = dragMouseDown;

        function dragMouseDown(e) {
            e = e || window.event;
            // resize 핸들러 클릭 시 드래그 방지 (우측 하단 15px 영역)
            const rect = element.getBoundingClientRect();
            if (e.clientX > rect.right - 20 && e.clientY > rect.bottom - 20) {
                return; // 리사이즈 동작에 양보
            }

            e.preventDefault();

            // transform이 아닌 top/left를 사용하기 위해 초기값 세팅
            // (이미 중앙 정렬된 상태라면 computedStyle을 가져와서 top/left로 변환해야 부드러움)
            if (element.style.transform && element.style.transform !== 'none') {
                // 현재 위치 고정
                element.style.left = rect.left + "px";
                element.style.top = rect.top + "px";
                element.style.transform = 'none'; // 중앙 정렬 해제
            }

            pos3 = e.clientX;
            pos4 = e.clientY;
            document.onmouseup = closeDragElement;
            document.onmousemove = elementDrag;
            isDragging = true;
        }

        function elementDrag(e) {
            if (!isDragging) return;
            e = e || window.event;
            e.preventDefault();

            // 최적화: requestAnimationFrame 사용
            if (rafId) return;

            rafId = requestAnimationFrame(() => {
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;

                element.style.top = (element.offsetTop - pos2) + "px";
                element.style.left = (element.offsetLeft - pos1) + "px";
                rafId = null;
            });
        }

        function closeDragElement() {
            isDragging = false;
            if (rafId) {
                cancelAnimationFrame(rafId);
                rafId = null;
            }
            document.onmouseup = null;
            document.onmousemove = null;
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        const chatModalOverlay = document.getElementById("chatModal");
        const chatModalContent = chatModalOverlay.querySelector(".chat-modal-content");
        const chatModalHeader = chatModalOverlay.querySelector(".chat-modal-header");
        if (!chatModalOverlay || !chatModalContent || !chatModalHeader) return;

        makeDraggable(chatModalContent, chatModalHeader);
        // ... (나머지 이벤트 리스너들) ...
        const modalRoomName = document.getElementById("modalRoomName");
        const modalMessages = document.getElementById("modalMessages");
        const modalSendForm = document.getElementById("modalSendForm");
        const modalCloseBtn = document.getElementById("modalCloseBtn");

        const modalManageLink = document.getElementById("modalManageLink");
        const modalLeaveBtn = document.getElementById("modalLeaveBtn");

        const modalChatView = document.getElementById('modalChatView');
        const modalManageView = document.getElementById('modalManageView');
        const modalBackToChatBtn = document.getElementById('modalBackToChatBtn');

        const modalManageMemberList = document.getElementById('modalManageMemberList');
        const modalBannedMemberList = document.getElementById('modalBannedMemberList');
        const modalInviteList = document.getElementById('modalInviteList');
        const modalInviteForm = document.getElementById('modalInviteForm');
        const modalDeleteRoomForm = document.getElementById('modalDeleteRoomForm');

        function scrollToBottom() {
            if(modalMessages) modalMessages.scrollTop = modalMessages.scrollHeight;
        }

        function appendMessage(msg) {
            const isMine = msg.senderNickname === currentNickname;
            const itemDiv = document.createElement("div");
            itemDiv.className = `msg-item ${isMine ? 'mine' : ''}`;
            let senderHtml = '';
            if (!isMine) senderHtml = `<div class="msg-sender">${msg.senderNickname || '(알 수 없음)'}</div>`;
            const contentSpan = document.createElement('span');
            contentSpan.textContent = msg.content;
            const timeSpan = document.createElement('span');
            timeSpan.className = 'msg-time';
            timeSpan.textContent = msg.sentAt;
            const contentDiv = document.createElement('div');
            contentDiv.className = 'msg-content';
            contentDiv.appendChild(contentSpan);
            contentDiv.appendChild(timeSpan);
            itemDiv.innerHTML = senderHtml;
            itemDiv.appendChild(contentDiv);
            modalMessages.appendChild(itemDiv);
        }

        async function openChatModal(clubId, roomId) {
            if (stompClient && currentRoomId === roomId) {
                chatModalOverlay.style.display = 'flex'; return;
            }
            if (stompClient) {
                stompClient.disconnect(() => console.log('Disconnected'));
                stompClient = null;
            }
            currentRoomId = roomId;
            modalChatView.style.display = 'flex';
            modalManageView.style.display = 'none';
            chatModalOverlay.style.display = 'flex';

            // 모달 중앙 정렬 초기화 (JS로 위치 잡기)
            // 처음 열릴 때만 중앙, 이후 드래그/리사이즈 된 위치 유지하려면 이 부분 조정 필요
            // 여기서는 매번 열 때마다 중앙으로 리셋 (사용성 고려)
            chatModalContent.style.left = '50%';
            chatModalContent.style.top = '50%';
            chatModalContent.style.transform = 'translate(-50%, -50%)';

            // 크기도 초기화하고 싶다면 아래 주석 해제
            // chatModalContent.style.width = '500px';
            // chatModalContent.style.height = '650px';

            modalRoomName.textContent = '연결 중...';
            modalMessages.innerHTML = '<p style="color:var(--text-muted); text-align:center;">채팅방에 연결 중입니다...</p>';

            modalManageLink.style.display = 'none';
            modalLeaveBtn.style.display = 'none';

            chatModalContent.dataset.clubId = clubId;
            chatModalContent.dataset.roomId = roomId;

            try {
                const infoResponse = await fetch(`/api/clubs/${clubId}/chat/${roomId}`);
                if (!infoResponse.ok) {
                    const errorText = await infoResponse.text();
                    throw new Error(errorText || "채팅방 입장에 실패했습니다.");
                }
                const data = await infoResponse.json();
                modalRoomName.textContent = data.roomName;

                // 방장/일반인에 따라 버튼 토글
                if (data.roomOwnerId && data.roomOwnerId === currentUserId) {
                    modalManageLink.style.display = 'inline-block';
                    modalLeaveBtn.style.display = 'none';
                } else {
                    modalManageLink.style.display = 'none';
                    modalLeaveBtn.style.display = 'inline-block';
                }

                modalSendForm.dataset.roomId = roomId;

                const socket = new SockJS('/ws');
                stompClient = Stomp.over(socket);
                stompClient.debug = null;
                stompClient.connect({}, (frame) => {
                    modalMessages.innerHTML = '';
                    stompClient.subscribe('/topic/chat/' + roomId, (message) => {
                        appendMessage(JSON.parse(message.body));
                        scrollToBottom();
                    });
                    fetchInitialMessages(clubId, roomId);
                }, (error) => {
                    console.error('STOMP error: ' + error);
                    showToast("채팅 서버 연결 실패", "error");
                });
            } catch (err) {
                showToast("오류: " + err.message, "error");
                chatModalOverlay.style.display = 'none';
                currentRoomId = null;
            }
        }

        async function fetchInitialMessages(clubId, roomId) {
            try {
                const msgResponse = await fetch(`/api/clubs/${clubId}/chat/${roomId}/messages`);
                if (!msgResponse.ok) throw new Error("메시지 로딩 실패");
                const messages = await msgResponse.json();
                modalMessages.innerHTML = '';
                messages.forEach(appendMessage);
                scrollToBottom();
                modalSendForm.querySelector('input[name="content"]').focus();
            } catch (err) {
                modalMessages.innerHTML = `<p style="color:#ff6b6b;">${err.message}</p>`;
            }
        }

        modalCloseBtn.addEventListener("click", () => {
            chatModalOverlay.style.display = 'none';
            if (stompClient !== null) {
                stompClient.disconnect(); stompClient = null; currentRoomId = null;
            }
        });

        document.querySelectorAll(".chat-room-list .room-link").forEach(link => {
            link.addEventListener("click", (e) => {
                e.preventDefault();
                openChatModal(link.dataset.clubId, link.dataset.roomId);
            });
        });

        modalSendForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const input = e.target.querySelector('input[name="content"]');
            const content = input.value.trim();
            const roomId = e.target.dataset.roomId;
            if (!content || !stompClient || !roomId) return;
            stompClient.send("/app/chat/" + roomId + "/send", {}, JSON.stringify({ 'content': content }));
            e.target.reset(); input.focus();
        });

        async function refreshRoomListInfo(clubId, roomId) {
            try {
                const res = await fetch(`/api/clubs/${clubId}/chat/${roomId}`);
                if (res.ok) {
                    const data = await res.json();
                    const roomLinkInList = document.querySelector(`.room-link[data-room-id="${roomId}"]`);
                    if (roomLinkInList) {
                        const countSpan = roomLinkInList.querySelector('.members .member-count');
                        if (countSpan) {
                            countSpan.textContent = `멤버 ${data.memberCount}명`;
                        }
                    }
                }
            } catch (e) {
                console.error("방 정보 갱신 실패", e);
            }
        }

        modalLeaveBtn.addEventListener("click", async () => {
            const clubId = chatModalContent.dataset.clubId;
            const roomId = chatModalContent.dataset.roomId;
            if (!clubId || !roomId) return;

            if (await openConfirm('정말 이 채팅방을 나가시겠습니까?')) {
                try {
                    const res = await fetch(`/api/clubs/${clubId}/chat/${roomId}/leave`, { method: 'POST' });
                    if(res.ok) {
                        showToast("채팅방을 나갔습니다.", "success");
                        location.reload();
                    } else {
                        showToast(await res.text(), "error");
                    }
                } catch(err) {
                    showToast("오류: " + err.message, "error");
                }
            }
        });

        async function refreshManagementTab(clubId, roomId) {
            modalManageMemberList.innerHTML = '<p>로딩 중...</p>'; modalBannedMemberList.innerHTML = '<p>로딩 중...</p>'; modalInviteList.innerHTML = '<p>로딩 중...</p>';
            modalInviteForm.action = `/api/clubs/${clubId}/chat/${roomId}/invite`;

            try {
                const res = await fetch(`/api/clubs/${clubId}/chat/${roomId}/manage`);
                const members = await res.json();
                modalManageMemberList.innerHTML = '';
                if (members.length === 0) modalManageMemberList.innerHTML = '<p style="color:var(--text-muted);">멤버 없음</p>';
                else {
                    members.forEach(m => {
                        const div = document.createElement('div'); div.className = 'member-item';

                        let btnHtml = '';
                        let badgeHtml = '';

                        if (m.role === 'MANAGER') {
                            btnHtml = '';
                            badgeHtml = ` <span style="color: var(--primary); font-size: 12px; font-weight: bold; margin-left: 4px;">[관리자]</span>`;
                        } else {
                            // 인라인 스타일 제거: 기본 버튼 사용
                            btnHtml = `<button class="btn btn-danger" data-id="${m.id}">강퇴</button>`;
                        }

                        div.innerHTML = `
                            <div>
                                <span>${m.nickname}</span>
                                <span style="font-size:12px;color:var(--text-muted);">(${m.email})</span>${badgeHtml}
                            </div>
                            ${btnHtml}
                        `;
                        modalManageMemberList.appendChild(div);
                    });
                    modalManageMemberList.querySelectorAll('.btn-danger').forEach(btn => {
                        btn.onclick = () => handleKick(clubId, roomId, btn.dataset.id);
                    });
                }
            } catch (e) { modalManageMemberList.innerHTML = '오류'; }

            try {
                const res = await fetch(`/api/clubs/${clubId}/chat/${roomId}/banned-members`);
                const banned = await res.json();
                modalBannedMemberList.innerHTML = '';
                if (banned.length === 0) modalBannedMemberList.innerHTML = '<p style="color:var(--text-muted);">밴 된 멤버 없음</p>';
                else {
                    banned.forEach(m => {
                        const div = document.createElement('div'); div.className = 'member-item';
                        // 인라인 스타일 제거: 기본 버튼 사용
                        div.innerHTML = `<div><span style="color:var(--danger)">${m.nickname}</span> <span style="font-size:12px;color:var(--text-muted);">(${m.email})</span></div><button class="btn" data-id="${m.id}">해제</button>`;
                        modalBannedMemberList.appendChild(div);
                    });
                    modalBannedMemberList.querySelectorAll('.btn').forEach(btn => { btn.onclick = () => handleUnban(clubId, roomId, btn.dataset.id); });
                }
            } catch(e) { modalBannedMemberList.innerHTML = '오류'; }

            try {
                const res = await fetch(`/api/clubs/${clubId}/chat/${roomId}/invitable-members`);
                const members = await res.json();
                modalInviteList.innerHTML = '';
                if(members.length === 0) modalInviteList.innerHTML = '<p style="color:var(--text-muted);">초대 가능 멤버 없음</p>';
                else {
                    members.forEach(m => {
                        const label = document.createElement('label'); label.className = 'checkrow';
                        label.innerHTML = `<input type="checkbox" name="memberIds" value="${m.id}"><span>${m.nickname}</span> <span style="font-size:12px;color:var(--text-muted);">(${m.email})</span>`;
                        modalInviteList.appendChild(label);
                    });
                }
            } catch(e) { modalInviteList.innerHTML = '오류'; }
            modalDeleteRoomForm.action = `/api/clubs/${clubId}/chat/${roomId}/delete`;
        }

        async function handleKick(clubId, roomId, userId) {
            if(await openConfirm('이 멤버를 강퇴하시겠습니까?\n(강퇴 시 밴 처리되어 재가입이 불가능합니다.)')) {
                try {
                    const fd = new FormData(); fd.append('memberId', userId);
                    const res = await fetch(`/api/clubs/${clubId}/chat/${roomId}/kick`, { method: 'POST', body: fd });
                    if(res.ok) {
                        showToast("멤버를 강퇴했습니다.", "success");
                        refreshManagementTab(clubId, roomId);
                        refreshRoomListInfo(clubId, roomId);
                    } else {
                        showToast(await res.text(), "error");
                    }
                } catch(e) { showToast(e.message, "error"); }
            }
        }

        async function handleUnban(clubId, roomId, userId) {
            if(await openConfirm('밴을 해제하시겠습니까?')) {
                try {
                    const fd = new FormData(); fd.append('memberId', userId);
                    const res = await fetch(`/api/clubs/${clubId}/chat/${roomId}/unban`, { method: 'POST', body: fd });
                    if(res.ok) {
                        showToast("밴이 해제되었습니다.", "success");
                        refreshManagementTab(clubId, roomId);
                    } else {
                        showToast(await res.text(), "error");
                    }
                } catch(e) { showToast(e.message, "error"); }
            }
        }

        modalManageLink.addEventListener("click", (e) => {
            e.preventDefault();
            const clubId = chatModalContent.dataset.clubId;
            const roomId = chatModalContent.dataset.roomId;
            modalChatView.style.display = 'none';
            modalManageView.style.display = 'flex';
            refreshManagementTab(clubId, roomId);
        });

        modalBackToChatBtn.addEventListener("click", () => {
            modalManageView.style.display = 'none';
            modalChatView.style.display = 'flex';
        });

        modalInviteForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const clubId = chatModalContent.dataset.clubId;
            const roomId = chatModalContent.dataset.roomId;
            const formData = new FormData(e.target);
            if (!formData.has('memberIds')) return showToast("멤버를 선택하세요.", "error");

            try {
                const res = await fetch(e.target.action, { method: 'POST', body: formData });
                if(res.ok) {
                    const count = await res.json(); // 추가된 인원수
                    showToast(`${count}명 초대 완료`, "success");
                    refreshManagementTab(clubId, roomId);
                    refreshRoomListInfo(clubId, roomId);
                } else {
                    showToast(await res.text(), "error");
                }
            } catch(e) { showToast(e.message, "error"); }
        });

        modalDeleteRoomForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            if (await openConfirm('정말 삭제하시겠습니까?')) {
                try {
                    const res = await fetch(e.target.action, { method: 'POST' });
                    if(res.ok) {
                        showToast("채팅방 삭제 완료", "success");
                        location.reload();
                    } else {
                        showToast(await res.text(), "error");
                    }
                } catch(e) { showToast(e.message, "error"); }
            }
        });

        const urlParams = new URLSearchParams(window.location.search);
        const roomToOpen = urlParams.get('openRoom');
        const clubIdMeta = /*[[${club.id}]]*/ null;
        if (roomToOpen && clubIdMeta) {
            window.history.replaceState({}, document.title, window.location.pathname);
            openChatModal(clubIdMeta, roomToOpen);
        }

        const filterCheckbox = document.getElementById('myChatsFilter');
        const roomListContainer = document.querySelector('.chat-room-list');
        if (filterCheckbox && roomListContainer) {
            filterCheckbox.addEventListener('change', () => {
                const showOnlyMyChats = filterCheckbox.checked;
                roomListContainer.querySelectorAll('.chat-room-item').forEach(item => {
                    const isMember = item.dataset.isMember === 'true';
                    if (showOnlyMyChats) {
                        if(isMember) item.removeAttribute('hidden');
                        else item.setAttribute('hidden', 'hidden');
                    } else {
                        item.removeAttribute('hidden');
                    }
                });
            });
        }
    });
</script>

</body>
</html>
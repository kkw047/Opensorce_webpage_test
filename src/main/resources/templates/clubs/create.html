<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>모임 만들기</title>
    <link rel="stylesheet" th:href="@{/css/app.css}">
    <script defer th:src="@{/js/main.js}"></script>
</head>
<body>
<main style="max-width:960px;margin:32px auto;padding:0 16px;">
    <h1 style="margin:0 0 14px 0;">모임 만들기 <span class="badge">Create</span></h1>
    <p class="help">모임 정보와 카테고리를 선택하고 이미지를 미리보기로 확인하세요.</p>

    <form class="card grid" th:action="@{/api/clubs}" method="post">
        <div class="grid cols-2">
            <div class="grid">
                <label class="label">모임 이름</label>
                <input class="input" type="text" name="name" placeholder="예) 청주 주말 러닝 메이트" required>
            </div>

            <div class="grid">
                <label class="label">이미지 URL</label>
                <input id="imageUrl" class="input" type="url" name="imageUrl" placeholder="https://example.com/cover.jpg">
            </div>
        </div>

        <div class="grid cols-2">
            <div class="grid">
                <label class="label">지역(도)</label>
                <select class="input" name="regionDo" required
                        th:each="d : ${dos}"
                        th:with="first=${iterStat.index == 0}">
                    <option value="" disabled selected>선택</option>
                </select>
                <select id="regionDoSelect" class="input" name="_rdo" th:remove="tag"></select>
            </div>

            <div class="grid">
                <label class="label">지역(시/군/구)</label>
                <select id="regionSiSelect" class="input" name="regionSi" required>
                    <option value="" disabled selected>도 먼저 선택</option>
                </select>
            </div>
        </div>

        <div class="grid">
            <label class="label">홍보 문구</label>
            <textarea class="input" name="description" rows="4" placeholder="간단한 소개를 적어주세요."></textarea>
        </div>

        <div class="grid">
            <label class="label">카테고리</label>
            <div id="categoryPills" class="pills">
                <label class="pill" th:each="c : ${categories}">
                    <input type="checkbox" name="categoryIds" th:value="${c.id}">
                    <span th:text="${'# ' + c.name}"># 러닝</span>
                </label>
            </div>
            <div class="grid cols-3">
                <input id="newCatName" class="input" type="text" placeholder="+ 새 카테고리 이름">
                <button id="btnAddCat" class="btn" type="button">+ 카테고리 추가</button>
                <span class="help">중복일 경우 자동으로 재사용됩니다.</span>
            </div>
        </div>

        <div class="grid cols-2">
            <div class="grid">
                <label class="label">미리보기</label>
                <img id="preview" class="avatar" alt="preview">
                <span class="help">이미지 URL을 입력하면 미리보기가 표시됩니다.</span>
            </div>
        </div>

        <div class="foot" style="text-align:right;">
            <a class="btn btn-ghost" th:href="@{/}">취소</a>
            <button class="btn btn-primary" type="submit">모임 만들기</button>
        </div>
    </form>
</main>

<script th:inline="javascript">
    // 도/시 동적 로딩
    (function(){
        const selDo = document.getElementById('regionDoSelect');
        const selSi = document.getElementById('regionSiSelect');

        fetch(/*[[@{/api/regions/do}]]*/'/api/regions/do')
            .then(r=>r.json()).then(dos=>{
            selDo.innerHTML = '<option value="" disabled selected>선택</option>' +
                dos.map(d=>`<option value="${d}">${d}</option>`).join('');
        });

        selDo.addEventListener('change', ()=>{
            const v = selDo.value;
            selSi.innerHTML = '<option value="" disabled selected>로딩...</option>';
            fetch(/*[[@{/api/regions/si}]]*/'/api/regions/si' + `?rdo=${encodeURIComponent(v)}`)
                .then(r=>r.json()).then(sis=>{
                selSi.innerHTML = '<option value="" disabled selected>선택</option>' +
                    sis.map(s=>`<option value="${s}">${s}</option>`).join('');
            });
        });
    })();

    // 칩/프리뷰/카테고리 추가
    Team11UI.setupPills('#categoryPills');
    Team11UI.setupImagePreview('#imageUrl','#preview');

    document.getElementById('btnAddCat').addEventListener('click', async ()=>{
        const v = document.getElementById('newCatName').value.trim();
        if(!v) return;
        try{
            const cat = await Team11UI.createCategory(/*[[@{/api/categories}]]*/'/api/categories', v);
            Team11UI.appendCategoryPill('#categoryPills', cat.id, cat.name);
            document.getElementById('newCatName').value='';
        }catch(e){
            alert(e.message || '카테고리를 추가할 수 없습니다.');
        }
    });
</script>
</body>
</html>

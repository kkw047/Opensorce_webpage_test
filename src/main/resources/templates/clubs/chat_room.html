<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title th:text="${roomName} + ' - 채팅'">채팅</title>
    <link rel="stylesheet" th:href="@{/css/app.css}">
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        .detail-card { border: 1px solid #1a332c; border-radius: 14px; background: #0f231e; padding: 16px; margin-bottom: 16px; }
        .chat-container { display: flex; flex-direction: column; height: 60vh; }
        .chat-messages { flex: 1; background: #071b15; border: 1px solid #153328; border-radius: 10px; padding: 12px; overflow-y: auto; margin-bottom: 12px; }
        .chat-input-form { display: flex; gap: 8px; }
        .chat-input-form input { flex: 1; }

        .msg-item { margin-bottom: 10px; }
        .msg-sender { font-weight: 600; font-size: 14px; margin-bottom: 2px; }
        .msg-content { background: #12352b; padding: 8px 12px; border-radius: 10px; display: inline-block; max-width: 70%; word-wrap: break-word; }
        .msg-time { font-size: 10px; color: #9ec8b8; margin-left: 8px; }

        /* 내가 보낸 메시지 */
        .msg-item.mine { text-align: right; }
        .msg-item.mine .msg-content { background: #1db954; color: #04120e; }
        /* .msg-item.mine .msg-sender { color: #1db954; } */ /* 내 닉네임은 숨기므로 주석처리 */

        /* 삭제/관리 버튼 */
        .btn-danger {
            background: #a02c2c;
            border-color: #a02c2c;
            color: #fff;
        }
        .btn-danger:hover {
            background: #c0392b;
            border-color: #c0392b;
            color: #fff;
            filter: brightness(1.05);
        }
    </style>
</head>
<body class="bg-deep">

<header class="topbar" th:replace="~{fragments/common :: topbar}"></header>

<div class="wrap">
    <aside class="sidebar" th:replace="~{fragments/common :: sidebar}"></aside>
    <main class="content">
        <form class="toolbar" th:replace="~{fragments/common :: searchbar}"></form>

        <div class="detail-card">
            <div th:replace="~{fragments/common :: club-tabs}"></div>
        </div>

        <div id="toast"
             th:if="${error != null or msg != null}"
             th:text="${error ?: msg}"
             class="toast show"
             th:classappend="${error != null} ? 'toast-error' : 'toast-success'">
        </div>

        <div class="detail-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h2 style="margin: 0;" th:text="${roomName}">채팅방 이름</h2>

                <div style="display: flex; gap: 8px;">
                    <a th:if="${roomOwnerId != null && roomOwnerId == session.LOGIN_USER_ID}"
                       th:href="@{/clubs/{id}/chat/{roomId}/manage(id=${club.id}, roomId=${roomId})}"
                       class="btn btn-danger">
                        방 관리
                    </a>

                    <a th:href="@{/clubs/{id}/chat(id=${club.id})}" class="btn">목록으로</a>
                </div>
            </div>

            <div class="chat-container">
                <div class="chat-messages" id="chatMessages">
                    <p>채팅 내역을 불러오는 중입니다...</p>
                </div>

                <form class="chat-input-form" id="chatSendForm" method="post">
                    <input type="text" name="content" placeholder="메시지 입력..." autocomplete="off" required>
                    <button class="btn primary">전송</button>
                </form>
            </div>
        </div>
    </main>
</div>

<div th:replace="~{fragments/common :: modals}"></div>
<div th:replace="~{fragments/common :: scripts}"></div>

<script th:inline="javascript">
    // th:inline="javascript"로 서버 데이터 가져오기
    const currentNickname = /*[[${session.LOGIN_USER_NICKNAME}]]*/ null;
    const currentUserId = /*[[${session.LOGIN_USER_ID}]]*/ null;
    const clubId = /*[[${club.id}]]*/ null;
    const roomId = /*[[${roomId}]]*/ null;

    let stompClient = null;

    const chatMessages = document.getElementById("chatMessages");
    const chatSendForm = document.getElementById("chatSendForm");

    function scrollToBottom() {
        if(chatMessages) {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    }

    // (chat.html의 appendMessage와 동일한 기능)
    function appendMessage(msg) {
        const isMine = msg.senderNickname === currentNickname;
        const itemDiv = document.createElement("div");
        itemDiv.className = `msg-item ${isMine ? 'mine' : ''}`;

        let senderHtml = '';
        if (!isMine) {
            senderHtml = `<div class="msg-sender">${msg.senderNickname || '(알 수 없음)'}</div>`;
        }

        const contentSpan = document.createElement('span');
        contentSpan.textContent = msg.content;

        const timeSpan = document.createElement('span');
        timeSpan.className = 'msg-time';
        timeSpan.textContent = msg.sentAt;

        const contentDiv = document.createElement('div');
        contentDiv.className = 'msg-content';
        contentDiv.appendChild(contentSpan);
        contentDiv.appendChild(timeSpan);

        itemDiv.innerHTML = senderHtml;
        itemDiv.appendChild(contentDiv);
        chatMessages.appendChild(itemDiv);
    }

    // 초기 메시지 로드
    async function fetchInitialMessages(clubId, roomId) {
        try {
            const msgResponse = await fetch(`/api/clubs/${clubId}/chat/${roomId}/messages`);
            if (!msgResponse.ok) {
                throw new Error("메시지를 불러오는데 실패했습니다.");
            }
            const messages = await msgResponse.json();
            chatMessages.innerHTML = ''; // '로딩 중' 메시지 제거
            messages.forEach(appendMessage);
            scrollToBottom();
            chatSendForm.querySelector('input[name="content"]').focus();
        } catch (err) {
            chatMessages.innerHTML = `<p style="color: #f88;">${err.message}</p>`;
        }
    }

    // WebSocket 연결
    function connectWebSocket(clubId, roomId) {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.debug = null; // 디버그 로그 끄기

        stompClient.connect({},
            (frame) => { // 연결 성공
                console.log('Connected: ' + frame);

                // 1. 방 토픽 구독
                stompClient.subscribe('/topic/chat/' + roomId, (message) => {
                    const newMsgDto = JSON.parse(message.body);
                    appendMessage(newMsgDto);
                    scrollToBottom();
                });

                // 2. 초기 메시지 로드 (구독 후)
                fetchInitialMessages(clubId, roomId);
            },
            (error) => { // 연결 실패
                console.error('STOMP Connection Error: ' + error);
                chatMessages.innerHTML = `<p style="color: #f88;">채팅 서버에 연결할 수 없습니다. 페이지를 새로고침해주세요.</p>`;
            }
        );
    }

    // 폼 전송 이벤트 리스너 (STOMP)
    chatSendForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const input = chatSendForm.querySelector('input[name="content"]');
        const content = input.value.trim();

        if (!content || !stompClient || !roomId) return;

        try {
            stompClient.send(
                "/app/chat/" + roomId + "/send",
                {},
                JSON.stringify({ 'content': content })
            );

            chatSendForm.reset();
            input.focus();
        } catch (err) {
            console.error("Send Error: " + err);
        }
    });

    // 페이지 로드 시 WebSocket 연결 시작
    document.addEventListener("DOMContentLoaded", () => {
        if (clubId && roomId) {
            connectWebSocket(clubId, roomId);
        } else {
            chatMessages.innerHTML = '<p style="color: #f88;">채팅방 정보를 불러올 수 없습니다.</p>';
        }
    });

    // 페이지 이탈 시 연결 종료 (선택적)
    window.addEventListener("beforeunload", () => {
        if (stompClient !== null) {
            stompClient.disconnect();
        }
    });
</script>
</body>
</html>
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title th:text="${roomName} + ' - 채팅'">채팅</title>
    <link rel="stylesheet" th:href="@{/css/app.css}">
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        /* 채팅방 전용 스타일 */
        .detail-card { border: 1px solid var(--border); border-radius: 14px; background: #ffffff; padding: 16px; margin-bottom: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .chat-container { display: flex; flex-direction: column; height: 65vh; border: 1px solid var(--border); border-radius: 12px; overflow: hidden; background: #fcfdfd; }
        .chat-messages { flex: 1; padding: 20px; overflow-y: auto; margin-bottom: 0; display: flex; flex-direction: column; gap: 12px; }
        .chat-input-form { display: flex; gap: 10px; padding: 16px; background: #ffffff; border-top: 1px solid var(--border); }
        .chat-input-form input { flex: 1; border: 1px solid var(--border); background: #fff; color: var(--text-main); }

        .msg-item { display: flex; flex-direction: column; max-width: 75%; margin-bottom: 5px; }
        .msg-sender { font-size: 0.85rem; font-weight: 600; margin-bottom: 4px; color: var(--text-muted); margin-left: 4px; }
        .msg-content {
            background: #f0f0f0; padding: 10px 14px; border-radius: 16px; border-top-left-radius: 2px;
            display: inline-block; word-wrap: break-word; color: #333; font-size: 0.95rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .msg-time { font-size: 0.75rem; color: #aaa; margin-left: 6px; margin-top: 2px; }

        .msg-item.mine { align-self: flex-end; align-items: flex-end; text-align: right; }
        .msg-item.mine .msg-content {
            background: var(--primary); color: #fff; border-top-left-radius: 16px; border-top-right-radius: 2px;
        }
        .msg-item.mine .msg-sender { display: none; } /* 내 닉네임 숨김 */

        .btn-danger {
            background: #fff0f0; border-color: #ffcdd2; color: var(--danger);
        }
        .btn-danger:hover {
            background: #ffebee;
        }
    </style>
</head>
<body class="bg-deep">

<header class="topbar" th:replace="~{fragments/common :: topbar}"></header>

<div class="wrap">
    <aside class="sidebar" th:replace="~{fragments/common :: sidebar}"></aside>
    <main class="content">
        <form class="toolbar" th:replace="~{fragments/common :: searchbar}"></form>

        <div class="detail-card">
            <div th:replace="~{fragments/common :: club-tabs}"></div>
        </div>

        <div id="toast"
             th:if="${error != null or msg != null}"
             th:text="${error ?: msg}"
             class="toast show"
             th:classappend="${error != null} ? 'toast-error' : 'toast-success'">
        </div>

        <div class="detail-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h2 style="margin: 0; font-size: 1.4rem; font-weight:700; color: var(--text-main);" th:text="${roomName}">채팅방 이름</h2>

                <div style="display: flex; gap: 8px;">
                    <a th:if="${roomOwnerId != null && roomOwnerId == session.LOGIN_USER_ID}"
                       th:href="@{/clubs/{id}/chat/{roomId}/manage(id=${club.id}, roomId=${roomId})}"
                       class="btn btn-danger">
                        방 관리
                    </a>

                    <a th:href="@{/clubs/{id}/chat(id=${club.id})}" class="btn">목록으로</a>
                </div>
            </div>

            <div class="chat-container">
                <div class="chat-messages" id="chatMessages">
                    <p style="text-align:center; color:var(--text-muted);">채팅 내역을 불러오는 중입니다...</p>
                </div>

                <form class="chat-input-form" id="chatSendForm" method="post">
                    <input type="text" name="content" placeholder="메시지 입력..." autocomplete="off" required>
                    <button class="btn primary">전송</button>
                </form>
            </div>
        </div>
    </main>
</div>

<div th:replace="~{fragments/common :: modals}"></div>
<div th:replace="~{fragments/common :: scripts}"></div>

<script th:inline="javascript">
    const currentNickname = /*[[${session.LOGIN_USER_NICKNAME}]]*/ null;
    const currentUserId = /*[[${session.LOGIN_USER_ID}]]*/ null;
    const clubId = /*[[${club.id}]]*/ null;
    const roomId = /*[[${roomId}]]*/ null;

    let stompClient = null;

    const chatMessages = document.getElementById("chatMessages");
    const chatSendForm = document.getElementById("chatSendForm");

    function scrollToBottom() {
        if(chatMessages) {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    }

    function appendMessage(msg) {
        const isMine = msg.senderNickname === currentNickname;
        const itemDiv = document.createElement("div");
        itemDiv.className = `msg-item ${isMine ? 'mine' : ''}`;

        let senderHtml = '';
        if (!isMine) {
            senderHtml = `<div class="msg-sender">${msg.senderNickname || '(알 수 없음)'}</div>`;
        }

        const contentSpan = document.createElement('span');
        contentSpan.textContent = msg.content;

        const timeSpan = document.createElement('span');
        timeSpan.className = 'msg-time';
        timeSpan.textContent = msg.sentAt;

        const contentDiv = document.createElement('div');
        contentDiv.className = 'msg-content';
        contentDiv.appendChild(contentSpan);
        contentDiv.appendChild(timeSpan);

        itemDiv.innerHTML = senderHtml;
        itemDiv.appendChild(contentDiv);
        chatMessages.appendChild(itemDiv);
    }

    async function fetchInitialMessages(clubId, roomId) {
        try {
            const msgResponse = await fetch(`/api/clubs/${clubId}/chat/${roomId}/messages`);
            if (!msgResponse.ok) {
                throw new Error("메시지를 불러오는데 실패했습니다.");
            }
            const messages = await msgResponse.json();
            chatMessages.innerHTML = '';
            messages.forEach(appendMessage);
            scrollToBottom();
            chatSendForm.querySelector('input[name="content"]').focus();
        } catch (err) {
            chatMessages.innerHTML = `<p style="color: #ff6b6b; text-align:center;">${err.message}</p>`;
        }
    }

    function connectWebSocket(clubId, roomId) {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.debug = null;

        stompClient.connect({},
            (frame) => {
                console.log('Connected: ' + frame);
                stompClient.subscribe('/topic/chat/' + roomId, (message) => {
                    const newMsgDto = JSON.parse(message.body);
                    appendMessage(newMsgDto);
                    scrollToBottom();
                });
                fetchInitialMessages(clubId, roomId);
            },
            (error) => {
                console.error('STOMP Connection Error: ' + error);
                chatMessages.innerHTML = `<p style="color: #ff6b6b; text-align:center;">채팅 서버에 연결할 수 없습니다. 페이지를 새로고침해주세요.</p>`;
            }
        );
    }

    chatSendForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const input = chatSendForm.querySelector('input[name="content"]');
        const content = input.value.trim();

        if (!content || !stompClient || !roomId) return;

        try {
            stompClient.send(
                "/app/chat/" + roomId + "/send",
                {},
                JSON.stringify({ 'content': content })
            );

            chatSendForm.reset();
            input.focus();
        } catch (err) {
            console.error("Send Error: " + err);
        }
    });

    document.addEventListener("DOMContentLoaded", () => {
        if (clubId && roomId) {
            connectWebSocket(clubId, roomId);
        } else {
            chatMessages.innerHTML = '<p style="color: #ff6b6b; text-align:center;">채팅방 정보를 불러올 수 없습니다.</p>';
        }
    });

    window.addEventListener("beforeunload", () => {
        if (stompClient !== null) {
            stompClient.disconnect();
        }
    });
</script>
</body>
</html>
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title th:text="${roomName} + ' - 채팅'">채팅</title>
    <link rel="stylesheet" th:href="@{/css/app.css}">
    <style>
        .detail-card { border: 1px solid #1a332c; border-radius: 14px; background: #0f231e; padding: 16px; margin-bottom: 16px; }
        .chat-container { display: flex; flex-direction: column; height: 60vh; }
        .chat-messages { flex: 1; background: #071b15; border: 1px solid #153328; border-radius: 10px; padding: 12px; overflow-y: auto; margin-bottom: 12px; }
        .chat-input-form { display: flex; gap: 8px; }
        .chat-input-form input { flex: 1; }

        .msg-item { margin-bottom: 10px; }
        .msg-sender { font-weight: 600; font-size: 14px; margin-bottom: 2px; }
        .msg-content { background: #12352b; padding: 8px 12px; border-radius: 10px; display: inline-block; max-width: 70%; word-wrap: break-word; }
        .msg-time { font-size: 10px; color: #9ec8b8; margin-left: 8px; }

        /* 내가 보낸 메시지 */
        .msg-item.mine { text-align: right; }
        .msg-item.mine .msg-content { background: #1db954; color: #04120e; }
        /* .msg-item.mine .msg-sender { color: #1db954; } */ /* 내 닉네임은 숨기므로 주석처리 */

        /* 삭제/관리 버튼 */
        .btn-danger {
            background: #a02c2c;
            border-color: #a02c2c;
            color: #fff;
        }
        .btn-danger:hover {
            background: #c0392b;
            border-color: #c0392b;
            color: #fff;
            filter: brightness(1.05);
        }
    </style>
</head>
<body class="bg-deep">

<header class="topbar" th:replace="~{fragments/common :: topbar}"></header>

<div class="wrap">
    <aside class="sidebar" th:replace="~{fragments/common :: sidebar}"></aside>
    <main class="content">
        <form class="toolbar" th:replace="~{fragments/common :: searchbar}"></form>

        <div class="detail-card">
            <div th:replace="~{fragments/common :: club-tabs}"></div>
        </div>

        <div id="toast"
             th:if="${error != null or msg != null}"
             th:text="${error ?: msg}"
             class="toast show"
             th:classappend="${error != null} ? 'toast-error' : 'toast-success'">
        </div>

        <div class="detail-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h2 style="margin: 0;" th:text="${roomName}">채팅방 이름</h2>

                <div style="display: flex; gap: 8px;">
                    <a th:if="${roomOwnerId != null && roomOwnerId == session.LOGIN_USER_ID}"
                       th:href="@{/clubs/{id}/chat/{roomId}/manage(id=${club.id}, roomId=${roomId})}"
                       class="btn btn-danger">
                        방 관리
                    </a>

                    <a th:href="@{/clubs/{id}/chat(id=${club.id})}" class="btn">목록으로</a>
                </div>
            </div>

            <div class="chat-container">
                <div class="chat-messages" id="chatMessages">
                    <div th:each="msg : ${messages}"
                         class="msg-item"
                         th:classappend="${msg.senderNickname == session.LOGIN_USER_NICKNAME ? 'mine' : ''}">

                        <div class="msg-sender" th:if="${msg.senderNickname != session.LOGIN_USER_NICKNAME}" th:text="${msg.senderNickname}">보낸사람</div>

                        <div class="msg-content">
                            <span th:text="${msg.content}">메시지 내용...</span>
                            <span class="msg-time" th:text="${msg.sentAt}">00:00</span>
                        </div>
                    </div>
                </div>

                <form class="chat-input-form"
                      th:action="@{/clubs/{id}/chat/{roomId}/send(id=${club.id}, roomId=${roomId})}"
                      method="post">
                    <input type="text" name="content" placeholder="메시지 입력..." autocomplete="off" required>
                    <button class="btn primary">전송</button>
                </form>
            </div>
        </div>
    </main>
</div>

<div th:replace="~{fragments/common :: modals}"></div>
<div th:replace="~{fragments/common :: scripts}"></div>

<script>
    // 페이지 로드 시 스크롤을 맨 아래로
    document.addEventListener("DOMContentLoaded", () => {
        const chatMessages = document.getElementById("chatMessages");
        if(chatMessages) {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    });
</script>
</body>
</html>
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title th:text="${club.name} + ' - ê²Œì‹œíŒ'">ê²Œì‹œíŒ</title>
    <link rel="stylesheet" th:href="@{/css/app.css}">
    <style>
        /* ê²Œì‹œíŒ ì „ìš© ì¶”ê°€ ìŠ¤íƒ€ì¼ */
        .post-card {
            background: #ffffff;
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            padding: 16px;
            display: flex;
            gap: 16px;
            margin-bottom: 12px;
        }
        .post-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            border-color: var(--primary);
            cursor: pointer;
        }
        .list-thumbnail {
            width: 100px; height: 100px; object-fit: cover; border-radius: 8px; background: #f0f0f0;
        }
        .card-content-wrapper { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .post-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 6px; color: var(--text-main); }
        .post-preview { font-size: 0.9rem; color: var(--text-muted); display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .highlight { background-color: rgba(111, 207, 151, 0.3); font-weight: bold; }
        .profile-thumb { width: 36px; height: 36px; border-radius: 50%; background: #eee; font-size: 18px; margin-right: 10px; }
        .badge-owner { background: var(--primary-light); color: var(--primary-dark); font-size: 11px; padding: 2px 6px; border-radius: 4px; margin-left: 6px; font-weight: bold; }
    </style>
</head>
<body class="bg-deep"
      th:data-msg="${msg}"
      th:data-error="${error}"
      th:data-open-login="${openLogin}"
      th:data-open-register="${openRegister}">

<header class="topbar" th:replace="~{fragments/common :: topbar}"></header>

<div class="wrap">
    <aside class="sidebar" th:replace="~{fragments/common :: sidebar}"></aside>

    <main class="content">

        <div class="detail-card">
            <div th:replace="~{fragments/common :: club-tabs}"></div>
        </div>

        <div class="detail-card" style="display: flex; justify-content: space-between; align-items: center; margin-top: 16px; margin-bottom: 16px;">
            <h2 style="margin: 0; font-size: 24px; font-weight: bold; color: var(--text-main);">ê²Œì‹œíŒ ëª©ë¡</h2>

            <a th:if="${isAlreadyMember}"
               th:href="@{/clubs/{clubId}/board/new(clubId=${club.id})}"
               class="btn primary">
                ê²Œì‹œê¸€ ì‘ì„±
            </a>
        </div>

        <div class="post-list-container">

            <div class="post-card" th:each="post : ${posts}"
                 th:onclick="|location.href='@{/clubs/{clubId}/board/{postId}(clubId=${club.id}, postId=${post.id})}'|">

                <div th:if="${!post.images.isEmpty()}">
                    <img th:src="${post.images[0].imageUrl}" class="list-thumbnail" alt="ì¸ë„¤ì¼">
                </div>

                <div class="card-content-wrapper">
                    <div class="card-header" style="display:flex; align-items: center; margin-bottom: 8px;">
                        <img th:if="${post.author.imageUrl != null}" th:src="${post.author.imageUrl}" class="profile-thumb" alt="í”„ë¡œí•„">
                        <div th:unless="${post.author.imageUrl != null}" class="profile-thumb" style="display:flex; align-items:center; justify-content:center;">ğŸ‘¤</div>

                        <div class="author-info" style="display: flex; flex-direction: column; justify-content: center; line-height: 1.3;">
                            <div style="display: flex; align-items: center;">
                                <span class="author-name" th:text="${post.author.nickname}" style="font-weight: bold; font-size: 0.95rem;">ì‘ì„±ì</span>
                                <span class="badge-owner" th:if="${post.author.id == club.ownerId}">[ê´€ë¦¬ì]</span>
                            </div>
                            <span class="post-date" th:text="${#temporals.format(post.createdAt, 'yyyy-MM-dd')}" style="font-size: 0.8rem; color: var(--text-muted);">ë‚ ì§œ</span>
                        </div>
                    </div>

                    <div class="post-title" th:text="${post.title}">ì œëª©ì´ ì—¬ê¸°ì— ë“¤ì–´ê°‘ë‹ˆë‹¤.</div>

                    <p class="post-preview" th:text="${post.content}">ê²Œì‹œê¸€ ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°...</p>
                </div>
            </div>

            <div th:if="${posts.totalElements == 0}" class="detail-card" style="text-align: center; padding: 40px 0;">

                <div th:if="${searchKeyword != null and searchKeyword != ''}" class="empty-state">
                    <h3 class="empty-title" style="color: var(--text-main);">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</h3>
                    <p class="empty-desc" style="color: var(--text-muted);">
                        '<span th:text="${searchKeyword}" style="color: var(--primary); font-weight: bold;"></span>'ì— ëŒ€í•œ ê²€ìƒ‰ ê²°ê³¼ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.<br>
                        ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë¡œ ë‹¤ì‹œ ì‹œë„í•´ ë³´ì„¸ìš”.
                    </p>
                </div>

                <div th:if="${searchKeyword == null or searchKeyword == ''}" class="empty-state">
                    <h3 class="empty-title" style="color: var(--text-main);">ì•„ì§ ì‘ì„±ëœ ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</h3>
                    <p class="empty-desc" style="color: var(--text-muted); margin-bottom: 20px;">
                        ì´ ëª¨ì„ì˜ ì²« ë²ˆì§¸ ì´ì•¼ê¸°ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”!<br>
                        ë©¤ë²„ë“¤ê³¼ ì†Œì†Œí•œ ì¼ìƒì„ ê³µìœ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    </p>

                    <a th:if="${isAlreadyMember}"
                       th:href="@{/clubs/{clubId}/board/new(clubId=${club.id})}"
                       class="btn primary">ì²« ê¸€ ì‘ì„±í•˜ê¸°</a>
                </div>

            </div>
        </div>

        <div class="pagination-wrapper" th:if="${posts.totalPages > 0}" style="text-align: center; margin-top: 20px;">
            <div class="page-info" style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 10px;">
                ì´ <span th:text="${posts.totalElements}">0</span>ê°œì˜ ê¸€
            </div>

            <div class="pagination-buttons pager">
                <a th:href="${posts.first} ? null : @{/clubs/{clubId}/board(clubId=${club.id}, page=${posts.number - 1}, type=${searchType}, keyword=${searchKeyword})}"
                   class="page-btn prev-next"
                   th:classappend="${posts.first} ? 'disabled' : ''">
                    &lt; ì´ì „
                </a>

                <a th:each="page : ${#numbers.sequence(startPage, endPage)}"
                   th:href="@{/clubs/{clubId}/board(clubId=${club.id}, page=${page - 1}, type=${searchType}, keyword=${searchKeyword})}"
                   th:text="${page}"
                   class="page-btn"
                   th:classappend="${page == nowPage} ? 'active' : ''">
                    1
                </a>

                <a th:href="${posts.last} ? null : @{/clubs/{clubId}/board(clubId=${club.id}, page=${posts.number + 1}, type=${searchType}, keyword=${searchKeyword})}"
                   class="page-btn prev-next"
                   th:classappend="${posts.last} ? 'disabled' : ''">
                    ë‹¤ìŒ &gt;
                </a>
            </div>
        </div>

        <div class="search-container" style="display: flex; justify-content: center; margin: 40px 0;">
            <form th:action="@{/clubs/{clubId}/board(clubId=${club.id})}" method="get"
                  style="display: flex; gap: 8px; background: var(--bg-card); padding: 10px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 4px 10px rgba(0,0,0,0.03);">

                <select name="type" class="custom-select" style="width: 120px; border: 1px solid var(--border); border-radius: 8px; color: var(--text-main);">
                    <option value="all" th:selected="${searchType == 'all'}">ì œëª©+ë‚´ìš©</option>
                    <option value="title" th:selected="${searchType == 'title'}">ì œëª©</option>
                    <option value="content" th:selected="${searchType == 'content'}">ë‚´ìš©</option>
                </select>

                <input type="text" name="keyword" th:value="${searchKeyword}"
                       class="form-control" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                       style="width: 250px; height: 40px; border: 1px solid var(--border); background: #fff; border-radius: 8px;">

                <button type="submit" class="btn primary" style="height: 40px; padding: 0 20px;">ê²€ìƒ‰</button>
            </form>
        </div>

        <div style="height: 40px;"></div>

    </main>
</div>

<div id="toast"
     th:if="${error != null or msg != null}"
     th:text="${error ?: msg}"
     class="toast show">
</div>

<div th:replace="~{fragments/common :: modals}"></div>
<div th:replace="~{fragments/common :: scripts}"></div>

<script th:inline="javascript">
    // 1. ë¡œê·¸ì¸/íšŒì›ê°€ì… ëª¨ë‹¬ ìë™ ì—´ê¸°
    if([[${openLogin}]]) {
        document.addEventListener("DOMContentLoaded", () => modal("loginModal", true));
    }
    if([[${openRegister}]]) {
        document.addEventListener("DOMContentLoaded", () => modal("registerModal", true));
    }

    // 2. í† ìŠ¤íŠ¸ ë©”ì‹œì§€
    const toast = document.getElementById('toast');
    if (toast) {
        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    }
</script>

<script th:inline="javascript">
    // ê²€ìƒ‰ì–´ í•˜ì´ë¼ì´íŠ¸
    document.addEventListener("DOMContentLoaded", function() {
        const keyword = [[${searchKeyword}]];

        if (keyword && keyword.trim() !== "") {
            const posts = document.querySelectorAll('.post-card');

            posts.forEach(card => {
                const titleEl = card.querySelector('.post-title');
                const contentEl = card.querySelector('.post-preview');
                if (titleEl) highlightText(titleEl, keyword);
                if (contentEl) highlightText(contentEl, keyword);
            });
        }
    });

    function highlightText(element, keyword) {
        const originalText = element.textContent;
        const regex = new RegExp(`(${keyword})`, 'gi');
        if (originalText.match(regex)) {
            const newHtml = originalText.replace(regex, '<span class="highlight">$1</span>');
            element.innerHTML = newHtml;
        }
    }
</script>

</body>
</html>
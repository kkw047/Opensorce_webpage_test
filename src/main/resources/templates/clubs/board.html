<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title th:text="${club.name} + ' - ê²Œì‹œíŒ'">ê²Œì‹œíŒ</title>
    <link rel="stylesheet" th:href="@{/css/app.css}">
</head>
<body class="bg-deep"
      th:data-msg="${msg}"
      th:data-error="${error}"
      th:data-open-login="${openLogin}"
      th:data-open-register="${openRegister}">

<header class="topbar" th:replace="~{fragments/common :: topbar}"></header>

<div class="wrap">
    <aside class="sidebar" th:replace="~{fragments/common :: sidebar}"></aside>

    <main class="content">

        <div class="detail-card">
            <div th:replace="~{fragments/common :: club-tabs}"></div>
        </div>

        <div class="detail-card" style="display: flex; justify-content: space-between; align-items: center; margin-top: 16px; margin-bottom: 16px;">
            <h2 style="margin: 0; font-size: 24px; font-weight: bold;">ê²Œì‹œíŒ ëª©ë¡</h2>

            <a th:if="${isAlreadyMember}"
               th:href="@{/clubs/{clubId}/board/new(clubId=${club.id})}"
               class="btn primary">
                ê²Œì‹œê¸€ ì‘ì„±
            </a>
        </div>

        <div class="post-grid-container">

            <div class="post-card" th:each="post : ${posts}"
                 th:onclick="|location.href='@{/clubs/{clubId}/board/{postId}(clubId=${club.id}, postId=${post.id})}'|">

                <div th:if="${!post.images.isEmpty()}">
                    <img th:src="${post.images[0].imageUrl}" class="list-thumbnail" alt="ì¸ë„¤ì¼">
                </div>

                <div class="card-content-wrapper">
                    <div class="card-header">
                        <img th:if="${post.author.imageUrl != null}" th:src="${post.author.imageUrl}" class="profile-thumb" alt="í”„ë¡œí•„">
                        <div th:unless="${post.author.imageUrl != null}" class="profile-thumb" style="display:flex; align-items:center; justify-content:center;">ğŸ‘¤</div>

                        <div class="author-info" style="display: flex; flex-direction: column; justify-content: center; line-height: 1.3;">

                            <div style="display: flex; align-items: center;">
                                <span class="author-name" th:text="${post.author.nickname}" style="font-weight: bold;">ì‘ì„±ì</span>

                                <span class="badge-owner"
                                      th:if="${post.author.id == club.ownerId}">
                                [ê´€ë¦¬ì]
                            </span>
                            </div>

                            <span class="post-date" th:text="${#temporals.format(post.createdAt, 'yyyy-MM-dd')}">ë‚ ì§œ</span>
                        </div>
                    </div>

                    <div class="post-title" th:text="${post.title}">
                        ì œëª©ì´ ì—¬ê¸°ì— ë“¤ì–´ê°‘ë‹ˆë‹¤.
                    </div>

                    <p class="post-preview"
                       th:text="${post.content}"
                       style="margin: 0; color: #b0c4de;">
                        ê²Œì‹œê¸€ ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°...
                    </p>
                </div>
            </div>

            <div th:if="${posts.totalElements == 0}">

                <div th:if="${searchKeyword != null and searchKeyword != ''}" class="empty-state">
                    <h3 class="empty-title">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</h3>
                    <p class="empty-desc">
                        '<span th:text="${searchKeyword}" style="color: #1db954; font-weight: bold;"></span>'ì— ëŒ€í•œ ê²€ìƒ‰ ê²°ê³¼ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.<br>
                        ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë¡œ ë‹¤ì‹œ ì‹œë„í•´ ë³´ì„¸ìš”.
                    </p>
                </div>

                <div th:if="${searchKeyword == null or searchKeyword == ''}" class="empty-state">
                    <h3 class="empty-title">ì•„ì§ ì‘ì„±ëœ ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</h3>
                    <p class="empty-desc">
                        ì´ ëª¨ì„ì˜ ì²« ë²ˆì§¸ ì´ì•¼ê¸°ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”!<br>
                        ë©¤ë²„ë“¤ê³¼ ì†Œì†Œí•œ ì¼ìƒì„ ê³µìœ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    </p>

                    <a th:if="${isAlreadyMember}"
                       th:href="@{/clubs/{clubId}/board/new(clubId=${club.id})}"
                       class="btn primary mt12">ì²« ê¸€ ì‘ì„±í•˜ê¸°</a>
                </div>

            </div>
        <div class="pagination-wrapper" th:if="${posts.totalPages > 0}">

            <div class="page-info">
                ì´ <span th:text="${posts.totalElements}">0</span>ê°œì˜ ê¸€
            </div>

            <div class="pagination-buttons">

                <a th:href="@{/clubs/{clubId}/board(clubId=${club.id}, page=${posts.number - 1}, type=${searchType}, keyword=${searchKeyword})}"
                   class="page-btn prev-next"
                   th:classappend="${posts.first} ? 'disabled' : ''">
                    &lt; ì´ì „
                </a>

                <a th:each="page : ${#numbers.sequence(startPage, endPage)}"
                   th:href="@{/clubs/{clubId}/board(clubId=${club.id}, page=${page - 1}, type=${searchType}, keyword=${searchKeyword})}"
                   th:text="${page}"
                   class="page-btn"
                   th:classappend="${page == nowPage} ? 'active' : ''">
                    1
                </a>

                <a th:href="@{/clubs/{clubId}/board(clubId=${club.id}, page=${posts.number + 1}, type=${searchType}, keyword=${searchKeyword})}"
                   class="page-btn prev-next"
                   th:classappend="${posts.last} ? 'disabled' : ''">
                    ë‹¤ìŒ &gt;
                </a>
            </div>
        </div>

            <div class="search-container" style="display: flex; justify-content: center; margin-bottom: 60px;">
                <form th:action="@{/clubs/{clubId}/board(clubId=${club.id})}" method="get"
                      style="display: flex; gap: 8px; background: #0f231e; padding: 10px; border-radius: 12px; border: 1px solid #1a332c;">

                    <select name="type" class="custom-select" style="width: 120px;">
                        <option value="all" th:selected="${searchType == 'all'}">ì œëª©+ë‚´ìš©</option>
                        <option value="title" th:selected="${searchType == 'title'}">ì œëª©</option>
                        <option value="content" th:selected="${searchType == 'content'}">ë‚´ìš©</option>
                    </select>

                    <input type="text" name="keyword" th:value="${searchKeyword}"
                           class="form-control" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                           style="width: 250px; height: 40px; border: none; background: #1a332c;">

                    <button type="submit" class="btn primary" style="height: 40px; padding: 0 20px;">ê²€ìƒ‰</button>
                </form>
            </div>

        <div style="height: 60px;"></div>
        </div>
    </main>
</div>

<div id="toast"
     th:if="${error != null or msg != null}"
     th:text="${error ?: msg}"
     class="toast show">
</div>

<div th:replace="~{fragments/common :: modals}"></div>
<div th:replace="~{fragments/common :: scripts}"></div>

<script th:inline="javascript">
    // 1. ë¡œê·¸ì¸/íšŒì›ê°€ì… ëª¨ë‹¬ ìë™ ì—´ê¸°
    if([[${openLogin}]]) {
        document.addEventListener("DOMContentLoaded", () => modal("loginModal", true));
    }
    if([[${openRegister}]]) {
        document.addEventListener("DOMContentLoaded", () => modal("registerModal", true));
    }

    // 2. í† ìŠ¤íŠ¸ ë©”ì‹œì§€ê°€ ìˆìœ¼ë©´ 3ì´ˆ ë’¤ì— ì‚¬ë¼ì§€ê²Œ í•¨
    const toast = document.getElementById('toast');
    if (toast) {
        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    }
</script>

<script th:inline="javascript">
    // ê²€ìƒ‰ì–´ í•˜ì´ë¼ì´íŠ¸ ê¸°ëŠ¥
    document.addEventListener("DOMContentLoaded", function() {
        const keyword = [[${searchKeyword}]]; // ì„œë²„ì—ì„œ ë°›ì€ ê²€ìƒ‰ì–´

        if (keyword && keyword.trim() !== "") {
            const posts = document.querySelectorAll('.post-card');

            posts.forEach(card => {
                // ì œëª©(.post-title)ê³¼ ë‚´ìš©(.post-preview)ì—ì„œ ê²€ìƒ‰ì–´ ì°¾ê¸°
                const titleEl = card.querySelector('.post-title');
                const contentEl = card.querySelector('.post-preview');

                if (titleEl) highlightText(titleEl, keyword);
                if (contentEl) highlightText(contentEl, keyword);
            });
        }
    });

    function highlightText(element, keyword) {
        const originalText = element.textContent;
        // ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ì´ ê²€ìƒ‰ (gi)
        const regex = new RegExp(`(${keyword})`, 'gi');

        // ê²€ìƒ‰ëœ ë‹¨ì–´ë¥¼ span class="highlight" ë¡œ ê°ì‹¸ê¸°
        if (originalText.match(regex)) {
            const newHtml = originalText.replace(regex, '<span class="highlight">$1</span>');
            element.innerHTML = newHtml;
        }
    }
</script>

</body>
</html>
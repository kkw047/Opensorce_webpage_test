<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>모임 메인</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="stylesheet" th:href="@{/css/app.css}" href="/css/app.css"/>
    <style>
        /* 최소 스타일 (app.css 있으면 그거 우선) */
        body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", sans-serif; margin:0; background:#f7f7f8; }
        .topbar { display:flex; justify-content:space-between; align-items:center; padding:12px 16px; background:#111827; color:#fff; }
        .topbar .actions button { margin-left:8px; padding:8px 12px; background:#374151; color:#fff; border:none; border-radius:8px; cursor:pointer; }
        .container { display:grid; grid-template-rows: auto 1fr; height:calc(100vh - 52px); }
        .search { padding:12px 16px; background:#fff; border-bottom:1px solid #e5e7eb; display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
        .layout { display:grid; grid-template-columns: 280px 1fr; gap:12px; padding:12px; }
        .card { background:#fff; border:1px solid #e5e7eb; border-radius:12px; }
        .card .card-header { padding:12px 14px; border-bottom:1px solid #e5e7eb; font-weight:600; }
        .card .card-body { padding:12px 14px; }
        .sidebar .footer { padding:12px 14px; border-top:1px solid #e5e7eb; }
        .btn-primary { background:#2563eb; color:#fff; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; }
        .btn-ghost { background:transparent; border:1px solid #d1d5db; color:#111827; padding:8px 12px; border-radius:8px; cursor:pointer; }
        .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap:12px; }
        .club { border:1px solid #e5e7eb; border-radius:12px; overflow:hidden; background:#fff; display:flex; flex-direction:column; }
        .club img { width:100%; height:160px; object-fit:cover; background:#f3f4f6; }
        .club .info { padding:12px; display:flex; flex-direction:column; gap:6px; }
        .badge { font-size:12px; background:#eef2ff; color:#3730a3; padding:2px 8px; border-radius:999px; margin-right:6px; display:inline-block; }
        .muted { color:#6b7280; font-size:13px; }
        .row { display:flex; gap:8px; }
        .row > * { flex:1 1 auto; min-width:140px; }
        label { font-size:12px; color:#374151; display:block; margin-bottom:4px; }
        select, input[type="text"], input[type="file"] { width:100%; padding:8px 10px; border:1px solid #d1d5db; border-radius:8px; background:#fff; }
        .checkbox { display:flex; align-items:center; gap:8px; margin:6px 0; }
        /* Modal */
        .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:50; }
        .modal { width:min(720px, 92vw); background:#fff; border-radius:16px; border:1px solid #e5e7eb; overflow:hidden; }
        .modal .card-header { display:flex; justify-content:space-between; align-items:center; }
        .hidden { display:none; }
    </style>
</head>
<body>
<div class="topbar">
    <div class="brand" style="font-weight:700;">모임 플랫폼</div>
    <div class="actions">
        <button type="button" class="btn-ghost" id="btn-login-open">로그인</button>
        <button type="button" class="btn-primary" id="btn-register-open">회원가입</button>
    </div>
</div>

<div class="container">
    <!-- 2. 지역/키워드 검색 -->
    <form class="search" th:action="@{/clubs}" method="get">
        <div class="row">
            <div>
                <label for="regionDo">도(道)</label>
                <select id="regionDo" name="regionDo">
                    <option value="">전체</option>
                    <!-- regions 가 제공된다면 (RegionKor: id, regionDo, regionSi) 도 목록 고유값으로 생성 -->
                    <th:block th:if="${regions}">
                        <th:block th:with="dos=${#sets.toSet(regions.^map(r -> r.regionDo))}">
                            <option th:each="d : ${dos}"
                                    th:value="${d}"
                                    th:text="${d}">충청북도</option>
                        </th:block>
                    </th:block>
                </select>
            </div>
            <div>
                <label for="regionSi">시/군/구</label>
                <select id="regionSi" name="regionSi">
                    <option value="">전체</option>
                    <th:block th:if="${regions}">
                        <option th:each="r : ${regions}"
                                th:value="${r.regionSi}"
                                th:text="${r.regionSi}">청주시</option>
                    </th:block>
                </select>
            </div>
            <div>
                <label for="keyword">키워드</label>
                <input id="keyword" name="keyword" type="text" placeholder="모임명/설명 검색"
                       th:value="${param.keyword != null ? param.keyword : ''}"/>
            </div>
            <div style="align-self:end">
                <button class="btn-primary" type="submit">검색</button>
            </div>
        </div>
    </form>

    <div class="layout">
        <!-- 3. 좌측 메뉴/카테고리/모임 만들기 -->
        <aside class="sidebar card">
            <div class="card-header">메뉴</div>
            <div class="card-body">
                <div class="row" style="gap:6px;">
                    <a class="btn-ghost" th:href="@{/}">메인</a>
                    <a class="btn-ghost" th:href="@{/clubs}">추천</a>
                    <a class="btn-ghost" th:href="@{/calendar}">캘린더</a>
                    <a class="btn-ghost" th:href="@{/mypage}">내모임</a>
                </div>
            </div>

            <div class="card-header">카테고리 필터</div>
            <div class="card-body" style="max-height:260px; overflow:auto;">
                <div th:if="${categories}">
                    <label class="checkbox" th:each="c : ${categories}">
                        <input type="checkbox" name="categoryFilter" class="cat-filter"
                               th:value="${c.id}"
                               th:checked="${param.categoryFilter != null ? #lists.contains(param.categoryFilter, c.id + '') : false}"/>
                        <span th:text="${c.name}">카테고리</span>
                    </label>
                </div>
                <div th:if="${categories == null or #lists.isEmpty(categories)}" class="muted">카테고리가 없습니다.</div>
                <div style="margin-top:10px;">
                    <button class="btn-primary" id="btn-apply-categories" type="button">필터 적용</button>
                </div>
            </div>

            <div class="footer">
                <button class="btn-primary" id="btn-create-open" type="button" style="width:100%;">모임 만들기</button>
            </div>
        </aside>

        <!-- 4. 우측 모임 목록 -->
        <main class="card">
            <div class="card-header">모임 목록</div>
            <div class="card-body">
                <div th:if="${clubs == null or #lists.isEmpty(clubs)}" class="muted">표시할 모임이 없습니다.</div>

                <div class="grid" th:if="${clubs}">
                    <article class="club" th:each="club : ${clubs}">
                        <img th:if="${club.imageData != null}"
                             th:src="@{/clubs/{id}/image(id=${club.id})}" alt="모임 이미지"/>
                        <img th:if="${club.imageData == null}" src="/static/noimage.png" alt="플레이스홀더"/>

                        <div class="info">
                            <div style="font-weight:700;" th:text="${club.name != null ? club.name : '이름없음'}">모임 이름</div>
                            <div class="muted" th:text="${club.description != null ? club.description : '설명 없음'}">설명</div>
                            <div class="muted" th:text="${(club.regionDo != null ? club.regionDo : '') + (club.regionSi != null ? ' ' + club.regionSi : '')}">지역</div>
                            <div>
                                <!-- 카테고리 이름 목록이 있으면 표시 (선택적) -->
                                <span class="badge" th:each="cn : ${club.categoryNames}" th:text="${cn}">카테고리</span>
                            </div>
                            <div>
                                <a class="btn-ghost" th:href="@{/clubs/{id}(id=${club.id})}">자세히</a>
                            </div>
                        </div>
                    </article>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- 로그인 모달 -->
<div class="modal-backdrop" id="modal-login">
    <div class="modal">
        <div class="card-header">
            <span>로그인</span>
            <button class="btn-ghost" type="button" data-close="#modal-login">닫기</button>
        </div>
        <div class="card-body">
            <form th:action="@{/auth/login}" method="post">
                <div class="row">
                    <div>
                        <label for="login-username">아이디</label>
                        <input id="login-username" name="username" type="text" required/>
                    </div>
                    <div>
                        <label for="login-password">비밀번호</label>
                        <input id="login-password" name="password" type="password" required/>
                    </div>
                </div>
                <div style="margin-top:12px;">
                    <button class="btn-primary" type="submit">로그인</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 회원가입 모달 -->
<div class="modal-backdrop" id="modal-register">
    <div class="modal">
        <div class="card-header">
            <span>회원가입</span>
            <button class="btn-ghost" type="button" data-close="#modal-register">닫기</button>
        </div>
        <div class="card-body">
            <form th:action="@{/auth/register}" method="post">
                <div class="row">
                    <div>
                        <label for="reg-username">아이디</label>
                        <input id="reg-username" name="username" type="text" required/>
                    </div>
                    <div>
                        <label for="reg-password">비밀번호</label>
                        <input id="reg-password" name="password" type="password" required/>
                    </div>
                </div>

                <div style="margin-top:10px;">
                    <div style="font-weight:600; margin-bottom:6px;">카테고리 선택</div>
                    <div style="max-height:160px; overflow:auto; border:1px solid #e5e7eb; border-radius:8px; padding:8px;">
                        <label class="checkbox" th:each="c : ${categories}">
                            <input type="checkbox" name="categoryIds" th:value="${c.id}"/>
                            <span th:text="${c.name}">카테고리</span>
                        </label>
                        <div th:if="${categories == null or #lists.isEmpty(categories)}" class="muted">카테고리가 없습니다.</div>
                    </div>
                </div>

                <div style="margin-top:12px;">
                    <button class="btn-primary" type="submit">가입하기</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 모임 만들기 모달 -->
<div class="modal-backdrop" id="modal-create">
    <div class="modal">
        <div class="card-header">
            <span>모임 만들기</span>
            <button class="btn-ghost" type="button" data-close="#modal-create">닫기</button>
        </div>
        <div class="card-body">
            <form th:action="@{/clubs}" method="post" enctype="multipart/form-data">
                <div class="row">
                    <div>
                        <label for="club-name">모임 이름</label>
                        <input id="club-name" name="name" type="text" required/>
                    </div>
                    <div>
                        <label for="club-desc">홍보 문구</label>
                        <input id="club-desc" name="description" type="text" />
                    </div>
                </div>

                <div class="row" style="margin-top:8px;">
                    <div>
                        <label for="club-do">도(道)</label>
                        <select id="club-do" name="regionDo">
                            <option value="">선택</option>
                            <th:block th:if="${regions}">
                                <th:block th:with="dos=${#sets.toSet(regions.^map(r -> r.regionDo))}">
                                    <option th:each="d : ${dos}" th:value="${d}" th:text="${d}">충청북도</option>
                                </th:block>
                            </th:block>
                        </select>
                    </div>
                    <div>
                        <label for="club-si">시/군/구</label>
                        <select id="club-si" name="regionSi">
                            <option value="">선택</option>
                            <th:block th:if="${regions}">
                                <option th:each="r : ${regions}" th:value="${r.regionSi}" th:text="${r.regionSi}">청주시</option>
                            </th:block>
                        </select>
                    </div>
                </div>

                <div style="margin-top:10px;">
                    <label>카테고리</label>
                    <div style="max-height:160px; overflow:auto; border:1px solid #e5e7eb; border-radius:8px; padding:8px;">
                        <label class="checkbox" th:each="c : ${categories}">
                            <input type="checkbox" name="categoryIds" th:value="${c.id}"/>
                            <span th:text="${c.name}">카테고리</span>
                        </label>
                        <div th:if="${categories == null or #lists.isEmpty(categories)}" class="muted">카테고리가 없습니다.</div>
                    </div>
                    <div class="row" style="margin-top:8px;">
                        <div>
                            <label for="new-category">새 카테고리 추가 (선택)</label>
                            <input id="new-category" name="newCategoryName" type="text" placeholder="예) 독서, 러닝, 스터디"/>
                        </div>
                    </div>
                </div>

                <div class="row" style="margin-top:10px;">
                    <div>
                        <label for="club-image">대표 이미지</label>
                        <input id="club-image" name="image" type="file" accept="image/*"/>
                    </div>
                </div>

                <div style="margin-top:12px;">
                    <button class="btn-primary" type="submit">만들기</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script th:src="@{/js/region.js}" src="/js/region.js"></script>
<script>
    // 모달 열기/닫기
    const $ = (sel) => document.querySelector(sel);
    const open = (id) => { const el = $(id); if (el) el.style.display = 'flex'; }
    const close = (id) => { const el = $(id); if (el) el.style.display = 'none'; }

    $("#btn-login-open")?.addEventListener("click", () => open("#modal-login"));
    $("#btn-register-open")?.addEventListener("click", () => open("#modal-register"));
    $("#btn-create-open")?.addEventListener("click", () => open("#modal-create"));

    document.querySelectorAll("[data-close]")?.forEach(btn => {
        btn.addEventListener("click", () => close(btn.getAttribute("data-close")));
    });

    // 카테고리 필터 적용 (체크박스 선택값을 쿼리스트링으로 붙여 /clubs GET 이동)
    $("#btn-apply-categories")?.addEventListener("click", () => {
        const selected = Array.from(document.querySelectorAll(".cat-filter:checked")).map(i => i.value);
        const url = new URL(window.location.href);
        url.pathname = "/clubs";
        url.searchParams.delete("categoryFilter");
        selected.forEach(v => url.searchParams.append("categoryFilter", v));
        // 지역/키워드 유지
        const keep = ["regionDo","regionSi","keyword"];
        keep.forEach(k => {
            const el = document.getElementById(k);
            if (el && el.value) url.searchParams.set(k, el.value);
        });
        window.location.href = url.toString();
    });

    // region.js 를 쓰지 않는 환경에서도 기본적으로 시/군/구를 도에 따라 보이도록 간단 필터 (옵션)
    (function basicRegionFilter() {
        const doSel = document.getElementById("regionDo");
        const siSel = document.getElementById("regionSi");
        if (!doSel || !siSel) return;

        const original = Array.from(siSel.options).map(o => ({v:o.value, t:o.textContent}));
        const rebuild = () => {
            const doval = doSel.value;
            while (siSel.firstChild) siSel.removeChild(siSel.firstChild);
            const all = document.createElement("option");
            all.value = ""; all.textContent = "전체"; siSel.appendChild(all);
            original.forEach(o => {
                if (!o.v || !doval) { // 전체
                    const opt = document.createElement("option"); opt.value = o.v; opt.textContent = o.t; siSel.appendChild(opt);
                } else {
                    // 서버에서 regionSi만 받은 경우엔 필터 불가 → 모두 출력
                    const opt = document.createElement("option"); opt.value = o.v; opt.textContent = o.t; siSel.appendChild(opt);
                }
            });
        };
        doSel.addEventListener("change", rebuild);
    })();
</script>
</body>
</html>

<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title th:text="${post.title} + ' - ' + ${club.name}"></title>
    <link rel="stylesheet" th:href="@{/css/app.css}">
</head>
<body class="bg-deep"
      th:data-msg="${msg}"
      th:data-error="${error}"
      th:data-open-login="${openLogin}"
      th:data-open-register="${openRegister}">

<header class="topbar" th:replace="~{fragments/common :: topbar}"></header>

<div class="wrap">
    <aside class="sidebar" th:replace="~{fragments/common :: sidebar}"></aside>

    <main class="content">

        <div class="detail-card">
            <div th:replace="~{fragments/common :: club-tabs}"></div>
        </div>

        <div class="detail-card">
            <div class="post-detail-content" th:object="${post}">

                <div class="post-header">
                    <h1 th:text="*{title}"></h1>

                    <div class="post-meta">
                        <div class="author-display" style="display: flex; align-items: center; gap: 10px;">
                            <img th:if="*{author.imageUrl != null}" th:src="*{author.imageUrl}" class="profile-thumb-detail" alt="í”„ë¡œí•„">
                            <div th:unless="*{author.imageUrl != null}" class="profile-thumb-detail default-icon">ğŸ‘¤</div>

                            <div style="display: flex; flex-direction: column; line-height: 1.2;">
                                <span th:text="*{author.nickname}" style="font-weight: bold; font-size: 16px;">ì‘ì„±ìëª…</span>

                                <span class="badge-owner"
                                      th:if="${post.author.id == club.ownerId}"
                                      style="margin-left: 0; margin-top: 2px; font-size: 12px;">[ëª¨ì„ì¥]
                                </span>
                            </div>
                        </div>

                        <span class="meta-divider">|</span>
                        <span th:text="|ì‘ì„±ì¼: *{createdAt != null ? #temporals.format(createdAt, 'yyyy-MM-dd HH:mm') : 'ë‚ ì§œ ì—†ìŒ'}|"></span>
                    </div>
                </div>

                <div th:if="${!post.images.isEmpty()}" style="margin-bottom: 20px;">
                    <div th:each="img : ${post.images}" style="margin-bottom: 10px;">
                        <img th:src="${img.imageUrl}"
                             alt="ì²¨ë¶€ ì´ë¯¸ì§€"
                             style="max-width: 100%; border-radius: 8px; border: 1px solid #1a332c; cursor: grab;"
                             onclick="openImageViewer(this.src)">
                    </div>
                </div>

                <div class="post-content" th:text="*{content}">
                    ê²Œì‹œê¸€ ë‚´ìš©...
                </div>

                <div class="button-group" style="margin-top: 30px; border-top: 1px solid #1a332c; padding-top: 15px; display: flex; justify-content: flex-end; gap: 10px;">

                    <a th:href="@{/clubs/{clubId}/board(clubId=${club.id})}" class="btn">ëª©ë¡</a>

                    <th:block th:if="${session.LOGIN_USER_ID == post.author.id}">
                        <a th:href="@{/clubs/{clubId}/board/{postId}/edit(clubId=${club.id}, postId=${post.id})}" class="btn">ìˆ˜ì •</a>
                    </th:block>

                        <th:block th:if="${session.LOGIN_USER_ID == post.author.id or session.LOGIN_USER_ID == club.ownerId}">

                            <button type="button" class="btn btn-danger" onclick="openDeleteModal()">ì‚­ì œ</button>

                            <form id="deleteForm"
                                  th:action="@{/clubs/{clubId}/board/{postId}/delete(clubId=${post.club.id}, postId=${post.id})}"
                                  method="post" style="display:none;">
                            </form>
                    </th:block>
                </div>

            </div>
        </div>

        <div class="detail-card">
            <h3>ëŒ“ê¸€ ì‘ì„±</h3>
            <form th:action="@{/clubs/{clubId}/board/{postId}/comment(clubId=${club.id}, postId=${post.id})}"
                  th:object="${commentForm}" method="post">

                <div class="form-group">
                    <textarea th:field="*{content}"
                              rows="3"
                              maxlength="300"
                              placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš” (ìµœëŒ€ 300ì)"
                              style="resize: none; width: 100%;"
                              class="form-control"></textarea>
                    <div th:if="${#fields.hasErrors('content')}" th:errors="*{content}" class="error-message"></div>
                </div>

                <div style="text-align: right; margin-top: 10px;">
                    <button type="submit" class="btn primary">ëŒ“ê¸€ ë“±ë¡</button>
                </div>
            </form>
        </div>

        <div class="detail-card">
            <h3>ëŒ“ê¸€ <span th:text="${#lists.size(comments)}">0</span>ê°œ</h3>

            <div class="comment-list">
                <div th:if="${#lists.isEmpty(comments)}" style="color: #9ec8b8; padding: 20px 0; text-align: center;">
                    ì•„ì§ ì‘ì„±ëœ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.
                </div>

                <div class="comment-item" th:each="comment : ${comments}" th:object="${comment}">
                    <div class="comment-header">
                        <img th:if="*{author.imageUrl != null}" th:src="*{author.imageUrl}" class="profile-thumb-detail" alt="í”„ë¡œí•„">
                        <div th:unless="*{author.imageUrl != null}" class="profile-thumb-detail default-icon">ğŸ‘¤</div>

                        <div style="display: flex; flex-direction: column; margin-left: 8px;">
                            <strong th:text="*{author.nickname}">ë‹‰ë„¤ì„</strong>

                            <span class="badge-owner"
                                  th:if="${comment.author.id == club.ownerId}"
                                  style="margin-left: 0; font-size: 11px; margin-bottom: 2px;">[ëª¨ì„ì¥]
                            </span>

                            <span style="font-size: 0.8em; color: #9ec8b8;"
                                  th:text="*{createdAt != null ? #temporals.format(createdAt, 'yyyy-MM-dd HH:mm') : ''}">ë‚ ì§œ</span>
                        </div>
                    </div>

                    <div class="comment-content" th:text="*{content}">ë‚´ìš©</div>

                    <div class="comment-actions">
                        <a th:if="${session.LOGIN_USER_ID == comment.author.id}"
                           th:href="@{/clubs/{clubId}/board/{postId}/comment/{commentId}/edit(clubId=${club.id}, postId=${post.id}, commentId=*{id})}"
                           class="btn-comment-action">
                            ìˆ˜ì •
                        </a>

                        <button type="button"
                                class="btn-comment-action delete"
                                th:if="${session.LOGIN_USER_ID == comment.author.id or session.LOGIN_USER_ID == club.ownerId}"
                                th:onclick="|openCommentDeleteModal('${club.id}', '${post.id}', '${comment.id}')|">
                            ì‚­ì œ
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </main>
</div>

<div id="toast"
     th:if="${error != null or msg != null}"
     th:text="${error ?: msg}"
     class="toast show">
</div>

<div id="deleteModal" class="modal" style="display: none;">
    <div class="modal-card" style="text-align: center; width: 360px;">
        <h3 style="margin-top: 0; color: #e7f3ee;">ê²Œì‹œê¸€ ì‚­ì œ</h3>
        <p style="color: #b0c4de; margin: 20px 0;">
            ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br>
            ì‚­ì œëœ ê¸€ì€ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
        </p>
        <div style="display: flex; justify-content: center; gap: 10px;">
            <button type="button" class="btn" onclick="closeDeleteModal()">ì·¨ì†Œ</button>
            <button type="button" class="btn btn-danger" onclick="confirmDelete()">ì‚­ì œí•˜ê¸°</button>
        </div>
    </div>
</div>

<div id="commentDeleteModal" class="modal" style="display: none;">
    <div class="modal-card" style="text-align: center; width: 360px;">
        <h3 style="margin-top: 0; color: #e7f3ee;">ëŒ“ê¸€ ì‚­ì œ</h3>
        <p style="color: #b0c4de; margin: 20px 0;">
            ì •ë§ë¡œ ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?
        </p>
        <div style="display: flex; justify-content: center; gap: 10px;">
            <button type="button" class="btn" onclick="closeCommentDeleteModal()">ì·¨ì†Œ</button>

            <form id="commentDeleteForm" method="post">
                <button type="submit" class="btn btn-danger">ì‚­ì œí•˜ê¸°</button>
            </form>
        </div>
    </div>
</div>

<div th:replace="~{fragments/common :: modals}"></div>
<div th:replace="~{fragments/common :: scripts}"></div>

<script th:inline="javascript">

    const toast = document.getElementById('toast');
    if (toast) {
        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    }

    function openDeleteModal() {
        document.getElementById('deleteModal').style.display = 'flex';
    }
    function closeDeleteModal() {
        document.getElementById('deleteModal').style.display = 'none';
    }
    function confirmDelete() {
        document.getElementById('deleteForm').submit();
    }

    function openCommentDeleteModal(clubId, postId, commentId) {
        const form = document.getElementById('commentDeleteForm');

        form.action = `/clubs/${clubId}/board/${postId}/comment/${commentId}/delete`;

        document.getElementById('commentDeleteModal').style.display = 'flex';
    }

    function closeCommentDeleteModal() {
        document.getElementById('commentDeleteModal').style.display = 'none';
    }

    window.addEventListener('click', function(event) {
        const postModal = document.getElementById('deleteModal');
        const commentModal = document.getElementById('commentDeleteModal');

        if (event.target === postModal) closeDeleteModal();
        if (event.target === commentModal) closeCommentDeleteModal();
    });
</script>

<div id="imageViewer" class="image-viewer-overlay" onclick="closeImageViewer()">
    <span class="viewer-close-btn">&times;</span>
    <img id="viewerImage" class="viewer-image" src="" alt="í™•ëŒ€ ì´ë¯¸ì§€" onclick="event.stopPropagation()">
</div>

<script>
    // ìƒíƒœ ë³€ìˆ˜ë“¤
    let currentScale = 1; // í˜„ì¬ ë°°ìœ¨
    let currentX = 0;     // í˜„ì¬ X ìœ„ì¹˜ (ì´ë™ ê±°ë¦¬)
    let currentY = 0;     // í˜„ì¬ Y ìœ„ì¹˜ (ì´ë™ ê±°ë¦¬)

    // ë“œë˜ê·¸ ê´€ë ¨ ë³€ìˆ˜
    let isDragging = false;
    let startX = 0;
    let startY = 0;

    const viewer = document.getElementById('imageViewer');
    const img = document.getElementById('viewerImage');

    // ë¸Œë¼ìš°ì €ì˜ ê³ ìœ  ì´ë¯¸ì§€ ë“œë˜ê·¸ (ë³µì‚¬) ê¸°ëŠ¥ ì°¨ë‹¨
    img.ondragstart = function() { return false; };

    // ë·°ì–´ ì—´ê¸° (ì—´ ë•Œë§ˆë‹¤ ìƒíƒœ ì´ˆê¸°í™”)
    function openImageViewer(src) {
        img.src = src;
        viewer.style.display = 'flex';
        document.body.style.overflow = 'hidden'; // ë’·ë°°ê²½ ìŠ¤í¬ë¡¤ ë°©ì§€

        // ì—´ ë•Œë§ˆë‹¤ ìœ„ì¹˜ì™€ ë°°ìœ¨ì„ 0, 1ë¡œ ë¦¬ì…‹
        currentScale = 1;
        currentX = 0;
        currentY = 0;
        img.style.cursor = 'grab';
        updateTransform();
    }

    // ë·°ì–´ ë‹«ê¸°
    function closeImageViewer() {
        viewer.style.display = 'none';
        document.body.style.overflow = 'auto'; // ìŠ¤í¬ë¡¤ í—ˆìš©
    }

    // CSS ë³€í˜• ì ìš© í•¨ìˆ˜ (í™•ëŒ€ + ì´ë™ ë™ì‹œ ì ìš©)
    function updateTransform() {
        img.style.transform = `translate(${currentX}px, ${currentY}px) scale(${currentScale})`;
    }

    // ë§ˆìš°ìŠ¤ ëˆŒë €ì„ ë•Œ (ì‹œì‘)
    img.addEventListener('mousedown', function(e) {
        e.preventDefault();
        isDragging = true;
        startX = e.clientX - currentX;
        startY = e.clientY - currentY;

        img.style.cursor = 'grabbing';
    });

    // ë§ˆìš°ìŠ¤ ì›€ì§ì¼ ë•Œ (ì´ë™)
    window.addEventListener('mousemove', function(e) {
        if (!isDragging) return;
        e.preventDefault();
        currentX = e.clientX - startX;
        currentY = e.clientY - startY;

        updateTransform();
    });

    // ë§ˆìš°ìŠ¤ ë—ì„ ë•Œ (ì¢…ë£Œ)
    window.addEventListener('mouseup', function() {
        if (isDragging) {
            isDragging = false;
            img.style.cursor = 'grab';
        }
    });

    viewer.addEventListener('wheel', function(event) {
        event.preventDefault();

        if (event.deltaY < 0) {
            currentScale += 0.1;
        } else {
            currentScale -= 0.1;
        }

        // ë°°ìœ¨ ì œí•œ (0.5ë°° ~ 5ë°°)
        if (currentScale < 0.5) currentScale = 0.5;
        if (currentScale > 5.0) currentScale = 5.0;

        updateTransform();
    }, { passive: false });

</script>

</body>
</html>
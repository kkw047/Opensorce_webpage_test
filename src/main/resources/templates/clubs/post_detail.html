<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title th:text="${post.title} + ' - ' + ${club.name}"></title>
    <link rel="stylesheet" th:href="@{/css/app.css}">
</head>
<body class="bg-deep"
      th:data-msg="${msg}"
      th:data-error="${error}"
      th:data-open-login="${openLogin}"
      th:data-open-register="${openRegister}">

<header class="topbar" th:replace="~{fragments/common :: topbar}"></header>

<div class="wrap">
    <aside class="sidebar" th:replace="~{fragments/common :: sidebar}"></aside>

    <main class="content">

        <div class="detail-card">
            <div th:replace="~{fragments/common :: club-tabs}"></div>
        </div>

        <div class="detail-card">
            <div class="post-detail-content" th:object="${post}">

                <div class="post-header">
                    <h1 th:text="*{title}"></h1>

                    <div class="post-meta">
                        <div class="author-display">
                            <img th:if="*{author.imageUrl != null}" th:src="*{author.imageUrl}" class="profile-thumb-detail" alt="í”„ë¡œí•„">
                            <div th:unless="*{author.imageUrl != null}" class="profile-thumb-detail default-icon">ğŸ‘¤</div>
                            <span th:text="*{author.nickname}">ì‘ì„±ìëª…</span>
                        </div>

                        <span class="meta-divider">|</span>
                        <span th:text="|ì‘ì„±ì¼: *{createdAt != null ? #temporals.format(createdAt, 'yyyy-MM-dd HH:mm') : 'ë‚ ì§œ ì—†ìŒ'}|"></span>
                    </div>
                </div>

                <div class="post-content" th:text="*{content}">
                    ê²Œì‹œê¸€ ë‚´ìš©...
                </div>

                <div class="button-group" style="margin-top: 30px; border-top: 1px solid #1a332c; padding-top: 15px; display: flex; justify-content: flex-end; gap: 10px;">

                    <a th:href="@{/clubs/{clubId}/board(clubId=${club.id})}" class="btn">ëª©ë¡</a>

                    <th:block th:if="${session.LOGIN_USER_ID == post.author.id}">
                        <a th:href="@{/clubs/{clubId}/board/{postId}/edit(clubId=${club.id}, postId=${post.id})}" class="btn">ìˆ˜ì •</a>

                        <button type="button" class="btn btn-danger" onclick="openDeleteModal()">ì‚­ì œ</button>

                        <form id="deleteForm"
                              th:action="@{/clubs/{clubId}/board/{postId}/delete(clubId=${post.club.id}, postId=${post.id})}"
                              method="post" style="display:none;">
                        </form>
                    </th:block>
                </div>

            </div>
        </div>

        <div class="detail-card">
            <h3>ëŒ“ê¸€ ì‘ì„±</h3>
            <form th:action="@{/clubs/{clubId}/board/{postId}/comment(clubId=${club.id}, postId=${post.id})}"
                  th:object="${commentForm}" method="post">

                <div class="form-group">
                    <textarea th:field="*{content}"
                              rows="3"
                              maxlength="300"
                              placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš” (ìµœëŒ€ 300ì)"
                              style="resize: none; width: 100%;"
                              class="form-control"></textarea>
                    <div th:if="${#fields.hasErrors('content')}" th:errors="*{content}" class="error-message"></div>
                </div>

                <div style="text-align: right; margin-top: 10px;">
                    <button type="submit" class="btn primary">ëŒ“ê¸€ ë“±ë¡</button>
                </div>
            </form>
        </div>

        <div class="detail-card">
            <h3>ëŒ“ê¸€ <span th:text="${#lists.size(comments)}">0</span>ê°œ</h3>

            <div class="comment-list">
                <div th:if="${#lists.isEmpty(comments)}" style="color: #9ec8b8; padding: 20px 0; text-align: center;">
                    ì•„ì§ ì‘ì„±ëœ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.
                </div>

                <div class="comment-item" th:each="comment : ${comments}" th:object="${comment}">
                    <div class="comment-header">
                        <img th:if="*{author.imageUrl != null}" th:src="*{author.imageUrl}" class="profile-thumb-detail" alt="í”„ë¡œí•„">
                        <div th:unless="*{author.imageUrl != null}" class="profile-thumb-detail default-icon">ğŸ‘¤</div>

                        <strong th:text="*{author.nickname}">ë‹‰ë„¤ì„</strong>
                        <span style="font-size: 0.8em; color: #555;">â€¢</span>
                        <span style="font-size: 0.8em; color: #9ec8b8;"
                              th:text="*{createdAt != null ? #temporals.format(createdAt, 'yyyy-MM-dd HH:mm') : ''}">ë‚ ì§œ</span>
                    </div>

                    <div class="comment-content" th:text="*{content}">ë‚´ìš©</div>

                    <div class="comment-actions">
                        <th:block th:if="${session.LOGIN_USER_ID == comment.author.id}">
                            <a th:href="@{/clubs/{clubId}/board/{postId}/comment/{commentId}/edit(clubId=${club.id}, postId=${post.id}, commentId=*{id})}"
                               class="btn-comment-action">ìˆ˜ì •</a>

                            <button type="button"
                                    class="btn-comment-action delete"
                                    th:onclick="|openCommentDeleteModal('${club.id}', '${post.id}', '${comment.id}')|">
                                ì‚­ì œ
                            </button>
                        </th:block>
                    </div>
                </div>
            </div>
        </div>

    </main>
</div>

<div id="toast"
     th:if="${error != null or msg != null}"
     th:text="${error ?: msg}"
     class="toast show">
</div>

<div id="deleteModal" class="modal" style="display: none;">
    <div class="modal-card" style="text-align: center; width: 360px;">
        <h3 style="margin-top: 0; color: #e7f3ee;">ê²Œì‹œê¸€ ì‚­ì œ</h3>
        <p style="color: #b0c4de; margin: 20px 0;">
            ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br>
            ì‚­ì œëœ ê¸€ì€ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
        </p>
        <div style="display: flex; justify-content: center; gap: 10px;">
            <button type="button" class="btn" onclick="closeDeleteModal()">ì·¨ì†Œ</button>
            <button type="button" class="btn btn-danger" onclick="confirmDelete()">ì‚­ì œí•˜ê¸°</button>
        </div>
    </div>
</div>

<div id="commentDeleteModal" class="modal" style="display: none;">
    <div class="modal-card" style="text-align: center; width: 360px;">
        <h3 style="margin-top: 0; color: #e7f3ee;">ëŒ“ê¸€ ì‚­ì œ</h3>
        <p style="color: #b0c4de; margin: 20px 0;">
            ì •ë§ë¡œ ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?
        </p>
        <div style="display: flex; justify-content: center; gap: 10px;">
            <button type="button" class="btn" onclick="closeCommentDeleteModal()">ì·¨ì†Œ</button>

            <form id="commentDeleteForm" method="post">
                <button type="submit" class="btn btn-danger">ì‚­ì œí•˜ê¸°</button>
            </form>
        </div>
    </div>
</div>

<div th:replace="~{fragments/common :: modals}"></div>
<div th:replace="~{fragments/common :: scripts}"></div>

<script th:inline="javascript">

    const toast = document.getElementById('toast');
    if (toast) {
        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    }

    function openDeleteModal() {
        document.getElementById('deleteModal').style.display = 'flex';
    }
    function closeDeleteModal() {
        document.getElementById('deleteModal').style.display = 'none';
    }
    function confirmDelete() {
        document.getElementById('deleteForm').submit();
    }

    function openCommentDeleteModal(clubId, postId, commentId) {
        const form = document.getElementById('commentDeleteForm');

        form.action = `/clubs/${clubId}/board/${postId}/comment/${commentId}/delete`;

        document.getElementById('commentDeleteModal').style.display = 'flex';
    }

    function closeCommentDeleteModal() {
        document.getElementById('commentDeleteModal').style.display = 'none';
    }

    window.addEventListener('click', function(event) {
        const postModal = document.getElementById('deleteModal');
        const commentModal = document.getElementById('commentDeleteModal');

        if (event.target === postModal) closeDeleteModal();
        if (event.target === commentModal) closeCommentDeleteModal();
    });
</script>

</body>
</html>
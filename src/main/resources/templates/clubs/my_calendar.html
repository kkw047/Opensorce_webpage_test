<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>나의 캘린더</title>
    <link rel="stylesheet" th:href="@{/css/app.css}">

    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script>

    <style>


        #calendar {
            width: 100%;
            font-family: 'Pretendard', sans-serif;
        }

        /* [긴급 수정] 요일 헤더 배경색 */
        .fc-theme-standard th { background-color: #1a2623 !important; border-color: #4a635d !important; }
        .fc-scrollgrid-section-header th { background-color: #1a2623 !important; }

        /* [3] 캘린더 색상 */
        .fc-col-header-cell-cushion, .fc-daygrid-day-number { color: #ffffff; text-decoration: none; }
        .fc-col-header-cell-cushion { font-size: 1.1em; font-weight: 800; padding: 10px 0; }
        .fc-daygrid-day-number { font-weight: 700; padding: 8px; opacity: 0.9; }

        .fc-day-sat .fc-col-header-cell-cushion, .fc-day-sat .fc-daygrid-day-number { color: #4fc3f7 !important; }
        .fc-day-sun .fc-col-header-cell-cushion, .fc-day-sun .fc-daygrid-day-number { color: #ff5252 !important; }

        .fc-theme-standard .fc-scrollgrid, .fc-theme-standard td, .fc-theme-standard th,
        .fc-col-header-cell, .fc-daygrid-day, .fc-daygrid-day-frame, .fc-scrollgrid-sync-table { border-color: #4a635d !important; }

        /* 오늘 날짜 강조 */
        .fc-day-today { background-color: rgba(255, 255, 255, 0.08) !important; border: 2px solid #26a69a !important; }
        .fc-daygrid-day:hover { background-color: rgba(255, 255, 255, 0.03); transition: background-color 0.2s; }

        /* [4] 상단 툴바 */
        .fc-header-toolbar { position: relative; margin-bottom: 20px !important; }
        .fc-toolbar-chunk:nth-child(2) { position: absolute; left: 50%; transform: translateX(-50%); display: flex; justify-content: center; }
        .fc-toolbar-title { color: #fff; font-size: 2em !important; font-weight: 900 !important; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }

        /* [5] 버튼 스타일 */
        .fc-button { background-color: #2a3b37 !important; border: 1px solid #4a635d !important; color: #fff !important; font-weight: bold; border-radius: 8px !important; padding: 8px 16px !important; }
        .fc-button:hover { background-color: #3e524d !important; border-color: #fff !important; }

        /* [6] 일정 막대 슬림하게 */
        .fc-event { border: none; border-radius: 3px; padding: 1px 3px !important; margin-bottom: 1px !important; font-size: 0.85em !important; font-weight: 700; cursor: pointer; box-shadow: 0 1px 2px rgba(0,0,0,0.2); line-height: 1.2 !important; }

        /* [7] 팝업 모드 스타일 (상세 조회용) */
        #scheduleDetailModal {
            position: fixed; /* 화면 기준 배치 (좌표 계산하여 이동) */
            z-index: 1000;   /* 캘린더보다 위에 */
            width: auto;     /* 전체 화면 덮지 않음 */
            height: auto;
            background: transparent; /* 배경 투명 */
            pointer-events: none; /* 팝업 영역 외에는 클릭 통과 */
            display: none;
        }

        #scheduleDetailModal:not(.hidden) { display: block; }

        /* 팝업 내부 카드 */
        #scheduleDetailModal .modal-content {
            pointer-events: auto;
            width: 450px;         /* [변경] 너비를 350px -> 450px로 넓힘 */
            max-height: 800px;    /* [변경] 최대 높이를 600px -> 800px로 높임 */
            background: #0f231e;
            padding: 25px;        /* 내부 여백도 살짝 키움 */
            border-radius: 12px;
            border: 1px solid #4a635d;
            box-shadow: 0 15px 40px rgba(0,0,0,0.9);
            position: relative;
            animation: popIn 0.2s ease-out;
        }
        @keyframes popIn {
            from { opacity: 0; transform: translateY(5px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        /* [8] 일반 모달 스타일 (커스텀 확인창용) */
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1100; }
        .modal-content-center { min-width: 350px; max-width: 400px; background: #0f231e; padding: 25px; border-radius: 16px; border: 1px solid #4a635d; box-shadow: 0 10px 25px rgba(0,0,0,0.5); position: relative; text-align: center; }

        .modal-close-btn { position: absolute; top: 15px; right: 20px; background: none; border: none; font-size: 24px; color: #888; cursor: pointer; transition: color 0.2s; line-height: 1; z-index: 10; }
        .modal-close-btn:hover { color: #ff5252; }
        .hidden { display: none !important; }

        /* [9] 버튼 그룹 */
        .modal-actions { display: flex; justify-content: flex-end; margin-top: 20px; }
        .btn-danger { background-color: #e53935; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 0.9em; }
        .btn-secondary { background-color: #757575; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; margin-right: 5px; font-size: 0.9em; }
        .btn-primary { background-color: #26a69a; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 0.9em; }

        /* [10] 참가자 목록 스타일 */
        .participant-item { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; border-bottom: 1px solid #4a635d; color: #ddd; font-size: 0.9em; }
        .status-ACCEPTED { color: #4caf50; font-weight: bold; } .status-PENDING { color: #ffb74d; } .status-REJECTED { color: #e57373; }

        /* [11] 카드 디자인 */
        .detail-card { border: 1px solid #1a332c; border-radius: 14px; background: #0f231e; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

        /* [12] 스크롤바 커스텀 */
        textarea::-webkit-scrollbar, .detail-box::-webkit-scrollbar { width: 8px; }
        textarea::-webkit-scrollbar-track, .detail-box::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.1); border-radius: 4px; }
        textarea::-webkit-scrollbar-thumb, .detail-box::-webkit-scrollbar-thumb { background-color: #4a635d; border-radius: 4px; }
        textarea::-webkit-scrollbar-thumb:hover, .detail-box::-webkit-scrollbar-thumb:hover { background-color: #26a69a; }

        /* [13] 상세내역 박스 (줄바꿈 및 스크롤) */
        .detail-box {
            width: 100%;
            min-height: 150px;    /* [변경] 최소 높이 80px -> 150px */
            max-height: 400px;    /* [변경] 스크롤 생기는 기준 200px -> 400px */
            overflow-y: auto;
            overflow-x: hidden;
            background-color: #1a2623;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #4a635d;
            color: #bbb;
            margin-top: 5px;
            font-size: 0.95em;
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-all;
            box-sizing: border-box;
        }
        /* [14] 더보기 링크 & 팝업 */
        .fc-more-link { color: #ddd !important; font-size: 0.8em !important; font-weight: bold; text-decoration: none; }
        .fc-more-link:hover { color: #fff !important; background-color: rgba(255,255,255,0.1); border-radius: 4px; }
        .fc-popover { background-color: #1a2623 !important; border: 1px solid #4a635d !important; box-shadow: 0 4px 15px rgba(0,0,0,0.5) !important; z-index: 9999 !important; }
        .fc-popover-header { background-color: #0f231e !important; color: #fff !important; font-weight: bold; }
        .fc-popover-body { background-color: #1a2623 !important; }
    </style>
</head>
<body class="bg-deep">

<header class="topbar" th:replace="~{fragments/common :: topbar}"></header>

<div class="wrap">
    <aside class="sidebar" th:replace="~{fragments/common :: sidebar}"></aside>
    <main class="content">
        <div class="detail-card">
            <h2 style="color: #fff; margin: 0; font-weight: 900;"> 나의 캘린더 </h2>
        </div>

        <div class="detail-card">
            <div id='calendar'></div>
        </div>
    </main>
</div>

<div th:replace="~{fragments/common :: modals}"></div>

<div id="scheduleDetailModal" class="hidden">
    <div class="modal-content">
        <button onclick="hideDetailModal()" class="modal-close-btn" type="button">&times;</button>
        <h3 id="modal-title" style="margin: 0 0 15px 0; color: #fff; padding-right: 20px; font-size: 1.2em;">일정 제목</h3>

        <div style="font-size: 0.9em; color: #ccc; margin-bottom: 10px;">
            <p style="margin: 3px 0;"><span style="color:#888; margin-right:5px;">일시</span> <span id="modal-date" style="color: #fff;"></span></p>
            <p style="margin: 3px 0;"><span style="color:#888; margin-right:5px;">비용</span> <span id="modal-fee" style="color: #fff;"></span></p>
        </div>

        <div id="modal-details" class="detail-box"></div>

        <div id="club-event-area" class="hidden" style="margin-top: 15px;">
            <p style="color: #81c784; font-weight: bold; font-size: 0.9em; margin-bottom: 5px;"> 참여 현황 (<span id="modal-participant-count">0</span>명)</p>
            <div id="modal-participant-list" style="max-height: 120px; overflow-y: auto; padding: 5px; background: #13201d; border-radius: 6px;"></div>
        </div>

        <div class="modal-actions">
            <button id="modal-link-btn" class="btn-secondary hidden">모임으로 이동</button>
            <button id="modal-delete-btn" class="btn-danger hidden">일정 삭제</button>
        </div>
    </div>
</div>

<div id="customConfirmModal" class="modal-backdrop hidden" style="z-index: 10000;">
    <div class="modal-content-center">
        <h3 style="color: #fff; margin-bottom: 15px; font-size: 1.2em;">알림</h3>
        <p id="confirmMessage" style="color: #ddd; margin-bottom: 25px; white-space: pre-wrap; line-height: 1.5;">진행하시겠습니까?</p>
        <div style="display: flex; justify-content: center; gap: 10px;">
            <button id="btnConfirmCancel" class="btn-secondary" style="width: 100px;">취소</button>
            <button id="btnConfirmOk" class="btn-primary" style="width: 100px;">확인</button>
        </div>
    </div>
</div>

<div th:replace="~{fragments/common :: scripts}"></div>

<script th:inline="javascript">
    /*<![CDATA[*/
    const sessionUserId = /*[[${session['LOGIN_USER_ID']}]]*/ null;
    /*]]>*/

    // 안전한 토스트 알림
    function safeShowToast(message, type) {
        if (typeof showToast === 'function') {
            showToast(message, type);
        } else {
            alert(message);
        }
    }

    // 일정 색상 팔레트
    const eventColors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEEAD', '#D4A5A5', '#9B59B6', '#3498DB', '#E67E22', '#2ECC71'];
    function getColorForEvent(id) {
        let hash = 0; const str = String(id);
        for (let i = 0; i < str.length; i++) { hash = str.charCodeAt(i) + ((hash << 5) - hash); }
        return eventColors[Math.abs(hash) % eventColors.length];
    }

    let calendar;
    let detailModal;

    function openLoginModal() {
        const loginModal = document.getElementById('loginModal');
        if (loginModal) loginModal.removeAttribute('hidden');
        else location.href = '/login';
    }

    // [커스텀 Confirm 함수]
    function openConfirm(message) {
        return new Promise((resolve) => {
            const modal = document.getElementById('customConfirmModal');
            const msgEl = document.getElementById('confirmMessage');
            const btnOk = document.getElementById('btnConfirmOk');
            const btnCancel = document.getElementById('btnConfirmCancel');

            msgEl.textContent = message;
            modal.classList.remove('hidden');

            const handleOk = () => {
                modal.classList.add('hidden');
                resolve(true);
            };
            const handleCancel = () => {
                modal.classList.add('hidden');
                resolve(false);
            };

            // 이벤트 리스너 덮어쓰기 (간단한 중복 방지)
            btnOk.onclick = handleOk;
            btnCancel.onclick = handleCancel;
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        detailModal = document.getElementById('scheduleDetailModal');

        const calendarEl = document.getElementById('calendar');
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth', locale: 'ko', dayMaxEvents: true, aspectRatio: 2,
            // aspectRatio 삭제 (CSS height: auto로 제어)
            headerToolbar: { left: 'prev,next today', center: 'title', right: '' }, // 버튼 없음

            events: '/api/calendar/events', // 통합 일정 조회

            // [핵심] 출석(완료) 여부에 따른 색상 처리
            eventDidMount: function(info) {
                const isDone = info.event.extendedProps.isDone;

                if (isDone) {
                    // [완료된 일정] 어두운 회색 + 취소선 + 투명도
                    info.el.style.backgroundColor = '#2c2c2c';
                    info.el.style.borderColor = '#444';
                    info.el.style.color = '#888';
                    info.el.style.textDecoration = 'line-through';
                    info.el.style.opacity = '0.7';
                } else {
                    // [미완료] 고유 색상
                    const color = getColorForEvent(info.event.id);
                    info.el.style.backgroundColor = color;
                    info.el.style.borderColor = color;
                    info.el.style.color = '#222222';
                }
                info.el.style.fontWeight = '700';
            },

            // 클릭 시 팝업
            eventClick: function(info) { showScheduleDetailModal(info); }
        });
        calendar.render();

        // 팝업 바깥 클릭 시 닫기
        document.addEventListener('click', function(e) {
            if (!detailModal.classList.contains('hidden') &&
                !detailModal.querySelector('.modal-content').contains(e.target) &&
                !e.target.closest('.fc-event')) {
                hideDetailModal();
            }
        });
    });

    // --- 상세 팝업 (마우스 옆 위치) ---
    async function showScheduleDetailModal(info) {
        const scheduleId = info.event.id;
        const eventEl = info.el;
        const jsEvent = info.jsEvent;

        try {
            // 통합 캘린더는 clubId를 알 수 없으므로, info.event.extendedProps.clubId를 확인
            const clubId = info.event.extendedProps.clubId;

            let url;
            if (clubId) url = `/api/club/${clubId}/schedule/${scheduleId}`;
            else url = `/api/calendar/events/${scheduleId}`;

            const response = await fetch(url, { credentials: 'include' });

            // 로그인 체크
            if (response.status === 401) {
                safeShowToast('로그인이 필요한 서비스입니다.', 'error');
                openLoginModal();
                return;
            }

            if (!response.ok) throw new Error('일정 정보를 불러올 수 없습니다.');
            const dto = await response.json();

            // 데이터 바인딩
            document.getElementById('modal-title').textContent = dto.title;
            document.getElementById('modal-date').textContent = `${dto.start} ~ ${dto.end}`;
            document.getElementById('modal-fee').textContent = dto.fee || '-';
            document.getElementById('modal-details').textContent = dto.details ? dto.details : '(내용 없음)';

            // [추가] 출석/완료 버튼 처리
            const actionBtnGroup = document.querySelector('.modal-actions');

            // 기존 버튼 제거 (중복 방지)
            const oldBtn = document.getElementById('btn-toggle-done');
            if(oldBtn) oldBtn.remove();

            // 버튼 생성
            const doneBtn = document.createElement('button');
            doneBtn.id = 'btn-toggle-done';

            // 상태에 따른 버튼 디자인
            if (dto.isDone) {
                doneBtn.textContent = '출석 취소';
                doneBtn.className = 'btn-secondary'; // 회색
            } else {
                doneBtn.textContent = '출석 완료 ✔️';
                doneBtn.className = 'btn-primary';   // 녹색
                doneBtn.style.backgroundColor = '#4caf50';
            }
            doneBtn.style.marginRight = 'auto'; // 왼쪽 정렬

            // 버튼 표시 조건: (개인 일정) OR (모임 일정이고 참가 승인된 상태)
            const showDoneBtn = (clubId == null) || (dto.isParticipating && dto.myStatus === 'ACCEPTED');

            if (showDoneBtn) {
                doneBtn.onclick = () => handleToggleDone(scheduleId, doneBtn);
                actionBtnGroup.prepend(doneBtn);
            }

            // 모임 정보 영역 처리 (통합 캘린더 전용)
            const clubArea = document.getElementById('club-event-area');
            const linkBtn = document.getElementById('modal-link-btn');

            if (clubId) {
                clubArea.classList.remove('hidden');
                linkBtn.classList.remove('hidden');
                linkBtn.onclick = () => location.href = `/clubs/${clubId}/calendar`;

                const list = document.getElementById('modal-participant-list');
                list.innerHTML = '';
                const participants = dto.participants || [];
                document.getElementById('modal-participant-count').textContent = participants.length;

                participants.forEach(p => {
                    const div = document.createElement('div');
                    div.className = 'participant-item';

                    // 출석 여부 텍스트 표시
                    let attendStatus = '';
                    if (dto.isAttendanceActive && p.status === 'ACCEPTED') {
                        if (p.isAttended) attendStatus = '<span style="color:#4caf50; margin-left:5px; font-weight:bold;">(출석)</span>';
                        else attendStatus = '<span style="color:#666; margin-left:5px;">(미출석)</span>';
                    }

                    let statusBadge = '';
                    if(p.status === 'ACCEPTED') statusBadge = '<span class="status-ACCEPTED">승인</span>';
                    else if(p.status === 'PENDING') statusBadge = '<span class="status-PENDING">대기</span>';
                    else statusBadge = '<span class="status-REJECTED">거절</span>';

                    div.innerHTML = `<span>${p.nickname} ${attendStatus}</span> ${statusBadge}`;
                    list.appendChild(div);
                });
            } else {
                clubArea.classList.add('hidden');
                linkBtn.classList.add('hidden');
            }

            // 삭제 버튼 (관리자만)
            const deleteBtn = document.getElementById('modal-delete-btn');
            if (dto.isManager) {
                deleteBtn.classList.remove('hidden');
                deleteBtn.onclick = () => handleDelete(scheduleId, clubId);
            } else {
                deleteBtn.classList.add('hidden');
            }

            // [핵심] 팝업 위치 계산 (마우스 기준)
            detailModal.classList.remove('hidden');
            const modalContent = detailModal.querySelector('.modal-content');
            const modalWidth = modalContent.offsetWidth;
            const modalHeight = modalContent.offsetHeight;
            const mouseX = jsEvent.clientX;
            const mouseY = jsEvent.clientY;

            let left = mouseX + 20;
            let top = mouseY + 10;

            if (left + modalWidth > window.innerWidth) left = mouseX - modalWidth - 20;
            if (top + modalHeight > window.innerHeight) top = window.innerHeight - modalHeight - 20;
            if (top < 10) top = 10;
            if (left < 10) left = 10;

            detailModal.style.top = `${top}px`;
            detailModal.style.left = `${left}px`;

        } catch (err) {
            console.error(err);
            safeShowToast('오류: ' + err.message, 'error');
        }
    }

    function hideDetailModal() { detailModal.classList.add('hidden'); }

    // [수정] 출석 토글 함수 (에러 메시지 처리 강화)
    async function handleToggleDone(scheduleId, btn) {
        // 안전하게 Calendar API 사용 (Service에서 로직 처리됨)
        let url = `/api/calendar/events/${scheduleId}/done`;

        try {
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include'
            });

            // 1. 로그인 안 된 경우 (401)
            if (res.status === 401) {
                safeShowToast('로그인이 필요한 서비스입니다.', 'error');
                openLoginModal();
                return;
            }

            // 2. 성공한 경우 (200)
            if (res.ok) {
                const isDone = await res.json(); // true/false

                if (isDone) {
                    btn.textContent = '출석 취소';
                    btn.className = 'btn-secondary';
                    // 스타일 초기화
                    btn.style.backgroundColor = '';
                    safeShowToast('출석이 완료되었습니다', 'success');
                } else {
                    btn.textContent = '출석 체크';
                    btn.className = 'btn-primary';
                    btn.style.backgroundColor = '#4caf50';
                    safeShowToast('출석이 취소되었습니다.', 'success');
                }
                // 캘린더 색상 갱신
                calendar.refetchEvents();
            }
            // 3. 실패한 경우 (400 Bad Request 등) -> 서버 메시지 출력
            else {
                const errorMsg = await res.text();
                // 서버가 보낸 "아직 출석 체크가 시작되지 않았습니다." 메시지를 띄움
                safeShowToast(errorMsg, 'error');
            }
        } catch (e) {
            console.error(e);
            safeShowToast('서버 통신 중 오류가 발생했습니다.', 'error');
        }
    }

    // [수정] 삭제 -> 커스텀 팝업 사용
    async function handleDelete(id, clubId) {
        if(await openConfirm('정말로 이 일정을 삭제하시겠습니까?')) {
            let url;
            if (clubId) url = `/api/club/${clubId}/schedule/${id}`;
            else url = `/api/calendar/events/${id}`;

            try {
                const opt = { method: 'DELETE', headers: { 'Content-Type': 'application/json' }, credentials: 'include' };
                const res = await fetch(url, opt);
                if(!res.ok) throw new Error('삭제 실패');

                safeShowToast('일정이 삭제되었습니다.', 'success');
                hideDetailModal();
                calendar.refetchEvents();
            } catch(e) {
                safeShowToast(e.message, 'error');
            }
        }
    }
</script>
</body>
</html>
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë‚˜ì˜ ìº˜ë¦°ë”</title>
    <link rel="stylesheet" th:href="@{/css/app.css}">

    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script>

    <style>
        .content {
            flex: 1;
            min-width: 0; /* ê°€ë¡œ ìŠ¤í¬ë¡¤ ë„˜ì¹¨ ë°©ì§€ */
            padding-right: 20px;
        }

        /* [2] ìº˜ë¦°ë” ë ˆì´ì•„ì›ƒ & í°íŠ¸ */
        #calendar {
            height: auto;          /* ë†’ì´ ìë™ ì¡°ì ˆ */
            min-height: 800px;     /* ìµœì†Œ ë†’ì´ ìœ ì§€ */
            font-family: 'Pretendard', sans-serif;
        }

        /* [ê¸´ê¸‰ ìˆ˜ì •] ìš”ì¼ í—¤ë” ë°°ê²½ìƒ‰ */
        .fc-theme-standard th { background-color: #1a2623 !important; border-color: #4a635d !important; }
        .fc-scrollgrid-section-header th { background-color: #1a2623 !important; }

        /* [3] ìº˜ë¦°ë” ìƒ‰ìƒ */
        .fc-col-header-cell-cushion, .fc-daygrid-day-number { color: #ffffff; text-decoration: none; }
        .fc-col-header-cell-cushion { font-size: 1.1em; font-weight: 800; padding: 10px 0; }
        .fc-daygrid-day-number { font-weight: 700; padding: 8px; opacity: 0.9; }

        .fc-day-sat .fc-col-header-cell-cushion, .fc-day-sat .fc-daygrid-day-number { color: #4fc3f7 !important; }
        .fc-day-sun .fc-col-header-cell-cushion, .fc-day-sun .fc-daygrid-day-number { color: #ff5252 !important; }

        .fc-theme-standard .fc-scrollgrid, .fc-theme-standard td, .fc-theme-standard th,
        .fc-col-header-cell, .fc-daygrid-day, .fc-daygrid-day-frame, .fc-scrollgrid-sync-table { border-color: #4a635d !important; }

        /* ì˜¤ëŠ˜ ë‚ ì§œ ê°•ì¡° */
        .fc-day-today { background-color: rgba(255, 255, 255, 0.08) !important; border: 2px solid #26a69a !important; }
        .fc-daygrid-day:hover { background-color: rgba(255, 255, 255, 0.03); transition: background-color 0.2s; }

        /* [4] ìƒë‹¨ íˆ´ë°” */
        .fc-header-toolbar { position: relative; margin-bottom: 20px !important; }
        .fc-toolbar-chunk:nth-child(2) { position: absolute; left: 50%; transform: translateX(-50%); display: flex; justify-content: center; }
        .fc-toolbar-title { color: #fff; font-size: 2em !important; font-weight: 900 !important; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }

        /* [5] ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .fc-button { background-color: #2a3b37 !important; border: 1px solid #4a635d !important; color: #fff !important; font-weight: bold; border-radius: 8px !important; padding: 8px 16px !important; }
        .fc-button:hover { background-color: #3e524d !important; border-color: #fff !important; }

        /* [6] ì¼ì • ë§‰ëŒ€ ìŠ¬ë¦¼í•˜ê²Œ */
        .fc-event { border: none; border-radius: 3px; padding: 1px 3px !important; margin-bottom: 1px !important; font-size: 0.85em !important; font-weight: 700; cursor: pointer; box-shadow: 0 1px 2px rgba(0,0,0,0.2); line-height: 1.2 !important; }

        /* [7] íŒì—… ëª¨ë“œ ìŠ¤íƒ€ì¼ (ìƒì„¸ ì¡°íšŒìš©) */
        #scheduleDetailModal {
            position: fixed; /* í™”ë©´ ê¸°ì¤€ ë°°ì¹˜ (ì¢Œí‘œ ê³„ì‚°í•˜ì—¬ ì´ë™) */
            z-index: 1000;   /* ìº˜ë¦°ë”ë³´ë‹¤ ìœ„ì— */
            width: auto;     /* ì „ì²´ í™”ë©´ ë®ì§€ ì•ŠìŒ */
            height: auto;
            background: transparent; /* ë°°ê²½ íˆ¬ëª… */
            pointer-events: none; /* íŒì—… ì˜ì—­ ì™¸ì—ëŠ” í´ë¦­ í†µê³¼ */
            display: none;
        }

        #scheduleDetailModal:not(.hidden) { display: block; }

        /* íŒì—… ë‚´ë¶€ ì¹´ë“œ */
        #scheduleDetailModal .modal-content {
            pointer-events: auto; /* ë‚´ìš©ë¬¼ì€ í´ë¦­ ê°€ëŠ¥ */
            width: 350px;         /* ë„ˆë¹„ ê³ ì • */
            max-height: 600px;    /* ë†’ì´ ì œí•œ */
            background: #0f231e;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #4a635d;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8); /* ì§„í•œ ê·¸ë¦¼ì */
            position: relative;
            animation: popIn 0.2s ease-out;
        }

        @keyframes popIn {
            from { opacity: 0; transform: translateY(5px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        /* [8] ì¼ë°˜ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ (ì»¤ìŠ¤í…€ í™•ì¸ì°½ìš©) */
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1100; }
        .modal-content-center { min-width: 350px; max-width: 400px; background: #0f231e; padding: 25px; border-radius: 16px; border: 1px solid #4a635d; box-shadow: 0 10px 25px rgba(0,0,0,0.5); position: relative; text-align: center; }

        .modal-close-btn { position: absolute; top: 15px; right: 20px; background: none; border: none; font-size: 24px; color: #888; cursor: pointer; transition: color 0.2s; line-height: 1; z-index: 10; }
        .modal-close-btn:hover { color: #ff5252; }
        .hidden { display: none !important; }

        /* [9] ë²„íŠ¼ ê·¸ë£¹ */
        .modal-actions { display: flex; justify-content: flex-end; margin-top: 20px; }
        .btn-danger { background-color: #e53935; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 0.9em; }
        .btn-secondary { background-color: #757575; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; margin-right: 5px; font-size: 0.9em; }
        .btn-primary { background-color: #26a69a; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 0.9em; }

        /* [10] ì°¸ê°€ì ëª©ë¡ ìŠ¤íƒ€ì¼ */
        .participant-item { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; border-bottom: 1px solid #4a635d; color: #ddd; font-size: 0.9em; }
        .status-ACCEPTED { color: #4caf50; font-weight: bold; } .status-PENDING { color: #ffb74d; } .status-REJECTED { color: #e57373; }

        /* [11] ì¹´ë“œ ë””ìì¸ */
        .detail-card { border: 1px solid #1a332c; border-radius: 14px; background: #0f231e; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

        /* [12] ìŠ¤í¬ë¡¤ë°” ì»¤ìŠ¤í…€ */
        textarea::-webkit-scrollbar, .detail-box::-webkit-scrollbar { width: 8px; }
        textarea::-webkit-scrollbar-track, .detail-box::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.1); border-radius: 4px; }
        textarea::-webkit-scrollbar-thumb, .detail-box::-webkit-scrollbar-thumb { background-color: #4a635d; border-radius: 4px; }
        textarea::-webkit-scrollbar-thumb:hover, .detail-box::-webkit-scrollbar-thumb:hover { background-color: #26a69a; }

        /* [13] ìƒì„¸ë‚´ì—­ ë°•ìŠ¤ (ì¤„ë°”ê¿ˆ ë° ìŠ¤í¬ë¡¤) */
        .detail-box { width: 100%; min-height: 100px; max-height: 300px; overflow-y: auto; overflow-x: hidden; background-color: #1a2623; padding: 15px; border-radius: 8px; border: 1px solid #4a635d; color: #bbb; margin-top: 5px; font-size: 0.9em; line-height: 1.6; white-space: pre-wrap; word-break: break-all; overflow-wrap: break-word; box-sizing: border-box; }

        /* [14] ë”ë³´ê¸° ë§í¬ & íŒì—… */
        .fc-more-link { color: #ddd !important; font-size: 0.8em !important; font-weight: bold; text-decoration: none; }
        .fc-more-link:hover { color: #fff !important; background-color: rgba(255,255,255,0.1); border-radius: 4px; }
        .fc-popover { background-color: #1a2623 !important; border: 1px solid #4a635d !important; box-shadow: 0 4px 15px rgba(0,0,0,0.5) !important; z-index: 9999 !important; }
        .fc-popover-header { background-color: #0f231e !important; color: #fff !important; font-weight: bold; }
        .fc-popover-body { background-color: #1a2623 !important; }
    </style>
</head>
<body class="bg-deep">

<header class="topbar" th:replace="~{fragments/common :: topbar}"></header>

<div class="wrap">
    <aside class="sidebar" th:replace="~{fragments/common :: sidebar}"></aside>
    <main class="content">
        <div class="detail-card">
            <h2 style="color: #fff; margin: 0; font-weight: 900;"> ë‚˜ì˜ ìº˜ë¦°ë” </h2>
        </div>

        <div class="detail-card">
            <div id='calendar'></div>
        </div>
    </main>
</div>

<div th:replace="~{fragments/common :: modals}"></div>

<div id="scheduleDetailModal" class="hidden">
    <div class="modal-content">
        <button onclick="hideDetailModal()" class="modal-close-btn" type="button">&times;</button>
        <h3 id="modal-title" style="margin: 0 0 15px 0; color: #fff; padding-right: 20px; font-size: 1.2em;">ì¼ì • ì œëª©</h3>

        <div style="font-size: 0.9em; color: #ccc; margin-bottom: 10px;">
            <p style="margin: 3px 0;"><span style="color:#888; margin-right:5px;">ì¼ì‹œ</span> <span id="modal-date" style="color: #fff;"></span></p>
            <p style="margin: 3px 0;"><span style="color:#888; margin-right:5px;">ë¹„ìš©</span> <span id="modal-fee" style="color: #fff;"></span></p>
        </div>

        <div id="modal-details" class="detail-box"></div>

        <div id="club-event-area" class="hidden" style="margin-top: 15px;">
            <p style="color: #81c784; font-weight: bold; font-size: 0.9em; margin-bottom: 5px;">ğŸ‘¥ ì°¸ì—¬ í˜„í™© (<span id="modal-participant-count">0</span>ëª…)</p>
            <div id="modal-participant-list" style="max-height: 120px; overflow-y: auto; padding: 5px; background: #13201d; border-radius: 6px;"></div>
        </div>

        <div class="modal-actions">
            <button id="modal-link-btn" class="btn-secondary hidden">ëª¨ì„ìœ¼ë¡œ ì´ë™</button>
            <button id="modal-delete-btn" class="btn-danger hidden">ì¼ì • ì‚­ì œ</button>
        </div>
    </div>
</div>

<div id="customConfirmModal" class="modal-backdrop hidden" style="z-index: 10000;">
    <div class="modal-content-center">
        <h3 style="color: #fff; margin-bottom: 15px; font-size: 1.2em;">ì•Œë¦¼</h3>
        <p id="confirmMessage" style="color: #ddd; margin-bottom: 25px; white-space: pre-wrap; line-height: 1.5;">ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
        <div style="display: flex; justify-content: center; gap: 10px;">
            <button id="btnConfirmCancel" class="btn-secondary" style="width: 100px;">ì·¨ì†Œ</button>
            <button id="btnConfirmOk" class="btn-primary" style="width: 100px;">í™•ì¸</button>
        </div>
    </div>
</div>

<div th:replace="~{fragments/common :: scripts}"></div>

<script th:inline="javascript">
    /*<![CDATA[*/
    const sessionUserId = /*[[${session['LOGIN_USER_ID']}]]*/ null;
    /*]]>*/

    function safeShowToast(message, type) {
        if (typeof showToast === 'function') {
            showToast(message, type);
        } else {
            alert(message);
        }
    }

    const eventColors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEEAD', '#D4A5A5', '#9B59B6', '#3498DB', '#E67E22', '#2ECC71'];
    function getColorForEvent(id) {
        let hash = 0; const str = String(id);
        for (let i = 0; i < str.length; i++) { hash = str.charCodeAt(i) + ((hash << 5) - hash); }
        return eventColors[Math.abs(hash) % eventColors.length];
    }

    let calendar;
    let detailModal;

    function openLoginModal() {
        const loginModal = document.getElementById('loginModal');
        if (loginModal) loginModal.removeAttribute('hidden');
        else location.href = '/login';
    }

    // [ì»¤ìŠ¤í…€ Confirm í•¨ìˆ˜]
    function openConfirm(message) {
        return new Promise((resolve) => {
            const modal = document.getElementById('customConfirmModal');
            const msgEl = document.getElementById('confirmMessage');
            const btnOk = document.getElementById('btnConfirmOk');
            const btnCancel = document.getElementById('btnConfirmCancel');

            msgEl.textContent = message;
            modal.classList.remove('hidden');

            const handleOk = () => {
                modal.classList.add('hidden');
                resolve(true);
            };
            const handleCancel = () => {
                modal.classList.add('hidden');
                resolve(false);
            };

            btnOk.onclick = handleOk;
            btnCancel.onclick = handleCancel;
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        detailModal = document.getElementById('scheduleDetailModal');

        const calendarEl = document.getElementById('calendar');
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth', locale: 'ko', height: 'auto', dayMaxEvents: true,
            headerToolbar: { left: 'prev,next today', center: 'title', right: '' }, // ë²„íŠ¼ ì—†ìŒ

            events: '/api/calendar/events', // í†µí•© ì¼ì • ì¡°íšŒ

            eventDidMount: function(info) {
                const color = getColorForEvent(info.event.id);
                info.el.style.backgroundColor = color;
                info.el.style.borderColor = color;
                info.el.style.color = '#222222';
                info.el.style.fontWeight = '700';
            },

            // [í•µì‹¬] í´ë¦­ ì‹œ ë§ˆìš°ìŠ¤ ìœ„ì¹˜ ê³„ì‚° í•¨ìˆ˜ í˜¸ì¶œ
            eventClick: function(info) { showScheduleDetailModal(info); }
        });
        calendar.render();

        // íŒì—… ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸°
        document.addEventListener('click', function(e) {
            if (!detailModal.classList.contains('hidden') &&
                !detailModal.querySelector('.modal-content').contains(e.target) &&
                !e.target.closest('.fc-event')) {
                hideDetailModal();
            }
        });
    });

    // --- ìƒì„¸ íŒì—… (ë§ˆìš°ìŠ¤ ìœ„ì¹˜ ê¸°ì¤€) ---
    async function showScheduleDetailModal(info) {
        const scheduleId = info.event.id;
        const eventEl = info.el;
        const jsEvent = info.jsEvent;

        try {
            // í†µí•© ìº˜ë¦°ë”ëŠ” clubIdë¥¼ ì•Œ ìˆ˜ ì—†ìœ¼ë¯€ë¡œ, info.event.extendedProps.clubIdë¥¼ í™•ì¸í•´ì•¼ í•¨
            const clubId = info.event.extendedProps.clubId;

            let url;
            if (clubId) url = `/api/club/${clubId}/schedule/${scheduleId}`;
            else url = `/api/calendar/events/${scheduleId}`;

            const response = await fetch(url, { credentials: 'include' });

            // ë¡œê·¸ì¸ ì²´í¬
            if (response.status === 401) {
                safeShowToast('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.', 'error');
                openLoginModal();
                return;
            }

            if (!response.ok) throw new Error('ì¼ì • ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            const dto = await response.json();

            // ë°ì´í„° ë°”ì¸ë”©
            document.getElementById('modal-title').textContent = dto.title;
            document.getElementById('modal-date').textContent = `${dto.start} ~ ${dto.end}`;
            document.getElementById('modal-fee').textContent = dto.fee || '-';
            document.getElementById('modal-details').textContent = dto.details ? dto.details : '(ìƒì„¸ ë‚´ìš© ì—†ìŒ)';

            const clubArea = document.getElementById('club-event-area');
            const linkBtn = document.getElementById('modal-link-btn');

            if (clubId) {
                clubArea.classList.remove('hidden');
                linkBtn.classList.remove('hidden');
                linkBtn.onclick = () => location.href = `/clubs/${clubId}/calendar`;

                const list = document.getElementById('modal-participant-list');
                list.innerHTML = '';
                const participants = dto.participants || [];
                document.getElementById('modal-participant-count').textContent = participants.length;

                participants.forEach(p => {
                    const div = document.createElement('div');
                    div.className = 'participant-item';
                    // ì—¬ê¸°ì„œëŠ” ë¦¬ìŠ¤íŠ¸ë§Œ ë³´ì—¬ì¤Œ (ìˆ˜ì •/ìŠ¹ì¸ì€ í•´ë‹¹ ëª¨ì„ ìº˜ë¦°ë”ì—ì„œ)
                    div.innerHTML = `<span>${p.nickname}</span> <span>${p.status === 'ACCEPTED' ? 'âœ…' : 'â³'}</span>`;
                    list.appendChild(div);
                });
            } else {
                clubArea.classList.add('hidden');
                linkBtn.classList.add('hidden');
            }

            // ì‚­ì œ ë²„íŠ¼ (ê´€ë¦¬ìë§Œ)
            const deleteBtn = document.getElementById('modal-delete-btn');
            if (dto.isManager) {
                deleteBtn.classList.remove('hidden');
                deleteBtn.onclick = () => handleDelete(scheduleId, clubId);
            } else {
                deleteBtn.classList.add('hidden');
            }

            // [í•µì‹¬] íŒì—… ìœ„ì¹˜ ê³„ì‚°
            detailModal.classList.remove('hidden');
            const modalContent = detailModal.querySelector('.modal-content');
            const modalWidth = 350;
            const modalHeight = modalContent.offsetHeight;
            const mouseX = jsEvent.clientX;
            const mouseY = jsEvent.clientY;

            // ê¸°ë³¸: ë§ˆìš°ìŠ¤ ì˜¤ë¥¸ìª½ 20px, ì•„ë˜ 10px
            let left = mouseX + 20;
            let top = mouseY + 10;

            // ì˜¤ë¥¸ìª½ í™”ë©´ ë„˜ì–´ê°€ë©´ ì™¼ìª½ìœ¼ë¡œ ì´ë™
            if (left + modalWidth > window.innerWidth) {
                left = mouseX - modalWidth - 20;
            }
            // ì•„ë˜ìª½ í™”ë©´ ë„˜ì–´ê°€ë©´ ìœ„ë¡œ ì´ë™
            if (top + modalHeight > window.innerHeight) {
                top = window.innerHeight - modalHeight - 20;
            }
            // ìœ„ìª½ë„ ì˜ë¦¬ë©´ ê³ ì •
            if (top < 10) top = 10;

            detailModal.style.top = `${top}px`;
            detailModal.style.left = `${left}px`;

        } catch (err) {
            console.error(err);
            safeShowToast('ì˜¤ë¥˜: ' + err.message, 'error');
        }
    }

    function hideDetailModal() { detailModal.classList.add('hidden'); }

    // [ìˆ˜ì •] ì‚­ì œ -> ì»¤ìŠ¤í…€ íŒì—… ì‚¬ìš©
    async function handleDelete(id, clubId) {
        if(await openConfirm('ì •ë§ë¡œ ì´ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            let url;
            if (clubId) url = `/api/club/${clubId}/schedule/${id}`;
            else url = `/api/calendar/events/${id}`;

            try {
                const opt = { method: 'DELETE', headers: { 'Content-Type': 'application/json' }, credentials: 'include' };
                const res = await fetch(url, opt);
                if(!res.ok) throw new Error('ì‚­ì œ ì‹¤íŒ¨');

                safeShowToast('ì¼ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                hideDetailModal();
                calendar.refetchEvents();
            } catch(e) {
                safeShowToast(e.message, 'error');
            }
        }
    }
</script>
</body>
</html>
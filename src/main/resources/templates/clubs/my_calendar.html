<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë‚˜ì˜ ìº˜ë¦°ë”</title>
    <link rel="stylesheet" th:href="@{/css/app.css}">

    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script>

    <style>
        /* [1] ìº˜ë¦°ë” ë ˆì´ì•„ì›ƒ & í°íŠ¸ */
        #calendar {
            height: auto;          /* ë†’ì´ ìë™ ì¡°ì ˆ */
            min-height: 800px;     /* ìµœì†Œ ë†’ì´ ìœ ì§€ */
            font-family: 'Pretendard', sans-serif;
        }

        /* [ê¸´ê¸‰ ìˆ˜ì •] ìš”ì¼ í—¤ë” ë°°ê²½ìƒ‰ */
        .fc-theme-standard th { background-color: #1a2623 !important; border-color: #4a635d !important; }
        .fc-scrollgrid-section-header th { background-color: #1a2623 !important; }

        /* [2] ìº˜ë¦°ë” ìƒ‰ìƒ */
        .fc-col-header-cell-cushion, .fc-daygrid-day-number { color: #ffffff; text-decoration: none; }
        .fc-col-header-cell-cushion { font-size: 1.1em; font-weight: 800; padding: 10px 0; }
        .fc-daygrid-day-number { font-weight: 700; padding: 8px; opacity: 0.9; }

        .fc-day-sat .fc-col-header-cell-cushion, .fc-day-sat .fc-daygrid-day-number { color: #4fc3f7 !important; }
        .fc-day-sun .fc-col-header-cell-cushion, .fc-day-sun .fc-daygrid-day-number { color: #ff5252 !important; }

        .fc-theme-standard .fc-scrollgrid, .fc-theme-standard td, .fc-theme-standard th,
        .fc-col-header-cell, .fc-daygrid-day, .fc-daygrid-day-frame, .fc-scrollgrid-sync-table { border-color: #4a635d !important; }

        /* ì˜¤ëŠ˜ ë‚ ì§œ ê°•ì¡° */
        .fc-day-today { background-color: rgba(255, 255, 255, 0.08) !important; border: 2px solid #26a69a !important; }
        .fc-daygrid-day:hover { background-color: rgba(255, 255, 255, 0.03); transition: background-color 0.2s; }

        /* [3] ìƒë‹¨ íˆ´ë°” */
        .fc-header-toolbar { position: relative; margin-bottom: 20px !important; }
        .fc-toolbar-chunk:nth-child(2) { position: absolute; left: 50%; transform: translateX(-50%); display: flex; justify-content: center; }
        .fc-toolbar-title { color: #fff; font-size: 2em !important; font-weight: 900 !important; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }

        /* [4] ë²„íŠ¼ & ì´ë²¤íŠ¸ */
        .fc-button { background-color: #2a3b37 !important; border: 1px solid #4a635d !important; color: #fff !important; font-weight: bold; border-radius: 8px !important; padding: 8px 16px !important; }
        .fc-button:hover { background-color: #3e524d !important; border-color: #fff !important; }

        /* [10] ì¼ì • ë§‰ëŒ€ ìŠ¬ë¦¼í•˜ê²Œ */
        .fc-event { border: none; border-radius: 3px; padding: 1px 3px !important; margin-bottom: 1px !important; font-size: 0.85em !important; font-weight: 700; cursor: pointer; box-shadow: 0 1px 2px rgba(0,0,0,0.2); line-height: 1.2 !important; }

        /* [5] ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { min-width: 400px; max-width: 500px; background: #0f231e; padding: 25px; border-radius: 16px; border: 1px solid #4a635d; box-shadow: 0 10px 25px rgba(0,0,0,0.5); position: relative; }

        .modal-close-btn { position: absolute; top: 15px; right: 20px; background: none; border: none; font-size: 32px; color: #888; cursor: pointer; transition: color 0.2s; line-height: 1; z-index: 10; }
        .modal-close-btn:hover { color: #ff5252; }
        .hidden { display: none !important; }

        /* í¼ ìš”ì†Œ */
        label { display: block; margin: 10px 0 5px; font-weight: bold; color: #ddd; }
        input[type=text], input[type=date], textarea { width: 95%; background: #2a3b37; color: #fff; border: 1px solid #4a635d; padding: 10px; border-radius: 6px; font-size: 1em; }
        textarea { resize: none; }

        /* Flatpickr */
        .flatpickr-calendar { background: #1a2623 !important; border: 1px solid #4a635d !important; box-shadow: 0 10px 25px rgba(0,0,0,0.7) !important; }
        .flatpickr-months .flatpickr-month, .flatpickr-current-month .flatpickr-monthDropdown-months { background: #1a2623 !important; color: #fff !important; fill: #fff !important; }
        .flatpickr-current-month input.cur-year { color: #fff !important; font-weight: bold !important; }
        .flatpickr-monthDropdown-months { background-color: #1a2623 !important; color: #fff !important; }
        .flatpickr-monthDropdown-months option { background-color: #0f231e; color: #fff; }
        .flatpickr-day { color: #eee !important; font-weight: 600 !important; }
        .flatpickr-day.selected { background: #26a69a !important; border-color: #26a69a !important; color: #fff !important; }
        .flatpickr-months .flatpickr-prev-month svg, .flatpickr-months .flatpickr-next-month svg { fill: #fff !important; }

        /* ë²„íŠ¼ ê·¸ë£¹ (ì–‘ìª½ ì •ë ¬) */
        .modal-actions { display: flex; justify-content: space-between; margin-top: 20px; }
        .btn-primary { background-color: #26a69a; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-danger { background-color: #e53935; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-secondary { background-color: #757575; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; margin-right: 10px; }

        /* ì°¸ê°€ì ëª©ë¡ */
        .participant-item { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; border-bottom: 1px solid #4a635d; color: #ddd; }
        .participant-status { font-size: 0.8em; padding: 2px 6px; border-radius: 4px; margin-left: 10px; }
        .status-ACCEPTED { background: #2e7d32; color: #fff; }
        .status-PENDING { background: #fbc02d; color: #000; }
        .status-REJECTED { background: #c62828; color: #fff; }

        .detail-card { border: 1px solid #1a332c; border-radius: 14px; background: #0f231e; padding: 16px; margin-bottom: 16px; }

        /* [8] ìŠ¤í¬ë¡¤ë°” ì»¤ìŠ¤í…€ */
        textarea::-webkit-scrollbar, .detail-box::-webkit-scrollbar { width: 8px; }
        textarea::-webkit-scrollbar-track, .detail-box::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.1); border-radius: 4px; }
        textarea::-webkit-scrollbar-thumb, .detail-box::-webkit-scrollbar-thumb { background-color: #4a635d; border-radius: 4px; }
        textarea::-webkit-scrollbar-thumb:hover, .detail-box::-webkit-scrollbar-thumb:hover { background-color: #26a69a; }

        /* [9] ìƒì„¸ë‚´ì—­ ë°•ìŠ¤ (ì¤„ë°”ê¿ˆ ê°•ì œ) */
        .detail-box { width: 100%; min-height: 100px; max-height: 300px; overflow-y: auto; overflow-x: hidden; background-color: #1a2623; padding: 15px; border-radius: 8px; border: 1px solid #4a635d; color: #bbb; margin-top: 5px; font-size: 0.95em; line-height: 1.6; white-space: pre-wrap; word-break: break-all; overflow-wrap: break-word; box-sizing: border-box; }

        /* [11] '+nê°œ ë”ë³´ê¸°' ë° íŒì—… */
        .fc-more-link { color: #ddd !important; font-size: 0.8em !important; font-weight: bold; text-decoration: none; }
        .fc-more-link:hover { color: #fff !important; background-color: rgba(255,255,255,0.1); border-radius: 4px; }
        .fc-popover { background-color: #1a2623 !important; border: 1px solid #4a635d !important; box-shadow: 0 4px 15px rgba(0,0,0,0.5) !important; z-index: 9999 !important; }
        .fc-popover-header { background-color: #0f231e !important; color: #fff !important; font-weight: bold; }
        .fc-popover-body { background-color: #1a2623 !important; }
    </style>
</head>
<body class="bg-deep">

<header class="topbar" th:replace="~{fragments/common :: topbar}"></header>

<div class="wrap">
    <aside class="sidebar" th:replace="~{fragments/common :: sidebar}"></aside>
    <main class="content">
        <div class="detail-card">
            <h2 style="color: #fff; margin: 0; font-weight: 900;"> ë‚˜ì˜ ìº˜ë¦°ë” </h2>
        </div>

        <div class="detail-card" style="background: #0f231e; padding: 20px; border-radius: 14px; border: 1px solid #4a635d; margin-top: 20px;">
            <div id='calendar'></div>
        </div>
    </main>
</div>

<div th:replace="~{fragments/common :: modals}"></div>

<div id="scheduleDetailModal" class="modal-backdrop hidden">
    <div class="modal-content">
        <button onclick="hideDetailModal()" class="modal-close-btn" type="button">&times;</button>
        <h2 id="modal-title" style="margin-top: 0; color: #fff; padding-right: 30px;">ì¼ì • ì œëª©</h2>
        <hr style="border-color: #4a635d; margin: 15px 0;">
        <p style="color: #ddd;"><strong>ë‚ ì§œ:</strong> <span id="modal-date" style="color: #fff;"></span></p>
        <p style="color: #ddd;"><strong>ì°¸ì—¬ë¹„:</strong> <span id="modal-fee" style="color: #fff;"></span></p>

        <p style="color: #ddd;"><strong>ìƒì„¸ë‚´ì—­:</strong></p>
        <div id="modal-details" class="detail-box"></div>

        <div id="club-event-area" class="hidden">
            <p style="margin-top: 15px; color: #81c784; font-weight: bold;">ğŸ‘‰ ëª¨ì„ ì¼ì •ì…ë‹ˆë‹¤.</p>
            <p style="color: #ddd; margin-top: 10px;"><strong>ì°¸ì—¬ í˜„í™© (<span id="modal-participant-count">0</span>ëª…)</strong></p>
            <div id="modal-participant-list" style="max-height: 150px; overflow-y: auto; padding: 5px; background: #1a2623; border-radius: 8px; border: 1px solid #2a3b37;"></div>
        </div>

        <hr style="border-color: #4a635d; margin: 20px 0;">
        <div class="modal-actions">
            <button id="modal-link-btn" class="btn-secondary hidden">ëª¨ì„ìœ¼ë¡œ ì´ë™</button>
            <button id="modal-delete-btn" class="btn-danger hidden">ì¼ì • ì‚­ì œ</button>
        </div>
    </div>
</div>

<div id="customConfirmModal" class="modal-backdrop hidden" style="z-index: 10000;">
    <div class="modal-content" style="max-width: 400px; text-align: center;">
        <h3 style="color: #fff; margin-bottom: 15px; font-size: 1.2em;">ì•Œë¦¼</h3>
        <p id="confirmMessage" style="color: #ddd; margin-bottom: 25px; white-space: pre-wrap; line-height: 1.5;">ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
        <div style="display: flex; justify-content: center; gap: 10px;">
            <button id="btnConfirmCancel" class="btn-secondary" style="width: 100px;">ì·¨ì†Œ</button>
            <button id="btnConfirmOk" class="btn-primary" style="width: 100px;">í™•ì¸</button>
        </div>
    </div>
</div>

<div th:replace="~{fragments/common :: scripts}"></div>

<script th:inline="javascript">
    /*<![CDATA[*/
    const sessionUserId = /*[[${session['LOGIN_USER_ID']}]]*/ null;
    /*]]>*/

    function safeShowToast(message, type) {
        if (typeof showToast === 'function') {
            showToast(message, type);
        } else {
            alert(message);
        }
    }

    const eventColors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEEAD', '#D4A5A5', '#9B59B6', '#3498DB', '#E67E22', '#2ECC71'];
    function getColorForEvent(id) {
        let hash = 0; const str = String(id);
        for (let i = 0; i < str.length; i++) { hash = str.charCodeAt(i) + ((hash << 5) - hash); }
        return eventColors[Math.abs(hash) % eventColors.length];
    }

    let calendar;
    let detailModal;

    function openLoginModal() {
        const loginModal = document.getElementById('loginModal');
        if (loginModal) loginModal.removeAttribute('hidden');
        else location.href = '/login';
    }

    // [ì¶”ê°€] ì»¤ìŠ¤í…€ Confirm í•¨ìˆ˜
    function openConfirm(message) {
        return new Promise((resolve) => {
            const modal = document.getElementById('customConfirmModal');
            const msgEl = document.getElementById('confirmMessage');
            const btnOk = document.getElementById('btnConfirmOk');
            const btnCancel = document.getElementById('btnConfirmCancel');

            msgEl.textContent = message;
            modal.classList.remove('hidden');

            const handleOk = () => {
                modal.classList.add('hidden');
                cleanup();
                resolve(true);
            };
            const handleCancel = () => {
                modal.classList.add('hidden');
                cleanup();
                resolve(false);
            };

            function cleanup() {
                btnOk.removeEventListener('click', handleOk);
                btnCancel.removeEventListener('click', handleCancel);
            }

            btnOk.onclick = handleOk;
            btnCancel.onclick = handleCancel;
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        detailModal = document.getElementById('scheduleDetailModal');

        const calendarEl = document.getElementById('calendar');
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth', locale: 'ko', height: 'auto', dayMaxEvents: true,
            headerToolbar: { left: 'prev,next today', center: 'title', right: '' }, // ë²„íŠ¼ ì—†ìŒ

            events: '/api/calendar/events', // í†µí•© ì¼ì • ì¡°íšŒ

            eventDidMount: function(info) {
                const color = getColorForEvent(info.event.id);
                info.el.style.backgroundColor = color;
                info.el.style.borderColor = color;
                info.el.style.color = '#222222';
                info.el.style.fontWeight = '700';
            },

            eventClick: function(info) {
                const clubId = info.event.extendedProps.clubId || null;
                const scheduleId = info.event.id;
                showScheduleDetailModal(scheduleId, clubId);
            }
        });
        calendar.render();
    });

    // --- ìƒì„¸ ëª¨ë‹¬ ---
    async function showScheduleDetailModal(scheduleId, clubId) {
        try {
            let url;
            if (clubId) url = `/api/club/${clubId}/schedule/${scheduleId}`;
            else url = `/api/calendar/events/${scheduleId}`;

            const response = await fetch(url, { credentials: 'include' });

            // [ìˆ˜ì •] ë¡œê·¸ì¸ ì²´í¬
            if (response.status === 401) {
                safeShowToast('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.', 'error');
                openLoginModal();
                return;
            }

            if (!response.ok) throw new Error('ì¼ì • ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            const dto = await response.json();

            document.getElementById('modal-title').textContent = dto.title;
            document.getElementById('modal-date').textContent = `${dto.start} ~ ${dto.end}`;
            document.getElementById('modal-fee').textContent = dto.fee || '-';
            document.getElementById('modal-details').textContent = dto.details ? dto.details : '(ë‚´ìš© ì—†ìŒ)';

            const clubArea = document.getElementById('club-event-area');
            const linkBtn = document.getElementById('modal-link-btn');

            if (clubId) {
                clubArea.classList.remove('hidden');
                linkBtn.classList.remove('hidden');
                linkBtn.onclick = () => location.href = `/clubs/${clubId}/calendar`;

                // ì°¸ê°€ì ëª©ë¡ í‘œì‹œ
                const list = document.getElementById('modal-participant-list');
                list.innerHTML = '';
                const participants = dto.participants || [];
                document.getElementById('modal-participant-count').textContent = participants.length;

                participants.forEach(p => {
                    const div = document.createElement('div');
                    div.className = 'participant-item';
                    // ì—¬ê¸°ì„œëŠ” ìƒíƒœ ë³€ê²½ ë²„íŠ¼ ì—†ì´ ë¦¬ìŠ¤íŠ¸ë§Œ ë³´ì—¬ì¤Œ (ë‹¨ìˆœ ì¡°íšŒ)
                    div.innerHTML = `<span>${p.nickname}</span> <span>${p.status === 'ACCEPTED' ? 'âœ…' : 'â³'}</span>`;
                    list.appendChild(div);
                });
            } else {
                clubArea.classList.add('hidden');
                linkBtn.classList.add('hidden');
            }

            // ì‚­ì œ ë²„íŠ¼ (ê´€ë¦¬ìë§Œ)
            const deleteBtn = document.getElementById('modal-delete-btn');
            if (dto.isManager) {
                deleteBtn.classList.remove('hidden');
                deleteBtn.onclick = () => handleDelete(scheduleId, clubId);
            } else {
                deleteBtn.classList.add('hidden');
            }

            detailModal.classList.remove('hidden');

        } catch (err) {
            console.error(err);
            safeShowToast('ì˜¤ë¥˜: ' + err.message, 'error');
        }
    }

    function hideDetailModal() { detailModal.classList.add('hidden'); }

    // [ìˆ˜ì •] ì‚­ì œ -> ì»¤ìŠ¤í…€ íŒì—… ì‚¬ìš©
    async function handleDelete(id, clubId) {
        if(await openConfirm('ì •ë§ë¡œ ì´ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            let url;
            if (clubId) url = `/api/club/${clubId}/schedule/${id}`;
            else url = `/api/calendar/events/${id}`;

            try {
                const opt = { method: 'DELETE', headers: { 'Content-Type': 'application/json' }, credentials: 'include' };
                const res = await fetch(url, opt);
                if(!res.ok) throw new Error('ì‚­ì œ ì‹¤íŒ¨');

                safeShowToast('ì¼ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                hideDetailModal();
                calendar.refetchEvents();
            } catch(e) {
                safeShowToast(e.message, 'error');
            }
        }
    }
</script>
</body>
</html>
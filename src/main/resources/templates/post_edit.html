<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>게시글 수정</title>
    <link rel="stylesheet" th:href="@{/css/app.css}">
</head>
<body class="bg-deep">

<header class="topbar" th:replace="~{fragments/common :: topbar}"></header>

<div class="wrap">
    <aside class="sidebar" th:replace="~{fragments/common :: sidebar}"></aside>

    <main class="content">
        <div class="detail-card">
            <div th:replace="~{fragments/common :: club-tabs}"></div>
        </div>

        <div class="detail-card" style="margin-top: 16px;">
            <h2 style="margin-bottom: 20px; font-size: 24px; color: var(--text-main);">게시글 수정</h2>

            <form th:action="@{/clubs/{clubId}/board/{postId}/edit(clubId=${clubId}, postId=${postId})}"
                  th:object="${postForm}"
                  method="post"
                  enctype="multipart/form-data">

                <div class="form-group" style="margin-bottom: 16px;">
                    <label for="title" style="display: block; margin-bottom: 8px; font-weight: bold; color: var(--text-main);">제목</label>
                    <input type="text"
                           id="title"
                           th:field="*{title}"
                           class="form-control"
                           placeholder="제목을 입력하세요">

                    <div class="error-message"
                         th:if="${#fields.hasErrors('title')}"
                         th:errors="*{title}"
                         style="color: var(--danger); font-size: 0.9em; margin-top: 4px;"></div>
                </div>

                <div class="form-group" style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold; color: var(--text-main);">사진 첨부</label>

                    <div th:if="${post != null and !post.images.isEmpty()}" style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px;">
                        <p style="margin: 0; font-size: 13px; color: var(--text-muted);">현재 등록된 사진 (체크하면 삭제됩니다)</p>

                        <div th:each="img : ${post.images}"
                             class="existing-image"
                             style="display: flex; align-items: center; gap: 15px; padding: 10px; border: 1px dashed var(--border); border-radius: 8px; background: var(--bg-body);">

                            <img th:src="${img.imageUrl}" alt="기존 이미지" style="width: 60px; height: 60px; object-fit: cover; border-radius: 6px;">

                            <label style="font-size: 14px; color: var(--danger); cursor: pointer; display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" name="deleteImageIds" th:value="${img.id}" style="width: 16px; height: 16px; accent-color: var(--danger);">
                                삭제하기
                            </label>
                        </div>
                    </div>

                    <div class="file-upload-wrapper">
                        <label for="imageFiles" class="filebtn">
                            <input type="file"
                                   id="imageFiles"
                                   th:field="*{imageFiles}"
                                   class="hidden-file-input"
                                   accept="image/*"
                                   multiple
                                   onchange="handleFileSelect(this)" hidden>
                            <span>사진 추가하기 (기존 포함 최대 10장)</span>
                        </label>

                        <div id="fileList" class="file-list"></div>
                        <p id="fileHelpText" class="muted" style="margin-top: 5px; font-size: 0.85rem; color: var(--text-muted);">추가된 파일 없음</p>
                    </div>
                    <p style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">사진을 추가하면 기존 사진 뒤에 붙습니다.</p>
                </div>

                <script>
                    const dataTransfer = new DataTransfer();

                    function handleFileSelect(input) {
                        const newFiles = Array.from(input.files);

                        const existingCount = document.querySelectorAll('.existing-image').length;

                        // 전체 개수 체크 (기존 + 현재 대기중 + 새로 선택)
                        const currentTotal = existingCount + dataTransfer.files.length + newFiles.length;

                        if (currentTotal > 10) {
                            showToast(`사진은 기존 사진 포함 최대 10장까지만 가능합니다. (현재: ${existingCount}장)`, true);
                            input.value = "";
                            return;
                        }

                        // 용량 체크
                        const maxSize = 10 * 1024 * 1024;
                        for (let file of newFiles) {
                            if (file.size > maxSize) {
                                showToast("파일 용량이 너무 큽니다. (최대 10MB)", true);
                                input.value = "";
                                return;
                            }
                        }

                        // 장바구니에 담기
                        newFiles.forEach(file => {
                            const exists = Array.from(dataTransfer.files).some(f => f.name === file.name && f.size === file.size);
                            if (!exists) {
                                dataTransfer.items.add(file);
                            }
                        });

                        document.getElementById('imageFiles').files = dataTransfer.files;
                        renderFileList();
                    }

                    function renderFileList() {
                        const fileListContainer = document.getElementById('fileList');
                        const helpText = document.getElementById('fileHelpText');

                        fileListContainer.innerHTML = "";

                        if (dataTransfer.files.length === 0) {
                            helpText.style.display = "block";
                            return;
                        } else {
                            helpText.style.display = "none";
                        }

                        Array.from(dataTransfer.files).forEach((file, index) => {
                            const chip = document.createElement('div');
                            chip.className = 'file-chip';
                            chip.innerHTML = `
                                <span>${file.name}</span>
                                <span class="remove-btn" onclick="removeFile(${index})">×</span>
                            `;
                            fileListContainer.appendChild(chip);
                        });
                    }

                    function removeFile(index) {
                        const dt = new DataTransfer();
                        const currentFiles = dataTransfer.files;

                        for (let i = 0; i < currentFiles.length; i++) {
                            if (i !== index) dt.items.add(currentFiles[i]);
                        }

                        dataTransfer.items.clear();
                        for (let i = 0; i < dt.files.length; i++) {
                            dataTransfer.items.add(dt.files[i]);
                        }

                        document.getElementById('imageFiles').files = dataTransfer.files;
                        renderFileList();
                    }
                </script>

                <div class="form-group" style="margin-bottom: 16px;">
                    <label for="content" style="display: block; margin-bottom: 8px; font-weight: bold; color: var(--text-main);">내용</label>

                    <textarea id="content"
                              th:field="*{content}"
                              rows="10"
                              maxlength="1000"
                              class="form-control"
                              style="resize: none;"
                              placeholder="내용을 입력하세요 (최대 1000자)"></textarea>

                    <div class="error-message"
                         th:if="${#fields.hasErrors('content')}"
                         th:errors="*{content}"
                         style="color: var(--danger); font-size: 0.9em; margin-top: 4px;"></div>
                </div>

                <div style="display: flex; justify-content: flex-end; gap: 8px;">
                    <a th:href="@{/clubs/{clubId}/board/{postId}(clubId=${clubId}, postId=${postId})}"
                       class="btn">
                        취소
                    </a>
                    <button type="submit" class="btn primary">수정 완료</button>
                </div>
            </form>
        </div>
    </main>
</div>

<div th:replace="~{fragments/common :: modals}"></div>
<div th:replace="~{fragments/common :: scripts}"></div>

</body>
</html>
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>새 게시글 작성</title>
    <link rel="stylesheet" th:href="@{/css/app.css}">
</head>
<body class="bg-deep">

<header class="topbar" th:replace="~{fragments/common :: topbar}"></header>

<div class="wrap">
    <aside class="sidebar" th:replace="~{fragments/common :: sidebar}"></aside>

    <main class="content">
        <div class="detail-card">
            <div th:replace="~{fragments/common :: club-tabs}"></div>
        </div>

        <div class="detail-card" style="margin-top: 16px;">
            <h2 style="margin-bottom: 20px; font-size: 24px; color: var(--text-main);">새 게시글 작성</h2>

            <form th:action="@{/clubs/{clubId}/board/new(clubId=${clubId})}"
                  th:object="${postForm}"
                  method="post"
                  enctype="multipart/form-data">

                <div class="form-group" style="margin-bottom: 16px;">
                    <label for="title" style="display: block; margin-bottom: 8px; font-weight: bold; color: var(--text-main);">제목</label>
                    <input type="text" id="title" th:field="*{title}" class="form-control" placeholder="제목을 입력하세요">
                    <div class="error-message" th:if="${#fields.hasErrors('title')}" th:errors="*{title}" style="color: var(--danger); font-size: 0.9em; margin-top: 4px;"></div>
                </div>

                <div class="form-group" style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold; color: var(--text-main);">사진 첨부</label>

                    <div class="file-upload-wrapper">
                        <label for="imageFiles" class="filebtn">
                            <input type="file"
                                   id="imageFiles"
                                   th:field="*{imageFiles}"
                                   class="hidden-file-input"
                                   accept="image/*"
                                   multiple
                                   onchange="handleFileSelect(this)" hidden>
                            <span>사진 추가하기 (최대 10장)</span>
                        </label>

                        <div id="fileList" class="file-list"></div>
                        <p id="fileHelpText" class="muted" style="margin-top: 5px; font-size: 0.85rem; color: var(--text-muted);">선택된 파일 없음</p>
                    </div>
                </div>

                <script>
                    // 파일들을 담아둘 '가상의 장바구니' (전역 변수)
                    const dataTransfer = new DataTransfer();

                    function handleFileSelect(input) {
                        const newFiles = Array.from(input.files);

                        // 개수 체크 (기존 파일 + 새 파일)
                        if (dataTransfer.files.length + newFiles.length > 10) {
                            showToast("사진은 최대 10장까지만 선택할 수 있습니다.", true);
                            input.value = ""; // 입력창 초기화 (장바구니는 유지)
                            return;
                        }

                        // 용량 체크 (10MB)
                        const maxSize = 10 * 1024 * 1024;
                        for (let file of newFiles) {
                            if (file.size > maxSize) {
                                showToast("파일 용량이 너무 큽니다. (최대 10MB)", true);
                                input.value = "";
                                return;
                            }
                        }

                        // 장바구니(dataTransfer)에 새 파일 담기
                        newFiles.forEach(file => {
                            const exists = Array.from(dataTransfer.files).some(f => f.name === file.name && f.size === file.size);
                            if (!exists) {
                                dataTransfer.items.add(file);
                            }
                        });

                        // input 태그의 파일 목록을 '장바구니' 내용으로 교체
                        document.getElementById('imageFiles').files = dataTransfer.files;
                        renderFileList();
                    }

                    function renderFileList() {
                        const fileListContainer = document.getElementById('fileList');
                        const helpText = document.getElementById('fileHelpText');

                        fileListContainer.innerHTML = ""; // 화면 초기화

                        if (dataTransfer.files.length === 0) {
                            helpText.style.display = "block";
                            return;
                        } else {
                            helpText.style.display = "none";
                        }

                        // 장바구니에 있는 파일들을 하나씩 화면에 그리기
                        Array.from(dataTransfer.files).forEach((file, index) => {
                            const chip = document.createElement('div');
                            chip.className = 'file-chip'; // app.css에 추가한 클래스

                            chip.innerHTML = `
                                <span>${file.name}</span>
                                <span class="remove-btn" onclick="removeFile(${index})">×</span>
                            `;

                            fileListContainer.appendChild(chip);
                        });
                    }

                    function removeFile(index) {
                        const dt = new DataTransfer();
                        const currentFiles = dataTransfer.files;

                        // 삭제하려는 인덱스만 빼고 나머지를 새 통에 담음
                        for (let i = 0; i < currentFiles.length; i++) {
                            if (i !== index) {
                                dt.items.add(currentFiles[i]);
                            }
                        }

                        // 전역 장바구니 업데이트
                        dataTransfer.items.clear();
                        for (let i = 0; i < dt.files.length; i++) {
                            dataTransfer.items.add(dt.files[i]);
                        }

                        // input 태그 업데이트
                        document.getElementById('imageFiles').files = dataTransfer.files;

                        // 화면 다시 그리기
                        renderFileList();
                    }
                </script>

                <div class="form-group" style="margin-bottom: 16px;">
                    <label for="content" style="display: block; margin-bottom: 8px; font-weight: bold; color: var(--text-main);">내용</label>
                    <textarea id="content" th:field="*{content}" rows="10" maxlength="1000" class="form-control" style="resize: none;" placeholder="내용을 입력하세요 (최대 1000자)"></textarea>
                    <div class="error-message" th:if="${#fields.hasErrors('content')}" th:errors="*{content}" style="color: var(--danger); font-size: 0.9em; margin-top: 4px;"></div>
                </div>

                <div style="display: flex; justify-content: flex-end; gap: 8px;">
                    <a th:href="@{/clubs/{clubId}/board(clubId=${clubId})}" class="btn">취소</a>
                    <button type="submit" class="btn primary">등록 완료</button>
                </div>
            </form>
        </div>
    </main>
</div>

<div th:replace="~{fragments/common :: modals}"></div>
<div th:replace="~{fragments/common :: scripts}"></div>

</body>
</html>